<center><a href="cuspvecimpl.h">Actual source code: cuspvecimpl.h</a></center><br>

<html>
<head>
<title></title>
<meta name="generator" content="c2html 0.9.5">
<meta name="date" content="2011-10-29T18:55:37+00:00">
</head>

<body bgcolor="#FFFFFF">
<pre width="80"><a name="line1">  1: </a><font color="#A020F0">#ifndef __CUSPVECIMPL</font>

<a name="line4">  4: </a><font color="#A020F0">#include &lt;private/vecimpl.h&gt;</font>
<a name="line5">  5: </a><font color="#A020F0">#include &lt;cublas.h&gt;</font>
<a name="line6">  6: </a><font color="#A020F0">#include &lt;cusp/blas.h&gt;</font>
<a name="line7">  7: </a><font color="#A020F0">#include &lt;thrust/device_vector.h&gt;</font>
<a name="line8">  8: </a><font color="#A020F0">#include &lt;thrust/iterator/constant_iterator.h&gt;</font>
<a name="line9">  9: </a><font color="#A020F0">#include &lt;thrust/transform.h&gt;</font>
<a name="line10"> 10: </a><font color="#A020F0">#include &lt;thrust/iterator/permutation_iterator.h&gt;</font>

<a name="line12"> 12: </a><strong><font color="#228B22">#define CUSPARRAY cusp::array1d&lt;<A href="../../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>,cusp::device_memory&gt;</font></strong>
<a name="line13"> 13: </a><strong><font color="#228B22">#define CUSPINTARRAYGPU cusp::array1d&lt;<A href="../../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>,cusp::device_memory&gt;</font></strong>
<a name="line14"> 14: </a><strong><font color="#228B22">#define CUSPINTARRAYCPU cusp::array1d&lt;<A href="../../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>,cusp::host_memory&gt;</font></strong>



<a name="line49"> 49: </a><strong><font color="#228B22">#define CHKERRCUSP(err) if (((int)err) != (int)CUBLAS_STATUS_SUCCESS) <A href="../../../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</A>(<A href="../../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_LIB,</font><font color="#666666">"CUSP error %d"</font><font color="#228B22">,err)</font></strong>

<a name="line51"> 51: </a><strong><font color="#228B22">#define VecCUSPCastToRawPtr(x) thrust::raw_pointer_cast(&amp;(x)[0])</font></strong>

<a name="line53"> 53: </a><strong><font color="#228B22">#define WaitForGPU() synchronizeCUSP ? cudaThreadSynchronize() : 0</font></strong>

<a name="line55"> 55: </a><font color="#4169E1"><a name="Vec_CUSP"></a>struct Vec_CUSP </font>{
<a name="line56"> 56: </a>  <font color="#B22222">/* eventually we should probably move the GPU flag into here */</font>
<a name="line57"> 57: </a>  CUSPARRAY*       GPUarray;  <font color="#B22222">/* this always holds the GPU data */</font>
<a name="line58"> 58: </a>};

<a name="line62"> 62: </a><strong><font color="#4169E1"><a name="VecCUSPAllocateCheck"></a>PETSC_STATIC_INLINE <A href="../../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> VecCUSPAllocateCheck(<A href="../../../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> v)</font></strong>
<a name="line63"> 63: </a>{
<a name="line65"> 65: </a>  Vec_Seq        *s = (Vec_Seq*)v-&gt;data;;

<a name="line68"> 68: </a>  <font color="#4169E1">if</font> (v-&gt;valid_GPU_array == PETSC_CUSP_UNALLOCATED){
<a name="line69"> 69: </a>    try {
<a name="line70"> 70: </a>      v-&gt;spptr = new Vec_CUSP;
<a name="line71"> 71: </a>      ((Vec_CUSP*)v-&gt;spptr)-&gt;GPUarray = new CUSPARRAY;
<a name="line72"> 72: </a>      ((Vec_CUSP*)v-&gt;spptr)-&gt;GPUarray-&gt;resize((<A href="../../../../../../docs/manualpages/Sys/PetscBLASInt.html#PetscBLASInt">PetscBLASInt</A>)v-&gt;map-&gt;n);
<a name="line73"> 73: </a>      WaitForGPU();
<a name="line74"> 74: </a>    } catch(char* ex) {
<a name="line75"> 75: </a>      <A href="../../../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</A>(<A href="../../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_LIB,<font color="#666666">"CUSP error: %s"</font>, ex);
<a name="line76"> 76: </a>    }
<a name="line77"> 77: </a>    <font color="#4169E1">if</font> (s-&gt;array == 0){
<a name="line78"> 78: </a>      v-&gt;valid_GPU_array = PETSC_CUSP_GPU;
<a name="line79"> 79: </a>    } <font color="#4169E1">else</font>{
<a name="line80"> 80: </a>      v-&gt;valid_GPU_array = PETSC_CUSP_CPU;
<a name="line81"> 81: </a>    }
<a name="line82"> 82: </a>  }
<a name="line83"> 83: </a>  <font color="#4169E1">return</font>(0);
<a name="line84"> 84: </a>}


<a name="line89"> 89: </a><font color="#B22222">/* Copies a vector from the CPU to the GPU unless we already have an up-to-date copy on the GPU */</font>
<a name="line90"> 90: </a><strong><font color="#4169E1"><a name="VecCUSPCopyToGPU"></a>PETSC_STATIC_INLINE <A href="../../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> VecCUSPCopyToGPU(<A href="../../../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> v)</font></strong>
<a name="line91"> 91: </a>{
<a name="line92"> 92: </a>  <A href="../../../../../../docs/manualpages/Sys/PetscBLASInt.html#PetscBLASInt">PetscBLASInt</A>   cn = v-&gt;map-&gt;n;

<a name="line96"> 96: </a>  VecCUSPAllocateCheck(v);
<a name="line97"> 97: </a>  <font color="#4169E1">if</font> (v-&gt;valid_GPU_array == PETSC_CUSP_CPU){
<a name="line98"> 98: </a>    <A href="../../../../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</A>(VEC_CUSPCopyToGPU,v,0,0,0);
<a name="line99"> 99: </a>    try{
<a name="line100">100: </a>      ((Vec_CUSP*)v-&gt;spptr)-&gt;GPUarray-&gt;assign(*(<A href="../../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>**)v-&gt;data,*(<A href="../../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>**)v-&gt;data + cn);
<a name="line101">101: </a>      WaitForGPU();
<a name="line102">102: </a>    } catch(char* ex) {
<a name="line103">103: </a>      <A href="../../../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</A>(<A href="../../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_LIB,<font color="#666666">"CUSP error: %s"</font>, ex);
<a name="line104">104: </a>    }
<a name="line105">105: </a>    <A href="../../../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</A>(VEC_CUSPCopyToGPU,v,0,0,0);
<a name="line106">106: </a>    v-&gt;valid_GPU_array = PETSC_CUSP_BOTH;
<a name="line107">107: </a>  }
<a name="line108">108: </a>  <font color="#4169E1">return</font>(0);
<a name="line109">109: </a>}

<a name="line113">113: </a><strong><font color="#4169E1"><a name="VecCUSPCopyToGPUSome"></a>PETSC_STATIC_INLINE <A href="../../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> VecCUSPCopyToGPUSome(<A href="../../../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> v,CUSPINTARRAYCPU *indicesCPU,CUSPINTARRAYGPU *indicesGPU)</font></strong>
<a name="line114">114: </a>{
<a name="line115">115: </a>  Vec_Seq        *s = (Vec_Seq *)v-&gt;data;

<a name="line119">119: </a>  VecCUSPAllocateCheck(v);
<a name="line120">120: </a>  <font color="#4169E1">if</font> (v-&gt;valid_GPU_array == PETSC_CUSP_CPU) {
<a name="line121">121: </a>    <A href="../../../../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</A>(VEC_CUSPCopyToGPUSome,v,0,0,0);
<a name="line122">122: </a><strong><font color="#FF0000">    thrust:</font></strong>:copy(thrust::make_permutation_iterator(s-&gt;array,indicesCPU-&gt;begin()),
<a name="line123">123: </a><strong><font color="#FF0000">                 thrust:</font></strong>:make_permutation_iterator(s-&gt;array,indicesCPU-&gt;end()),
<a name="line124">124: </a><strong><font color="#FF0000">                 thrust:</font></strong>:make_permutation_iterator(((Vec_CUSP *)v-&gt;spptr)-&gt;GPUarray-&gt;begin(),indicesGPU-&gt;begin()));
<a name="line125">125: </a>    <A href="../../../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</A>(VEC_CUSPCopyToGPUSome,v,0,0,0);
<a name="line126">126: </a>  }
<a name="line127">127: </a>  v-&gt;valid_GPU_array = PETSC_CUSP_GPU;
<a name="line128">128: </a>  <font color="#4169E1">return</font>(0);
<a name="line129">129: </a>}

<a name="line133">133: </a><strong><font color="#4169E1"><a name="VecCUSPGetArrayReadWrite"></a>PETSC_STATIC_INLINE <A href="../../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> VecCUSPGetArrayReadWrite(<A href="../../../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> v, CUSPARRAY** a)</font></strong>
<a name="line134">134: </a>{

<a name="line138">138: </a>  *a   = 0;
<a name="line139">139: </a>  VecCUSPCopyToGPU(v);
<a name="line140">140: </a>  *a   = ((Vec_CUSP *)v-&gt;spptr)-&gt;GPUarray;
<a name="line141">141: </a>  <font color="#4169E1">return</font>(0);
<a name="line142">142: </a>}

<a name="line146">146: </a><strong><font color="#4169E1"><a name="VecCUSPRestoreArrayReadWrite"></a>PETSC_STATIC_INLINE <A href="../../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> VecCUSPRestoreArrayReadWrite(<A href="../../../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> v, CUSPARRAY** a)</font></strong>
<a name="line147">147: </a>{

<a name="line151">151: </a>  <font color="#4169E1">if</font> (v-&gt;valid_GPU_array != PETSC_CUSP_UNALLOCATED){
<a name="line152">152: </a>    v-&gt;valid_GPU_array = PETSC_CUSP_GPU;
<a name="line153">153: </a>  }
<a name="line154">154: </a>  <A href="../../../../../../docs/manualpages/Sys/PetscObjectStateIncrease.html#PetscObjectStateIncrease">PetscObjectStateIncrease</A>((<A href="../../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)v);
<a name="line155">155: </a>  <font color="#4169E1">return</font>(0);
<a name="line156">156: </a>}

<a name="line160">160: </a><strong><font color="#4169E1"><a name="VecCUSPGetArrayRead"></a>PETSC_STATIC_INLINE <A href="../../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> VecCUSPGetArrayRead(<A href="../../../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> v, CUSPARRAY** a)</font></strong>
<a name="line161">161: </a>{

<a name="line165">165: </a>  *a   = 0;
<a name="line166">166: </a>  VecCUSPCopyToGPU(v);
<a name="line167">167: </a>  *a   = ((Vec_CUSP *)v-&gt;spptr)-&gt;GPUarray;
<a name="line168">168: </a>  <font color="#4169E1">return</font>(0);
<a name="line169">169: </a>}

<a name="line173">173: </a><strong><font color="#4169E1"><a name="VecCUSPRestoreArrayRead"></a>PETSC_STATIC_INLINE <A href="../../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> VecCUSPRestoreArrayRead(<A href="../../../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> v, CUSPARRAY** a)</font></strong>
<a name="line174">174: </a>{
<a name="line176">176: </a>  <font color="#4169E1">return</font>(0);
<a name="line177">177: </a>}

<a name="line181">181: </a><strong><font color="#4169E1"><a name="VecCUSPGetArrayWrite"></a>PETSC_STATIC_INLINE <A href="../../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> VecCUSPGetArrayWrite(<A href="../../../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> v, CUSPARRAY** a)</font></strong>
<a name="line182">182: </a>{

<a name="line186">186: </a>  *a   = 0;
<a name="line187">187: </a>  VecCUSPAllocateCheck(v);
<a name="line188">188: </a>  *a   = ((Vec_CUSP *)v-&gt;spptr)-&gt;GPUarray;
<a name="line189">189: </a>  <font color="#4169E1">return</font>(0);
<a name="line190">190: </a>}

<a name="line194">194: </a><strong><font color="#4169E1"><a name="VecCUSPRestoreArrayWrite"></a>PETSC_STATIC_INLINE <A href="../../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> VecCUSPRestoreArrayWrite(<A href="../../../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> v, CUSPARRAY** a)</font></strong>
<a name="line195">195: </a>{

<a name="line199">199: </a>  <font color="#4169E1">if</font> (v-&gt;valid_GPU_array != PETSC_CUSP_UNALLOCATED){
<a name="line200">200: </a>    v-&gt;valid_GPU_array = PETSC_CUSP_GPU;
<a name="line201">201: </a>  }
<a name="line202">202: </a>  <A href="../../../../../../docs/manualpages/Sys/PetscObjectStateIncrease.html#PetscObjectStateIncrease">PetscObjectStateIncrease</A>((<A href="../../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)v);
<a name="line203">203: </a>  <font color="#4169E1">return</font>(0);
<a name="line204">204: </a>}
<a name="line205">205: </a><font color="#A020F0">#endif</font>
</pre>
</body>

</html>
