<center><a href="vi.c">Actual source code: vi.c</a></center><br>

<html>
<head>
<title></title>
<meta name="generator" content="c2html 0.9.5">
<meta name="date" content="2011-10-29T19:15:13+00:00">
</head>

<body bgcolor="#FFFFFF">
<pre width="80">
<a name="line2">  2: </a><font color="#A020F0">#include &lt;../src/snes/impls/vi/viimpl.h&gt; </font><font color="#B22222">/*I "petscsnes.h" I*/</font><font color="#A020F0"></font>
<a name="line3">  3: </a><font color="#A020F0">#include &lt;../include/private/kspimpl.h&gt;</font>
<a name="line4">  4: </a><font color="#A020F0">#include &lt;../include/private/matimpl.h&gt;</font>
<a name="line5">  5: </a><font color="#A020F0">#include &lt;../include/private/dmimpl.h&gt;</font>

<a name="line9">  9: </a><font color="#B22222">/*@C</font>
<a name="line10"> 10: </a><font color="#B22222">   <A href="../../../../docs/manualpages/SNES/SNESVISetComputeVariableBounds.html#SNESVISetComputeVariableBounds">SNESVISetComputeVariableBounds</A> - Sets a function  that is called to compute the variable bounds</font>

<a name="line12"> 12: </a><font color="#B22222">   Input parameter</font>
<a name="line13"> 13: </a><font color="#B22222">+  snes - the <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> context</font>
<a name="line14"> 14: </a><font color="#B22222">-  compute - computes the bounds</font>

<a name="line16"> 16: </a><font color="#B22222">   Level: advanced</font>

<a name="line18"> 18: </a><font color="#B22222">@*/</font>
<a name="line19"> 19: </a><strong><font color="#4169E1"><a name="SNESVISetComputeVariableBounds"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> <A href="../../../../docs/manualpages/SNES/SNESVISetComputeVariableBounds.html#SNESVISetComputeVariableBounds">SNESVISetComputeVariableBounds</A>(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes, <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> (*compute)(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A>,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>))</font></strong>
<a name="line20"> 20: </a>{
<a name="line21"> 21: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>   ierr;
<a name="line22"> 22: </a>  SNES_VI          *vi;

<a name="line25"> 25: </a>  <A href="../../../../docs/manualpages/SNES/SNESSetType.html#SNESSetType">SNESSetType</A>(snes,<A href="../../../../docs/manualpages/SNES/SNESVI.html#SNESVI">SNESVI</A>);
<a name="line26"> 26: </a>  vi = (SNES_VI*)snes-&gt;data;
<a name="line27"> 27: </a>  vi-&gt;computevariablebounds = compute;
<a name="line28"> 28: </a>  <font color="#4169E1">return</font>(0);
<a name="line29"> 29: </a>}
<a name="line30"> 30: </a>

<a name="line34"> 34: </a><font color="#B22222">/*</font>
<a name="line35"> 35: </a><font color="#B22222">   SNESVIComputeInactiveSetIS - Gets the global indices for the bogus inactive set variables</font>

<a name="line37"> 37: </a><font color="#B22222">   Input parameter</font>
<a name="line38"> 38: </a><font color="#B22222">.  snes - the <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> context</font>
<a name="line39"> 39: </a><font color="#B22222">.  X    - the snes solution vector</font>

<a name="line41"> 41: </a><font color="#B22222">   Output parameter</font>
<a name="line42"> 42: </a><font color="#B22222">.  ISact - active set index set</font>

<a name="line44"> 44: </a><font color="#B22222"> */</font>
<a name="line45"> 45: </a><strong><font color="#4169E1"><a name="SNESVIComputeInactiveSetIS"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVIComputeInactiveSetIS(<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> upper,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> lower,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> X,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> F,<A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>* inact)</font></strong>
<a name="line46"> 46: </a>{
<a name="line47"> 47: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>   ierr;
<a name="line48"> 48: </a>  const <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> *x,*xl,*xu,*f;
<a name="line49"> 49: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>          *idx_act,i,nlocal,nloc_isact=0,ilow,ihigh,i1=0;
<a name="line50"> 50: </a>
<a name="line52"> 52: </a>  <A href="../../../../docs/manualpages/Vec/VecGetLocalSize.html#VecGetLocalSize">VecGetLocalSize</A>(X,&amp;nlocal);
<a name="line53"> 53: </a>  <A href="../../../../docs/manualpages/Vec/VecGetOwnershipRange.html#VecGetOwnershipRange">VecGetOwnershipRange</A>(X,&amp;ilow,&amp;ihigh);
<a name="line54"> 54: </a>  VecGetArrayRead(X,&amp;x);
<a name="line55"> 55: </a>  VecGetArrayRead(lower,&amp;xl);
<a name="line56"> 56: </a>  VecGetArrayRead(upper,&amp;xu);
<a name="line57"> 57: </a>  VecGetArrayRead(F,&amp;f);
<a name="line58"> 58: </a>  <font color="#B22222">/* Compute inactive set size */</font>
<a name="line59"> 59: </a>  <font color="#4169E1">for</font> (i=0; i &lt; nlocal;i++) {
<a name="line60"> 60: </a>    <font color="#4169E1">if</font> (((PetscRealPart(x[i]) &gt; PetscRealPart(xl[i]) + 1.e-8 || (PetscRealPart(f[i]) &lt; 0.0)) &amp;&amp; ((PetscRealPart(x[i]) &lt; PetscRealPart(xu[i]) - 1.e-8) || PetscRealPart(f[i]) &gt; 0.0))) nloc_isact++;
<a name="line61"> 61: </a>  }

<a name="line63"> 63: </a>  <A href="../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>(nloc_isact*<font color="#4169E1">sizeof</font>(<A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>),&amp;idx_act);

<a name="line65"> 65: </a>  <font color="#B22222">/* Set inactive set indices */</font>
<a name="line66"> 66: </a>  <font color="#4169E1">for</font>(i=0; i &lt; nlocal; i++) {
<a name="line67"> 67: </a>    <font color="#4169E1">if</font> (((PetscRealPart(x[i]) &gt; PetscRealPart(xl[i]) + 1.e-8 || (PetscRealPart(f[i]) &lt; 0.0)) &amp;&amp; ((PetscRealPart(x[i]) &lt; PetscRealPart(xu[i]) - 1.e-8) || PetscRealPart(f[i]) &gt; 0.0))) idx_act[i1++] = ilow+i;
<a name="line68"> 68: </a>  }

<a name="line70"> 70: </a>   <font color="#B22222">/* Create inactive set <A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A> */</font>
<a name="line71"> 71: </a>  <A href="../../../../docs/manualpages/IS/ISCreateGeneral.html#ISCreateGeneral">ISCreateGeneral</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)upper)-&gt;comm,nloc_isact,idx_act,PETSC_OWN_POINTER,inact);

<a name="line73"> 73: </a>  VecRestoreArrayRead(X,&amp;x);
<a name="line74"> 74: </a>  VecRestoreArrayRead(lower,&amp;xl);
<a name="line75"> 75: </a>  VecRestoreArrayRead(upper,&amp;xu);
<a name="line76"> 76: </a>  VecRestoreArrayRead(F,&amp;f);
<a name="line77"> 77: </a>  <font color="#4169E1">return</font>(0);
<a name="line78"> 78: </a>}

<a name="line80"> 80: </a><font color="#B22222">/*</font>
<a name="line81"> 81: </a><font color="#B22222">    Provides a wrapper to a DM to allow it to be used to generated the interpolation/restriction from the DM for the smaller matrices and vectors </font>
<a name="line82"> 82: </a><font color="#B22222">  defined by the reduced space method. </font>

<a name="line84"> 84: </a><font color="#B22222">    Simple calls the regular DM interpolation and restricts it to operation on the variables not associated with active constraints.</font>

<a name="line86"> 86: </a><font color="#B22222">&lt;*/</font>
<a name="line87"> 87: </a><font color="#4169E1">typedef</font> <font color="#4169E1">struct</font> {
<a name="line88"> 88: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       n;                                        <font color="#B22222">/* size of vectors in the reduced DM space */</font>
<a name="line89"> 89: </a>  <A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>             inactive;
<a name="line90"> 90: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> (*getinterpolation)(DM,DM,<A href="../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A>*,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>*);    <font color="#B22222">/* DM's original routines */</font>
<a name="line91"> 91: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> (*coarsen)(DM, <A href="../../../../docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</A>, DM*);
<a name="line92"> 92: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> (*createglobalvector)(DM,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>*);
<a name="line93"> 93: </a>  DM             dm;                                      <font color="#B22222">/* when destroying this object we need to reset the above function into the base DM */</font>
<a name="line94"> 94: </a>} DM_SNESVI;

<a name="line98"> 98: </a><font color="#B22222">/*</font>
<a name="line99"> 99: </a><font color="#B22222">     DMCreateGlobalVector_SNESVI - Creates global vector of the size of the reduced space</font>

<a name="line101">101: </a><font color="#B22222">*/</font>
<a name="line102">102: </a><strong><font color="#4169E1"><a name="DMCreateGlobalVector_SNESVI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>  DMCreateGlobalVector_SNESVI(DM dm,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> *vec)</font></strong>
<a name="line103">103: </a>{
<a name="line104">104: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>          ierr;
<a name="line105">105: </a>  <A href="../../../../docs/manualpages/Sys/PetscContainer.html#PetscContainer">PetscContainer</A>          isnes;
<a name="line106">106: </a>  DM_SNESVI               *dmsnesvi;

<a name="line109">109: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectQuery.html#PetscObjectQuery">PetscObjectQuery</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)dm,<font color="#666666">"VI"</font>,(<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A> *)&amp;isnes);
<a name="line110">110: </a>  <font color="#4169E1">if</font> (!isnes) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)dm)-&gt;comm,PETSC_ERR_PLIB,<font color="#666666">"Composed <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> is missing"</font>);
<a name="line111">111: </a>  <A href="../../../../docs/manualpages/Sys/PetscContainerGetPointer.html#PetscContainerGetPointer">PetscContainerGetPointer</A>(isnes,(void**)&amp;dmsnesvi);
<a name="line112">112: </a>  <A href="../../../../docs/manualpages/Vec/VecCreateMPI.html#VecCreateMPI">VecCreateMPI</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)dm)-&gt;comm,dmsnesvi-&gt;n,<A href="../../../../docs/manualpages/Sys/PETSC_DETERMINE.html#PETSC_DETERMINE">PETSC_DETERMINE</A>,vec);
<a name="line113">113: </a>  <font color="#4169E1">return</font>(0);
<a name="line114">114: </a>}

<a name="line118">118: </a><font color="#B22222">/*</font>
<a name="line119">119: </a><font color="#B22222">     DMGetInterpolation_SNESVI - Modifieds the interpolation obtained from the DM by removing all rows and columns associated with active constraints.</font>

<a name="line121">121: </a><font color="#B22222">*/</font>
<a name="line122">122: </a><strong><font color="#4169E1"><a name="DMGetInterpolation_SNESVI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>  DMGetInterpolation_SNESVI(DM dm1,DM dm2,<A href="../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> *mat,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> *vec)</font></strong>
<a name="line123">123: </a>{
<a name="line124">124: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>          ierr;
<a name="line125">125: </a>  <A href="../../../../docs/manualpages/Sys/PetscContainer.html#PetscContainer">PetscContainer</A>          isnes;
<a name="line126">126: </a>  DM_SNESVI               *dmsnesvi1,*dmsnesvi2;
<a name="line127">127: </a>  <A href="../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A>                     interp;

<a name="line130">130: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectQuery.html#PetscObjectQuery">PetscObjectQuery</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)dm1,<font color="#666666">"VI"</font>,(<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A> *)&amp;isnes);
<a name="line131">131: </a>  <font color="#4169E1">if</font> (!isnes) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)dm1)-&gt;comm,PETSC_ERR_PLIB,<font color="#666666">"Composed VI data structure is missing"</font>);
<a name="line132">132: </a>  <A href="../../../../docs/manualpages/Sys/PetscContainerGetPointer.html#PetscContainerGetPointer">PetscContainerGetPointer</A>(isnes,(void**)&amp;dmsnesvi1);
<a name="line133">133: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectQuery.html#PetscObjectQuery">PetscObjectQuery</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)dm2,<font color="#666666">"VI"</font>,(<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A> *)&amp;isnes);
<a name="line134">134: </a>  <font color="#4169E1">if</font> (!isnes) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)dm2)-&gt;comm,PETSC_ERR_PLIB,<font color="#666666">"Composed VI data structure is missing"</font>);
<a name="line135">135: </a>  <A href="../../../../docs/manualpages/Sys/PetscContainerGetPointer.html#PetscContainerGetPointer">PetscContainerGetPointer</A>(isnes,(void**)&amp;dmsnesvi2);
<a name="line136">136: </a>
<a name="line137">137: </a>  (*dmsnesvi1-&gt;getinterpolation)(dm1,dm2,&amp;interp,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line138">138: </a>  <A href="../../../../docs/manualpages/Mat/MatGetSubMatrix.html#MatGetSubMatrix">MatGetSubMatrix</A>(interp,dmsnesvi2-&gt;inactive,dmsnesvi1-&gt;inactive,MAT_INITIAL_MATRIX,mat);
<a name="line139">139: </a>  <A href="../../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</A>(&amp;interp);
<a name="line140">140: </a>  *vec = 0;
<a name="line141">141: </a>  <font color="#4169E1">return</font>(0);
<a name="line142">142: </a>}


<a name="line148">148: </a><font color="#B22222">/*</font>
<a name="line149">149: </a><font color="#B22222">     DMCoarsen_SNESVI - Computes the regular coarsened DM then computes additional information about its inactive set</font>

<a name="line151">151: </a><font color="#B22222">*/</font>
<a name="line152">152: </a><strong><font color="#4169E1"><a name="DMCoarsen_SNESVI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>  DMCoarsen_SNESVI(DM dm1,<A href="../../../../docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</A> comm,DM *dm2)</font></strong>
<a name="line153">153: </a>{
<a name="line154">154: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>          ierr;
<a name="line155">155: </a>  <A href="../../../../docs/manualpages/Sys/PetscContainer.html#PetscContainer">PetscContainer</A>          isnes;
<a name="line156">156: </a>  DM_SNESVI               *dmsnesvi1;
<a name="line157">157: </a>  <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>                     finemarked,coarsemarked;
<a name="line158">158: </a>  <A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>                      inactive;
<a name="line159">159: </a>  <A href="../../../../docs/manualpages/Vec/VecScatter.html#VecScatter">VecScatter</A>              inject;
<a name="line160">160: </a>  const <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>          *index;
<a name="line161">161: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>                n,k,cnt = 0,rstart,*coarseindex;
<a name="line162">162: </a>  <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>             *marked;

<a name="line165">165: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectQuery.html#PetscObjectQuery">PetscObjectQuery</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)dm1,<font color="#666666">"VI"</font>,(<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A> *)&amp;isnes);
<a name="line166">166: </a>  <font color="#4169E1">if</font> (!isnes) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)dm1)-&gt;comm,PETSC_ERR_PLIB,<font color="#666666">"Composed VI data structure is missing"</font>);
<a name="line167">167: </a>  <A href="../../../../docs/manualpages/Sys/PetscContainerGetPointer.html#PetscContainerGetPointer">PetscContainerGetPointer</A>(isnes,(void**)&amp;dmsnesvi1);
<a name="line168">168: </a>
<a name="line169">169: </a>  <font color="#B22222">/* get the original coarsen */</font>
<a name="line170">170: </a>  (*dmsnesvi1-&gt;coarsen)(dm1,comm,dm2);

<a name="line172">172: </a>  <font color="#B22222">/* not sure why this extra reference is needed, but without the dm2 disappears too early */</font>
<a name="line173">173: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectReference.html#PetscObjectReference">PetscObjectReference</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)*dm2);

<a name="line175">175: </a>  <font color="#B22222">/* need to set back global vectors in order to use the original injection */</font>
<a name="line176">176: </a>  <A href="../../../../docs/manualpages/DM/DMClearGlobalVectors.html#DMClearGlobalVectors">DMClearGlobalVectors</A>(dm1);
<a name="line177">177: </a>  dm1-&gt;ops-&gt;createglobalvector = dmsnesvi1-&gt;createglobalvector;
<a name="line178">178: </a>  <A href="../../../../docs/manualpages/DM/DMCreateGlobalVector.html#DMCreateGlobalVector">DMCreateGlobalVector</A>(dm1,&amp;finemarked);
<a name="line179">179: </a>  <A href="../../../../docs/manualpages/DM/DMCreateGlobalVector.html#DMCreateGlobalVector">DMCreateGlobalVector</A>(*dm2,&amp;coarsemarked);

<a name="line181">181: </a>  <font color="#B22222">/*</font>
<a name="line182">182: </a><font color="#B22222">     fill finemarked with locations of inactive points</font>
<a name="line183">183: </a><font color="#B22222">  */</font>
<a name="line184">184: </a>  <A href="../../../../docs/manualpages/IS/ISGetIndices.html#ISGetIndices">ISGetIndices</A>(dmsnesvi1-&gt;inactive,&amp;index);
<a name="line185">185: </a>  <A href="../../../../docs/manualpages/IS/ISGetLocalSize.html#ISGetLocalSize">ISGetLocalSize</A>(dmsnesvi1-&gt;inactive,&amp;n);
<a name="line186">186: </a>  <A href="../../../../docs/manualpages/Vec/VecSet.html#VecSet">VecSet</A>(finemarked,0.0);
<a name="line187">187: </a>  <font color="#4169E1">for</font> (k=0;k&lt;n;k++){
<a name="line188">188: </a>      <A href="../../../../docs/manualpages/Vec/VecSetValue.html#VecSetValue">VecSetValue</A>(finemarked,index[k],1.0,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>);
<a name="line189">189: </a>  }
<a name="line190">190: </a>  <A href="../../../../docs/manualpages/Vec/VecAssemblyBegin.html#VecAssemblyBegin">VecAssemblyBegin</A>(finemarked);
<a name="line191">191: </a>  <A href="../../../../docs/manualpages/Vec/VecAssemblyEnd.html#VecAssemblyEnd">VecAssemblyEnd</A>(finemarked);

<a name="line193">193: </a>  <A href="../../../../docs/manualpages/DM/DMGetInjection.html#DMGetInjection">DMGetInjection</A>(*dm2,dm1,&amp;inject);
<a name="line194">194: </a>  <A href="../../../../docs/manualpages/Vec/VecScatterBegin.html#VecScatterBegin">VecScatterBegin</A>(inject,finemarked,coarsemarked,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>,<A href="../../../../docs/manualpages/Vec/SCATTER_FORWARD.html#SCATTER_FORWARD">SCATTER_FORWARD</A>);
<a name="line195">195: </a>  <A href="../../../../docs/manualpages/Vec/VecScatterEnd.html#VecScatterEnd">VecScatterEnd</A>(inject,finemarked,coarsemarked,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>,<A href="../../../../docs/manualpages/Vec/SCATTER_FORWARD.html#SCATTER_FORWARD">SCATTER_FORWARD</A>);
<a name="line196">196: </a>  <A href="../../../../docs/manualpages/Vec/VecScatterDestroy.html#VecScatterDestroy">VecScatterDestroy</A>(&amp;inject);

<a name="line198">198: </a>  <font color="#B22222">/*</font>
<a name="line199">199: </a><font color="#B22222">     create index set list of coarse inactive points from coarsemarked</font>
<a name="line200">200: </a><font color="#B22222">  */</font>
<a name="line201">201: </a>  <A href="../../../../docs/manualpages/Vec/VecGetLocalSize.html#VecGetLocalSize">VecGetLocalSize</A>(coarsemarked,&amp;n);
<a name="line202">202: </a>  <A href="../../../../docs/manualpages/Vec/VecGetOwnershipRange.html#VecGetOwnershipRange">VecGetOwnershipRange</A>(coarsemarked,&amp;rstart,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line203">203: </a>  <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(coarsemarked,&amp;marked);
<a name="line204">204: </a>  <font color="#4169E1">for</font> (k=0; k&lt;n; k++) {
<a name="line205">205: </a>    <font color="#4169E1">if</font> (marked[k] != 0.0) cnt++;
<a name="line206">206: </a>  }
<a name="line207">207: </a>  <A href="../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>(cnt*<font color="#4169E1">sizeof</font>(<A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>),&amp;coarseindex);
<a name="line208">208: </a>  cnt  = 0;
<a name="line209">209: </a>  <font color="#4169E1">for</font> (k=0; k&lt;n; k++) {
<a name="line210">210: </a>    <font color="#4169E1">if</font> (marked[k] != 0.0) coarseindex[cnt++] = k + rstart;
<a name="line211">211: </a>  }
<a name="line212">212: </a>  <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(coarsemarked,&amp;marked);
<a name="line213">213: </a>  <A href="../../../../docs/manualpages/IS/ISCreateGeneral.html#ISCreateGeneral">ISCreateGeneral</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</A>,cnt,coarseindex,PETSC_OWN_POINTER,&amp;inactive);

<a name="line215">215: </a>  <A href="../../../../docs/manualpages/DM/DMClearGlobalVectors.html#DMClearGlobalVectors">DMClearGlobalVectors</A>(dm1);
<a name="line216">216: </a>  dm1-&gt;ops-&gt;createglobalvector = DMCreateGlobalVector_SNESVI;
<a name="line217">217: </a>  DMSetVI(*dm2,inactive);

<a name="line219">219: </a>  <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;finemarked);
<a name="line220">220: </a>  <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;coarsemarked);
<a name="line221">221: </a>  <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;inactive);
<a name="line222">222: </a>  <font color="#4169E1">return</font>(0);
<a name="line223">223: </a>}

<a name="line227">227: </a><strong><font color="#4169E1"><a name="DMDestroy_SNESVI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> DMDestroy_SNESVI(DM_SNESVI *dmsnesvi)</font></strong>
<a name="line228">228: </a>{
<a name="line230">230: </a>
<a name="line232">232: </a>  <font color="#B22222">/* reset the base methods in the DM object that were changed when the DM_SNESVI was reset */</font>
<a name="line233">233: </a>  dmsnesvi-&gt;dm-&gt;ops-&gt;getinterpolation   = dmsnesvi-&gt;getinterpolation;
<a name="line234">234: </a>  dmsnesvi-&gt;dm-&gt;ops-&gt;coarsen            = dmsnesvi-&gt;coarsen;
<a name="line235">235: </a>  dmsnesvi-&gt;dm-&gt;ops-&gt;createglobalvector = dmsnesvi-&gt;createglobalvector;
<a name="line236">236: </a>  <font color="#B22222">/* need to clear out this vectors because some of them may not have a reference to the DM</font>
<a name="line237">237: </a><font color="#B22222">    but they are counted as having references to the DM in <A href="../../../../docs/manualpages/DM/DMDestroy.html#DMDestroy">DMDestroy</A>() */</font>
<a name="line238">238: </a>  <A href="../../../../docs/manualpages/DM/DMClearGlobalVectors.html#DMClearGlobalVectors">DMClearGlobalVectors</A>(dmsnesvi-&gt;dm);

<a name="line240">240: </a>  <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;dmsnesvi-&gt;inactive);
<a name="line241">241: </a>  <A href="../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(dmsnesvi);
<a name="line242">242: </a>  <font color="#4169E1">return</font>(0);
<a name="line243">243: </a>}

<a name="line247">247: </a><font color="#B22222">/*</font>
<a name="line248">248: </a><font color="#B22222">     DMSetVI - Marks a DM as associated with a VI problem. This causes the interpolation/restriction operators to </font>
<a name="line249">249: </a><font color="#B22222">               be restricted to only those variables NOT associated with active constraints.</font>

<a name="line251">251: </a><font color="#B22222">*/</font>
<a name="line252">252: </a><strong><font color="#4169E1"><a name="DMSetVI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>  DMSetVI(DM dm,<A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A> inactive)</font></strong>
<a name="line253">253: </a>{
<a name="line254">254: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>          ierr;
<a name="line255">255: </a>  <A href="../../../../docs/manualpages/Sys/PetscContainer.html#PetscContainer">PetscContainer</A>          isnes;
<a name="line256">256: </a>  DM_SNESVI               *dmsnesvi;

<a name="line259">259: </a>  <font color="#4169E1">if</font> (!dm) <font color="#4169E1">return</font>(0);

<a name="line261">261: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectReference.html#PetscObjectReference">PetscObjectReference</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)inactive);

<a name="line263">263: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectQuery.html#PetscObjectQuery">PetscObjectQuery</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)dm,<font color="#666666">"VI"</font>,(<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A> *)&amp;isnes);
<a name="line264">264: </a>  <font color="#4169E1">if</font> (!isnes) {
<a name="line265">265: </a>    <A href="../../../../docs/manualpages/Sys/PetscContainerCreate.html#PetscContainerCreate">PetscContainerCreate</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)dm)-&gt;comm,&amp;isnes);
<a name="line266">266: </a>    <A href="../../../../docs/manualpages/Sys/PetscContainerSetUserDestroy.html#PetscContainerSetUserDestroy">PetscContainerSetUserDestroy</A>(isnes,(<A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> (*)(void*))DMDestroy_SNESVI);
<a name="line267">267: </a>    <A href="../../../../docs/manualpages/Sys/PetscNew.html#PetscNew">PetscNew</A>(DM_SNESVI,&amp;dmsnesvi);
<a name="line268">268: </a>    <A href="../../../../docs/manualpages/Sys/PetscContainerSetPointer.html#PetscContainerSetPointer">PetscContainerSetPointer</A>(isnes,(void*)dmsnesvi);
<a name="line269">269: </a>    <A href="../../../../docs/manualpages/Sys/PetscObjectCompose.html#PetscObjectCompose">PetscObjectCompose</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)dm,<font color="#666666">"VI"</font>,(<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)isnes);
<a name="line270">270: </a>    <A href="../../../../docs/manualpages/Sys/PetscContainerDestroy.html#PetscContainerDestroy">PetscContainerDestroy</A>(&amp;isnes);
<a name="line271">271: </a>    dmsnesvi-&gt;getinterpolation   = dm-&gt;ops-&gt;getinterpolation;
<a name="line272">272: </a>    dm-&gt;ops-&gt;getinterpolation    = DMGetInterpolation_SNESVI;
<a name="line273">273: </a>    dmsnesvi-&gt;coarsen            = dm-&gt;ops-&gt;coarsen;
<a name="line274">274: </a>    dm-&gt;ops-&gt;coarsen             = DMCoarsen_SNESVI;
<a name="line275">275: </a>    dmsnesvi-&gt;createglobalvector = dm-&gt;ops-&gt;createglobalvector;
<a name="line276">276: </a>    dm-&gt;ops-&gt;createglobalvector  = DMCreateGlobalVector_SNESVI;
<a name="line277">277: </a>  } <font color="#4169E1">else</font> {
<a name="line278">278: </a>    <A href="../../../../docs/manualpages/Sys/PetscContainerGetPointer.html#PetscContainerGetPointer">PetscContainerGetPointer</A>(isnes,(void**)&amp;dmsnesvi);
<a name="line279">279: </a>    <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;dmsnesvi-&gt;inactive);
<a name="line280">280: </a>  }
<a name="line281">281: </a>  <A href="../../../../docs/manualpages/DM/DMClearGlobalVectors.html#DMClearGlobalVectors">DMClearGlobalVectors</A>(dm);
<a name="line282">282: </a>  <A href="../../../../docs/manualpages/IS/ISGetLocalSize.html#ISGetLocalSize">ISGetLocalSize</A>(inactive,&amp;dmsnesvi-&gt;n);
<a name="line283">283: </a>  dmsnesvi-&gt;inactive = inactive;
<a name="line284">284: </a>  dmsnesvi-&gt;dm       = dm;
<a name="line285">285: </a>  <font color="#4169E1">return</font>(0);
<a name="line286">286: </a>}

<a name="line290">290: </a><font color="#B22222">/*</font>
<a name="line291">291: </a><font color="#B22222">     DMDestroyVI - Frees the DM_SNESVI object contained in the DM </font>
<a name="line292">292: </a><font color="#B22222">         - also resets the function pointers in the DM for getinterpolation() etc to use the original DM </font>
<a name="line293">293: </a><font color="#B22222">*/</font>
<a name="line294">294: </a><strong><font color="#4169E1"><a name="DMDestroyVI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>  DMDestroyVI(DM dm)</font></strong>
<a name="line295">295: </a>{
<a name="line296">296: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>          ierr;

<a name="line299">299: </a>  <font color="#4169E1">if</font> (!dm) <font color="#4169E1">return</font>(0);
<a name="line300">300: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectCompose.html#PetscObjectCompose">PetscObjectCompose</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)dm,<font color="#666666">"VI"</font>,(<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line301">301: </a>  <font color="#4169E1">return</font>(0);
<a name="line302">302: </a>}

<a name="line304">304: </a><font color="#B22222">/* --------------------------------------------------------------------------------------------------------*/</font>

<a name="line308">308: </a><strong><font color="#4169E1"><a name="SNESMonitorVI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>  SNESMonitorVI(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A> its,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> fgnorm,void *dummy)</font></strong>
<a name="line309">309: </a>{
<a name="line310">310: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>    ierr;
<a name="line311">311: </a>  SNES_VI            *vi = (SNES_VI*)snes-&gt;data;
<a name="line312">312: </a>  <A href="../../../../docs/manualpages/Viewer/PetscViewer.html#PetscViewer">PetscViewer</A>        viewer = dummy ? (<A href="../../../../docs/manualpages/Viewer/PetscViewer.html#PetscViewer">PetscViewer</A>) dummy : <A href="../../../../docs/manualpages/Viewer/PETSC_VIEWER_STDOUT_.html#PETSC_VIEWER_STDOUT_">PETSC_VIEWER_STDOUT_</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm);
<a name="line313">313: </a>  const <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>  *x,*xl,*xu,*f;
<a name="line314">314: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>           i,n,act[2] = {0,0},fact[2],N;
<a name="line315">315: </a>  <font color="#B22222">/* remove later */</font>
<a name="line316">316: </a>  <font color="#B22222">/* Number of components that actually hit the bounds (c.f. active variables) */</font>
<a name="line317">317: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>           act_bound[2] = {0,0},fact_bound[2];
<a name="line318">318: </a>  <A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A>          rnorm,fnorm;

<a name="line321">321: </a>  <A href="../../../../docs/manualpages/Vec/VecGetLocalSize.html#VecGetLocalSize">VecGetLocalSize</A>(snes-&gt;vec_sol,&amp;n);
<a name="line322">322: </a>  <A href="../../../../docs/manualpages/Vec/VecGetSize.html#VecGetSize">VecGetSize</A>(snes-&gt;vec_sol,&amp;N);
<a name="line323">323: </a>  VecGetArrayRead(vi-&gt;xl,&amp;xl);
<a name="line324">324: </a>  VecGetArrayRead(vi-&gt;xu,&amp;xu);
<a name="line325">325: </a>  VecGetArrayRead(snes-&gt;vec_sol,&amp;x);
<a name="line326">326: </a>  VecGetArrayRead(snes-&gt;vec_func,&amp;f);
<a name="line327">327: </a>
<a name="line328">328: </a>  rnorm = 0.0;
<a name="line329">329: </a>  <font color="#4169E1">for</font> (i=0; i&lt;n; i++) {
<a name="line330">330: </a>    <font color="#4169E1">if</font> (((PetscRealPart(x[i]) &gt; PetscRealPart(xl[i]) + 1.e-8 || (PetscRealPart(f[i]) &lt; 0.0)) &amp;&amp; ((PetscRealPart(x[i]) &lt; PetscRealPart(xu[i]) - 1.e-8) || PetscRealPart(f[i]) &gt; 0.0))) rnorm += PetscRealPart(PetscConj(f[i])*f[i]);
<a name="line331">331: </a>    <font color="#4169E1">else</font> <font color="#4169E1">if</font> (PetscRealPart(x[i]) &lt;= PetscRealPart(xl[i]) + 1.e-8 &amp;&amp; PetscRealPart(f[i]) &gt;= 0.0) act[0]++;
<a name="line332">332: </a>    <font color="#4169E1">else</font> <font color="#4169E1">if</font> (PetscRealPart(x[i]) &gt;= PetscRealPart(xu[i]) - 1.e-8 &amp;&amp; PetscRealPart(f[i]) &lt;= 0.0) act[1]++;
<a name="line333">333: </a>    <font color="#4169E1">else</font> <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm,PETSC_ERR_PLIB,<font color="#666666">"Can never get here"</font>);
<a name="line334">334: </a>  }

<a name="line336">336: </a>  <font color="#B22222">/* Remove later, number of components that actually hit the bounds */</font>
<a name="line337">337: </a>  <font color="#4169E1">for</font> (i=0; i&lt;n; i++) {
<a name="line338">338: </a>    <font color="#4169E1">if</font> (PetscRealPart(x[i]) &lt;= PetscRealPart(xl[i]) + 1.e-8) act_bound[0]++;
<a name="line339">339: </a>    <font color="#4169E1">else</font> <font color="#4169E1">if</font> (PetscRealPart(x[i]) &gt;= PetscRealPart(xu[i]) - 1.e-8) act_bound[1]++;
<a name="line340">340: </a>  }
<a name="line341">341: </a>  VecRestoreArrayRead(snes-&gt;vec_func,&amp;f);
<a name="line342">342: </a>  VecRestoreArrayRead(vi-&gt;xl,&amp;xl);
<a name="line343">343: </a>  VecRestoreArrayRead(vi-&gt;xu,&amp;xu);
<a name="line344">344: </a>  VecRestoreArrayRead(snes-&gt;vec_sol,&amp;x);
<a name="line345">345: </a>  <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Allreduce.html#MPI_Allreduce">MPI_Allreduce</A>(&amp;rnorm,&amp;fnorm,1,MPIU_REAL,MPIU_SUM,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm);
<a name="line346">346: </a>  <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Allreduce.html#MPI_Allreduce">MPI_Allreduce</A>(act,fact,2,MPIU_INT,MPIU_SUM,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm);
<a name="line347">347: </a>  <font color="#B22222">/* remove later */</font>
<a name="line348">348: </a>  <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Allreduce.html#MPI_Allreduce">MPI_Allreduce</A>(act_bound,fact_bound,2,MPIU_INT,MPIU_SUM,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm);
<a name="line349">349: </a>  fnorm = PetscSqrtReal(fnorm);
<a name="line350">350: </a>
<a name="line351">351: </a>  <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIAddTab.html#PetscViewerASCIIAddTab">PetscViewerASCIIAddTab</A>(viewer,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line352">352: </a>  <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(viewer,<font color="#666666">"%3D <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> VI Function norm %14.12e Active lower constraints %D upper constraints %D Percent of total %g Percent of bounded %g\n"</font>,its,(double)fnorm,fact[0],fact[1],((double)(fact[0]+fact[1]))/((double)N),((double)(fact[0]+fact[1]))/((double)vi-&gt;ntruebounds));
<a name="line353">353: </a>  <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(viewer,<font color="#666666">"                               lower constraints satisfied %D upper constraints satisfied %D\n"</font>,its,fact_bound[0],fact_bound[1]);
<a name="line354">354: </a>
<a name="line355">355: </a>  <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIISubtractTab.html#PetscViewerASCIISubtractTab">PetscViewerASCIISubtractTab</A>(viewer,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line356">356: </a>  <font color="#4169E1">return</font>(0);
<a name="line357">357: </a>}

<a name="line359">359: </a><font color="#B22222">/*</font>
<a name="line360">360: </a><font color="#B22222">     Checks if J^T F = 0 which implies we've found a local minimum of the norm of the function,</font>
<a name="line361">361: </a><font color="#B22222">    || F(u) ||_2 but not a zero, F(u) = 0. In the case when one cannot compute J^T F we use the fact that</font>
<a name="line362">362: </a><font color="#B22222">    0 = (J^T F)^T W = F^T J W iff W not in the null space of J. Thanks for Jorge More </font>
<a name="line363">363: </a><font color="#B22222">    for this trick. One assumes that the probability that W is in the null space of J is very, very small.</font>
<a name="line364">364: </a><font color="#B22222">*/</font>
<a name="line367">367: </a><strong><font color="#4169E1"><a name="SNESVICheckLocalMin_Private"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVICheckLocalMin_Private(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> A,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> F,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> W,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> fnorm,<A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A> *ismin)</font></strong>
<a name="line368">368: </a>{
<a name="line369">369: </a>  <A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A>      a1;
<a name="line371">371: </a>  <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A>     hastranspose;

<a name="line374">374: </a>  *ismin = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;
<a name="line375">375: </a>  <A href="../../../../docs/manualpages/Mat/MatHasOperation.html#MatHasOperation">MatHasOperation</A>(A,MATOP_MULT_TRANSPOSE,&amp;hastranspose);
<a name="line376">376: </a>  <font color="#4169E1">if</font> (hastranspose) {
<a name="line377">377: </a>    <font color="#B22222">/* Compute || J^T F|| */</font>
<a name="line378">378: </a>    <A href="../../../../docs/manualpages/Mat/MatMultTranspose.html#MatMultTranspose">MatMultTranspose</A>(A,F,W);
<a name="line379">379: </a>    <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(W,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,&amp;a1);
<a name="line380">380: </a>    PetscInfo1(snes,<font color="#666666">"|| J^T F|| %G near zero implies found a local minimum\n"</font>,a1/fnorm);
<a name="line381">381: </a>    <font color="#4169E1">if</font> (a1/fnorm &lt; 1.e-4) *ismin = <A href="../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</A>;
<a name="line382">382: </a>  } <font color="#4169E1">else</font> {
<a name="line383">383: </a>    <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>         work;
<a name="line384">384: </a>    <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> result;
<a name="line385">385: </a>    <A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A>   wnorm;

<a name="line387">387: </a>    <A href="../../../../docs/manualpages/Vec/VecSetRandom.html#VecSetRandom">VecSetRandom</A>(W,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line388">388: </a>    <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(W,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,&amp;wnorm);
<a name="line389">389: </a>    <A href="../../../../docs/manualpages/Vec/VecDuplicate.html#VecDuplicate">VecDuplicate</A>(W,&amp;work);
<a name="line390">390: </a>    <A href="../../../../docs/manualpages/Mat/MatMult.html#MatMult">MatMult</A>(A,W,work);
<a name="line391">391: </a>    <A href="../../../../docs/manualpages/Vec/VecDot.html#VecDot">VecDot</A>(F,work,&amp;result);
<a name="line392">392: </a>    <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;work);
<a name="line393">393: </a>    a1   = PetscAbsScalar(result)/(fnorm*wnorm);
<a name="line394">394: </a>    PetscInfo1(snes,<font color="#666666">"(F^T J random)/(|| F ||*||random|| %G near zero implies found a local minimum\n"</font>,a1);
<a name="line395">395: </a>    <font color="#4169E1">if</font> (a1 &lt; 1.e-4) *ismin = <A href="../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</A>;
<a name="line396">396: </a>  }
<a name="line397">397: </a>  <font color="#4169E1">return</font>(0);
<a name="line398">398: </a>}

<a name="line400">400: </a><font color="#B22222">/*</font>
<a name="line401">401: </a><font color="#B22222">     Checks if J^T(F - J*X) = 0 </font>
<a name="line402">402: </a><font color="#B22222">*/</font>
<a name="line405">405: </a><strong><font color="#4169E1"><a name="SNESVICheckResidual_Private"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVICheckResidual_Private(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> A,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> F,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> X,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> W1,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> W2)</font></strong>
<a name="line406">406: </a>{
<a name="line407">407: </a>  <A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A>      a1,a2;
<a name="line409">409: </a>  <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A>     hastranspose;

<a name="line412">412: </a>  <A href="../../../../docs/manualpages/Mat/MatHasOperation.html#MatHasOperation">MatHasOperation</A>(A,MATOP_MULT_TRANSPOSE,&amp;hastranspose);
<a name="line413">413: </a>  <font color="#4169E1">if</font> (hastranspose) {
<a name="line414">414: </a>    <A href="../../../../docs/manualpages/Mat/MatMult.html#MatMult">MatMult</A>(A,X,W1);
<a name="line415">415: </a>    <A href="../../../../docs/manualpages/Vec/VecAXPY.html#VecAXPY">VecAXPY</A>(W1,-1.0,F);

<a name="line417">417: </a>    <font color="#B22222">/* Compute || J^T W|| */</font>
<a name="line418">418: </a>    <A href="../../../../docs/manualpages/Mat/MatMultTranspose.html#MatMultTranspose">MatMultTranspose</A>(A,W1,W2);
<a name="line419">419: </a>    <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(W1,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,&amp;a1);
<a name="line420">420: </a>    <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(W2,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,&amp;a2);
<a name="line421">421: </a>    <font color="#4169E1">if</font> (a1 != 0.0) {
<a name="line422">422: </a>      PetscInfo1(snes,<font color="#666666">"||J^T(F-Ax)||/||F-AX|| %G near zero implies inconsistent rhs\n"</font>,a2/a1);
<a name="line423">423: </a>    }
<a name="line424">424: </a>  }
<a name="line425">425: </a>  <font color="#4169E1">return</font>(0);
<a name="line426">426: </a>}

<a name="line428">428: </a><font color="#B22222">/*</font>
<a name="line429">429: </a><font color="#B22222">  SNESDefaultConverged_VI - Checks the convergence of the semismooth newton algorithm.</font>

<a name="line431">431: </a><font color="#B22222">  Notes:</font>
<a name="line432">432: </a><font color="#B22222">  The convergence criterion currently implemented is</font>
<a name="line433">433: </a><font color="#B22222">  merit &lt; abstol</font>
<a name="line434">434: </a><font color="#B22222">  merit &lt; rtol*merit_initial</font>
<a name="line435">435: </a><font color="#B22222">*/</font>
<a name="line438">438: </a><strong><font color="#4169E1"><a name="SNESDefaultConverged_VI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESDefaultConverged_VI(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A> it,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> xnorm,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> gradnorm,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> fnorm,<A href="../../../../docs/manualpages/SNES/SNESConvergedReason.html#SNESConvergedReason">SNESConvergedReason</A> *reason,void *dummy)</font></strong>
<a name="line439">439: </a>{

<a name="line445">445: </a>
<a name="line446">446: </a>  *reason = SNES_CONVERGED_ITERATING;

<a name="line448">448: </a>  <font color="#4169E1">if</font> (!it) {
<a name="line449">449: </a>    <font color="#B22222">/* set parameter for default relative tolerance convergence test */</font>
<a name="line450">450: </a>    snes-&gt;ttol = fnorm*snes-&gt;rtol;
<a name="line451">451: </a>  }
<a name="line452">452: </a>  <font color="#4169E1">if</font> (fnorm != fnorm) {
<a name="line453">453: </a>    <A href="../../../../docs/manualpages/Profiling/PetscInfo.html#PetscInfo">PetscInfo</A>(snes,<font color="#666666">"Failed to converged, function norm is NaN\n"</font>);
<a name="line454">454: </a>    *reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_FNORM_NAN.html#SNES_DIVERGED_FNORM_NAN">SNES_DIVERGED_FNORM_NAN</A>;
<a name="line455">455: </a>  } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (fnorm &lt; snes-&gt;abstol) {
<a name="line456">456: </a>    PetscInfo2(snes,<font color="#666666">"Converged due to function norm %G &lt; %G\n"</font>,fnorm,snes-&gt;abstol);
<a name="line457">457: </a>    *reason = <A href="../../../../docs/manualpages/SNES/SNES_CONVERGED_FNORM_ABS.html#SNES_CONVERGED_FNORM_ABS">SNES_CONVERGED_FNORM_ABS</A>;
<a name="line458">458: </a>  } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (snes-&gt;nfuncs &gt;= snes-&gt;max_funcs) {
<a name="line459">459: </a>    PetscInfo2(snes,<font color="#666666">"Exceeded maximum number of function evaluations: %D &gt; %D\n"</font>,snes-&gt;nfuncs,snes-&gt;max_funcs);
<a name="line460">460: </a>    *reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_FUNCTION_COUNT.html#SNES_DIVERGED_FUNCTION_COUNT">SNES_DIVERGED_FUNCTION_COUNT</A>;
<a name="line461">461: </a>  }

<a name="line463">463: </a>  <font color="#4169E1">if</font> (it &amp;&amp; !*reason) {
<a name="line464">464: </a>    <font color="#4169E1">if</font> (fnorm &lt; snes-&gt;ttol) {
<a name="line465">465: </a>      PetscInfo2(snes,<font color="#666666">"Converged due to function norm %G &lt; %G (relative tolerance)\n"</font>,fnorm,snes-&gt;ttol);
<a name="line466">466: </a>      *reason = <A href="../../../../docs/manualpages/SNES/SNES_CONVERGED_FNORM_RELATIVE.html#SNES_CONVERGED_FNORM_RELATIVE">SNES_CONVERGED_FNORM_RELATIVE</A>;
<a name="line467">467: </a>    }
<a name="line468">468: </a>  }
<a name="line469">469: </a>  <font color="#4169E1">return</font>(0);
<a name="line470">470: </a>}

<a name="line472">472: </a><font color="#B22222">/*</font>
<a name="line473">473: </a><font color="#B22222">  SNESVIComputeMeritFunction - Evaluates the merit function for the mixed complementarity problem.</font>

<a name="line475">475: </a><font color="#B22222">  Input Parameter:</font>
<a name="line476">476: </a><font color="#B22222">. phi - the semismooth function</font>

<a name="line478">478: </a><font color="#B22222">  Output Parameter:</font>
<a name="line479">479: </a><font color="#B22222">. merit - the merit function</font>
<a name="line480">480: </a><font color="#B22222">. phinorm - ||phi||</font>

<a name="line482">482: </a><font color="#B22222">  Notes:</font>
<a name="line483">483: </a><font color="#B22222">  The merit function for the mixed complementarity problem is defined as</font>
<a name="line484">484: </a><font color="#B22222">     merit = 0.5*phi^T*phi</font>
<a name="line485">485: </a><font color="#B22222">*/</font>
<a name="line488">488: </a><strong><font color="#4169E1"><a name="SNESVIComputeMeritFunction"></a>static <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVIComputeMeritFunction(<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> phi, <A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A>* merit,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A>* phinorm)</font></strong>
<a name="line489">489: </a>{

<a name="line493">493: </a>  <A href="../../../../docs/manualpages/Vec/VecNormBegin.html#VecNormBegin">VecNormBegin</A>(phi,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,phinorm);
<a name="line494">494: </a>  <A href="../../../../docs/manualpages/Vec/VecNormEnd.html#VecNormEnd">VecNormEnd</A>(phi,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,phinorm);

<a name="line496">496: </a>  *merit = 0.5*(*phinorm)*(*phinorm);
<a name="line497">497: </a>  <font color="#4169E1">return</font>(0);
<a name="line498">498: </a>}

<a name="line500">500: </a><strong><font color="#4169E1"><a name="Phi"></a>PETSC_STATIC_INLINE <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> Phi(<A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> a,<A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> b)</font></strong>
<a name="line501">501: </a>{
<a name="line502">502: </a>  <font color="#4169E1">return</font> a + b - PetscSqrtScalar(a*a + b*b);
<a name="line503">503: </a>}

<a name="line505">505: </a><strong><font color="#4169E1"><a name="DPhi"></a>PETSC_STATIC_INLINE <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> DPhi(<A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> a,<A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> b)</font></strong>
<a name="line506">506: </a>{
<a name="line507">507: </a>  <font color="#4169E1">if</font> ((PetscAbsScalar(a) &gt;= 1.e-6) || (PetscAbsScalar(b) &gt;= 1.e-6)) <font color="#4169E1">return</font>  1.0 - a/ PetscSqrtScalar(a*a + b*b);
<a name="line508">508: </a>  <font color="#4169E1">else</font> <font color="#4169E1">return</font> .5;
<a name="line509">509: </a>}

<a name="line511">511: </a><font color="#B22222">/* </font>
<a name="line512">512: </a><font color="#B22222">   SNESVIComputeFunction - Reformulates a system of nonlinear equations in mixed complementarity form to a system of nonlinear equations in semismooth form. </font>

<a name="line514">514: </a><font color="#B22222">   Input Parameters:  </font>
<a name="line515">515: </a><font color="#B22222">.  snes - the <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> context</font>
<a name="line516">516: </a><font color="#B22222">.  x - current iterate</font>
<a name="line517">517: </a><font color="#B22222">.  functx - user defined function context</font>

<a name="line519">519: </a><font color="#B22222">   Output Parameters:</font>
<a name="line520">520: </a><font color="#B22222">.  phi - Semismooth function</font>

<a name="line522">522: </a><font color="#B22222">*/</font>
<a name="line525">525: </a><strong><font color="#4169E1"><a name="SNESVIComputeFunction"></a>static <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVIComputeFunction(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> X,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> phi,void* functx)</font></strong>
<a name="line526">526: </a>{
<a name="line527">527: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>  ierr;
<a name="line528">528: </a>  SNES_VI         *vi = (SNES_VI*)snes-&gt;data;
<a name="line529">529: </a>  <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>             Xl = vi-&gt;xl,Xu = vi-&gt;xu,F = snes-&gt;vec_func;
<a name="line530">530: </a>  <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>     *phi_arr,*x_arr,*f_arr,*l,*u;
<a name="line531">531: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>        i,nlocal;

<a name="line534">534: </a>  (*vi-&gt;computeuserfunction)(snes,X,F,functx);
<a name="line535">535: </a>  <A href="../../../../docs/manualpages/Vec/VecGetLocalSize.html#VecGetLocalSize">VecGetLocalSize</A>(X,&amp;nlocal);
<a name="line536">536: </a>  <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(X,&amp;x_arr);
<a name="line537">537: </a>  <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(F,&amp;f_arr);
<a name="line538">538: </a>  <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(Xl,&amp;l);
<a name="line539">539: </a>  <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(Xu,&amp;u);
<a name="line540">540: </a>  <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(phi,&amp;phi_arr);

<a name="line542">542: </a>  <font color="#4169E1">for</font> (i=0;i &lt; nlocal;i++) {
<a name="line543">543: </a>    <font color="#4169E1">if</font> ((PetscRealPart(l[i]) &lt;= SNES_VI_NINF) &amp;&amp; (PetscRealPart(u[i]) &gt;= SNES_VI_INF)) { <font color="#B22222">/* no constraints on variable */</font>
<a name="line544">544: </a>      phi_arr[i] = f_arr[i];
<a name="line545">545: </a>    } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (PetscRealPart(l[i]) &lt;= SNES_VI_NINF) {                      <font color="#B22222">/* upper bound on variable only */</font>
<a name="line546">546: </a>      phi_arr[i] = -Phi(u[i] - x_arr[i],-f_arr[i]);
<a name="line547">547: </a>    } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (PetscRealPart(u[i]) &gt;= SNES_VI_INF) {                       <font color="#B22222">/* lower bound on variable only */</font>
<a name="line548">548: </a>      phi_arr[i] = Phi(x_arr[i] - l[i],f_arr[i]);
<a name="line549">549: </a>    } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (l[i] == u[i]) {
<a name="line550">550: </a>      phi_arr[i] = l[i] - x_arr[i];
<a name="line551">551: </a>    } <font color="#4169E1">else</font> {                                                <font color="#B22222">/* both bounds on variable */</font>
<a name="line552">552: </a>      phi_arr[i] = Phi(x_arr[i] - l[i],-Phi(u[i] - x_arr[i],-f_arr[i]));
<a name="line553">553: </a>    }
<a name="line554">554: </a>  }
<a name="line555">555: </a>
<a name="line556">556: </a>  <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(X,&amp;x_arr);
<a name="line557">557: </a>  <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(F,&amp;f_arr);
<a name="line558">558: </a>  <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(Xl,&amp;l);
<a name="line559">559: </a>  <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(Xu,&amp;u);
<a name="line560">560: </a>  <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(phi,&amp;phi_arr);
<a name="line561">561: </a>  <font color="#4169E1">return</font>(0);
<a name="line562">562: </a>}

<a name="line564">564: </a><font color="#B22222">/* </font>
<a name="line565">565: </a><font color="#B22222">   SNESVIComputeBsubdifferentialVectors - Computes the diagonal shift (Da) and row scaling (Db) vectors needed for the</font>
<a name="line566">566: </a><font color="#B22222">                                          the semismooth jacobian.</font>
<a name="line567">567: </a><font color="#B22222">*/</font>
<a name="line570">570: </a><strong><font color="#4169E1"><a name="SNESVIComputeBsubdifferentialVectors"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVIComputeBsubdifferentialVectors(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> X,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> F,<A href="../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> jac,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> Da,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> Db)</font></strong>
<a name="line571">571: </a>{
<a name="line573">573: </a>  SNES_VI      *vi = (SNES_VI*)snes-&gt;data;
<a name="line574">574: </a>  <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>    *l,*u,*x,*f,*da,*db,da1,da2,db1,db2;
<a name="line575">575: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       i,nlocal;


<a name="line579">579: </a>  <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(X,&amp;x);
<a name="line580">580: </a>  <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(F,&amp;f);
<a name="line581">581: </a>  <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(vi-&gt;xl,&amp;l);
<a name="line582">582: </a>  <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(vi-&gt;xu,&amp;u);
<a name="line583">583: </a>  <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(Da,&amp;da);
<a name="line584">584: </a>  <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(Db,&amp;db);
<a name="line585">585: </a>  <A href="../../../../docs/manualpages/Vec/VecGetLocalSize.html#VecGetLocalSize">VecGetLocalSize</A>(X,&amp;nlocal);
<a name="line586">586: </a>
<a name="line587">587: </a>  <font color="#4169E1">for</font> (i=0;i&lt; nlocal;i++) {
<a name="line588">588: </a>    <font color="#4169E1">if</font> ((PetscRealPart(l[i]) &lt;= SNES_VI_NINF) &amp;&amp; (PetscRealPart(u[i]) &gt;= SNES_VI_INF)) {<font color="#B22222">/* no constraints on variable */</font>
<a name="line589">589: </a>      da[i] = 0;
<a name="line590">590: </a>      db[i] = 1;
<a name="line591">591: </a>    } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (PetscRealPart(l[i]) &lt;= SNES_VI_NINF) {                     <font color="#B22222">/* upper bound on variable only */</font>
<a name="line592">592: </a>      da[i] = DPhi(u[i] - x[i], -f[i]);
<a name="line593">593: </a>      db[i] = DPhi(-f[i],u[i] - x[i]);
<a name="line594">594: </a>    } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (PetscRealPart(u[i]) &gt;= SNES_VI_INF) {                      <font color="#B22222">/* lower bound on variable only */</font>
<a name="line595">595: </a>      da[i] = DPhi(x[i] - l[i], f[i]);
<a name="line596">596: </a>      db[i] = DPhi(f[i],x[i] - l[i]);
<a name="line597">597: </a>    } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (l[i] == u[i]) {                              <font color="#B22222">/* fixed variable */</font>
<a name="line598">598: </a>      da[i] = 1;
<a name="line599">599: </a>      db[i] = 0;
<a name="line600">600: </a>    } <font color="#4169E1">else</font> {                                                <font color="#B22222">/* upper and lower bounds on variable */</font>
<a name="line601">601: </a>      da1 = DPhi(x[i] - l[i], -Phi(u[i] - x[i], -f[i]));
<a name="line602">602: </a>      db1 = DPhi(-Phi(u[i] - x[i], -f[i]),x[i] - l[i]);
<a name="line603">603: </a>      da2 = DPhi(u[i] - x[i], -f[i]);
<a name="line604">604: </a>      db2 = DPhi(-f[i],u[i] - x[i]);
<a name="line605">605: </a>      da[i] = da1 + db1*da2;
<a name="line606">606: </a>      db[i] = db1*db2;
<a name="line607">607: </a>    }
<a name="line608">608: </a>  }

<a name="line610">610: </a>  <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(X,&amp;x);
<a name="line611">611: </a>  <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(F,&amp;f);
<a name="line612">612: </a>  <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(vi-&gt;xl,&amp;l);
<a name="line613">613: </a>  <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(vi-&gt;xu,&amp;u);
<a name="line614">614: </a>  <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(Da,&amp;da);
<a name="line615">615: </a>  <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(Db,&amp;db);
<a name="line616">616: </a>  <font color="#4169E1">return</font>(0);
<a name="line617">617: </a>}

<a name="line619">619: </a><font color="#B22222">/*</font>
<a name="line620">620: </a><font color="#B22222">   SNESVIComputeJacobian - Computes the jacobian of the semismooth function.The Jacobian for the semismooth function is an element of the B-subdifferential of the Fischer-Burmeister function for complementarity problems.</font>

<a name="line622">622: </a><font color="#B22222">   Input Parameters:</font>
<a name="line623">623: </a><font color="#B22222">.  Da       - Diagonal shift vector for the semismooth jacobian.</font>
<a name="line624">624: </a><font color="#B22222">.  Db       - Row scaling vector for the semismooth jacobian. </font>

<a name="line626">626: </a><font color="#B22222">   Output Parameters:</font>
<a name="line627">627: </a><font color="#B22222">.  jac      - semismooth jacobian</font>
<a name="line628">628: </a><font color="#B22222">.  jac_pre  - optional preconditioning matrix</font>

<a name="line630">630: </a><font color="#B22222">   Notes:</font>
<a name="line631">631: </a><font color="#B22222">   The semismooth jacobian matrix is given by</font>
<a name="line632">632: </a><font color="#B22222">   jac = Da + Db*jacfun</font>
<a name="line633">633: </a><font color="#B22222">   where Db is the row scaling matrix stored as a vector,</font>
<a name="line634">634: </a><font color="#B22222">         Da is the diagonal perturbation matrix stored as a vector</font>
<a name="line635">635: </a><font color="#B22222">   and   jacfun is the jacobian of the original nonlinear function.         </font>
<a name="line636">636: </a><font color="#B22222">*/</font>
<a name="line639">639: </a><strong><font color="#4169E1"><a name="SNESVIComputeJacobian"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVIComputeJacobian(<A href="../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> jac, <A href="../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> jac_pre,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> Da, <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> Db)</font></strong>
<a name="line640">640: </a>{
<a name="line642">642: </a>
<a name="line643">643: </a>  <font color="#B22222">/* Do row scaling  and add diagonal perturbation */</font>
<a name="line644">644: </a>  <A href="../../../../docs/manualpages/Mat/MatDiagonalScale.html#MatDiagonalScale">MatDiagonalScale</A>(jac,Db,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line645">645: </a>  <A href="../../../../docs/manualpages/Mat/MatDiagonalSet.html#MatDiagonalSet">MatDiagonalSet</A>(jac,Da,<A href="../../../../docs/manualpages/Sys/ADD_VALUES.html#ADD_VALUES">ADD_VALUES</A>);
<a name="line646">646: </a>  <font color="#4169E1">if</font> (jac != jac_pre) { <font color="#B22222">/* If jac and jac_pre are different */</font>
<a name="line647">647: </a>    <A href="../../../../docs/manualpages/Mat/MatDiagonalScale.html#MatDiagonalScale">MatDiagonalScale</A>(jac_pre,Db,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line648">648: </a>    <A href="../../../../docs/manualpages/Mat/MatDiagonalSet.html#MatDiagonalSet">MatDiagonalSet</A>(jac_pre,Da,<A href="../../../../docs/manualpages/Sys/ADD_VALUES.html#ADD_VALUES">ADD_VALUES</A>);
<a name="line649">649: </a>  }
<a name="line650">650: </a>  <font color="#4169E1">return</font>(0);
<a name="line651">651: </a>}

<a name="line653">653: </a><font color="#B22222">/*</font>
<a name="line654">654: </a><font color="#B22222">   SNESVIComputeMeritFunctionGradient - Computes the gradient of the merit function psi.</font>

<a name="line656">656: </a><font color="#B22222">   Input Parameters:</font>
<a name="line657">657: </a><font color="#B22222">   phi - semismooth function.</font>
<a name="line658">658: </a><font color="#B22222">   H   - semismooth jacobian</font>
<a name="line659">659: </a><font color="#B22222">   </font>
<a name="line660">660: </a><font color="#B22222">   Output Parameters:</font>
<a name="line661">661: </a><font color="#B22222">   dpsi - merit function gradient</font>

<a name="line663">663: </a><font color="#B22222">   Notes:</font>
<a name="line664">664: </a><font color="#B22222">  The merit function gradient is computed as follows</font>
<a name="line665">665: </a><font color="#B22222">        dpsi = H^T*phi</font>
<a name="line666">666: </a><font color="#B22222">*/</font>
<a name="line669">669: </a><strong><font color="#4169E1"><a name="SNESVIComputeMeritFunctionGradient"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVIComputeMeritFunctionGradient(<A href="../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> H, <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> phi, <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> dpsi)</font></strong>
<a name="line670">670: </a>{
<a name="line672">672: </a>
<a name="line674">674: </a>  <A href="../../../../docs/manualpages/Mat/MatMultTranspose.html#MatMultTranspose">MatMultTranspose</A>(H,phi,dpsi);
<a name="line675">675: </a>  <font color="#4169E1">return</font>(0);
<a name="line676">676: </a>}

<a name="line678">678: </a><font color="#B22222">/* -------------------------------------------------------------------------- */</font>
<a name="line679">679: </a><font color="#B22222">/*</font>
<a name="line680">680: </a><font color="#B22222">   SNESVIProjectOntoBounds - Projects X onto the feasible region so that Xl[i] &lt;= X[i] &lt;= Xu[i] for i = 1...n.</font>

<a name="line682">682: </a><font color="#B22222">   Input Parameters:</font>
<a name="line683">683: </a><font color="#B22222">.  <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> - nonlinear solver context</font>

<a name="line685">685: </a><font color="#B22222">   Output Parameters:</font>
<a name="line686">686: </a><font color="#B22222">.  X - Bound projected X</font>

<a name="line688">688: </a><font color="#B22222">*/</font>

<a name="line692">692: </a><strong><font color="#4169E1"><a name="SNESVIProjectOntoBounds"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVIProjectOntoBounds(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> X)</font></strong>
<a name="line693">693: </a>{
<a name="line694">694: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>    ierr;
<a name="line695">695: </a>  SNES_VI           *vi = (SNES_VI*)snes-&gt;data;
<a name="line696">696: </a>  const <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> *xl,*xu;
<a name="line697">697: </a>  <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>       *x;
<a name="line698">698: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>          i,n;

<a name="line701">701: </a>  <A href="../../../../docs/manualpages/Vec/VecGetLocalSize.html#VecGetLocalSize">VecGetLocalSize</A>(X,&amp;n);
<a name="line702">702: </a>  <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(X,&amp;x);
<a name="line703">703: </a>  VecGetArrayRead(vi-&gt;xl,&amp;xl);
<a name="line704">704: </a>  VecGetArrayRead(vi-&gt;xu,&amp;xu);

<a name="line706">706: </a>  <font color="#4169E1">for</font>(i = 0;i&lt;n;i++) {
<a name="line707">707: </a>    <font color="#4169E1">if</font> (PetscRealPart(x[i]) &lt; PetscRealPart(xl[i])) x[i] = xl[i];
<a name="line708">708: </a>    <font color="#4169E1">else</font> <font color="#4169E1">if</font> (PetscRealPart(x[i]) &gt; PetscRealPart(xu[i])) x[i] = xu[i];
<a name="line709">709: </a>  }
<a name="line710">710: </a>  <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(X,&amp;x);
<a name="line711">711: </a>  VecRestoreArrayRead(vi-&gt;xl,&amp;xl);
<a name="line712">712: </a>  VecRestoreArrayRead(vi-&gt;xu,&amp;xu);
<a name="line713">713: </a>  <font color="#4169E1">return</font>(0);
<a name="line714">714: </a>}

<a name="line716">716: </a><font color="#B22222">/*  -------------------------------------------------------------------- </font>

<a name="line718">718: </a><font color="#B22222">     This file implements a semismooth truncated Newton method with a line search,</font>
<a name="line719">719: </a><font color="#B22222">     for solving a system of nonlinear equations in complementarity form, using the <A href="../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</A>, <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>, </font>
<a name="line720">720: </a><font color="#B22222">     and <A href="../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> interfaces for linear solvers, vectors, and matrices, </font>
<a name="line721">721: </a><font color="#B22222">     respectively.</font>

<a name="line723">723: </a><font color="#B22222">     The following basic routines are required for each nonlinear solver:</font>
<a name="line724">724: </a><font color="#B22222">          SNESCreate_XXX()          - Creates a nonlinear solver context</font>
<a name="line725">725: </a><font color="#B22222">          SNESSetFromOptions_XXX()  - Sets runtime options</font>
<a name="line726">726: </a><font color="#B22222">          SNESSolve_XXX()           - Solves the nonlinear system</font>
<a name="line727">727: </a><font color="#B22222">          SNESDestroy_XXX()         - Destroys the nonlinear solver context</font>
<a name="line728">728: </a><font color="#B22222">     The suffix "_XXX" denotes a particular implementation, in this case</font>
<a name="line729">729: </a><font color="#B22222">     we use _VI (e.g., SNESCreate_VI, SNESSolve_VI) for solving</font>
<a name="line730">730: </a><font color="#B22222">     systems of nonlinear equations with a line search (LS) method.</font>
<a name="line731">731: </a><font color="#B22222">     These routines are actually called via the common user interface</font>
<a name="line732">732: </a><font color="#B22222">     routines <A href="../../../../docs/manualpages/SNES/SNESCreate.html#SNESCreate">SNESCreate</A>(), <A href="../../../../docs/manualpages/SNES/SNESSetFromOptions.html#SNESSetFromOptions">SNESSetFromOptions</A>(), <A href="../../../../docs/manualpages/SNES/SNESSolve.html#SNESSolve">SNESSolve</A>(), and </font>
<a name="line733">733: </a><font color="#B22222">     <A href="../../../../docs/manualpages/SNES/SNESDestroy.html#SNESDestroy">SNESDestroy</A>(), so the application code interface remains identical </font>
<a name="line734">734: </a><font color="#B22222">     for all nonlinear solvers.</font>

<a name="line736">736: </a><font color="#B22222">     Another key routine is:</font>
<a name="line737">737: </a><font color="#B22222">          SNESSetUp_XXX()           - Prepares for the use of a nonlinear solver</font>
<a name="line738">738: </a><font color="#B22222">     by setting data structures and options.   The interface routine <A href="../../../../docs/manualpages/SNES/SNESSetUp.html#SNESSetUp">SNESSetUp</A>()</font>
<a name="line739">739: </a><font color="#B22222">     is not usually called directly by the user, but instead is called by</font>
<a name="line740">740: </a><font color="#B22222">     <A href="../../../../docs/manualpages/SNES/SNESSolve.html#SNESSolve">SNESSolve</A>() if necessary.</font>

<a name="line742">742: </a><font color="#B22222">     Additional basic routines are:</font>
<a name="line743">743: </a><font color="#B22222">          SNESView_XXX()            - Prints details of runtime options that</font>
<a name="line744">744: </a><font color="#B22222">                                      have actually been used.</font>
<a name="line745">745: </a><font color="#B22222">     These are called by application codes via the interface routines</font>
<a name="line746">746: </a><font color="#B22222">     <A href="../../../../docs/manualpages/SNES/SNESView.html#SNESView">SNESView</A>().</font>

<a name="line748">748: </a><font color="#B22222">     The various types of solvers (preconditioners, Krylov subspace methods,</font>
<a name="line749">749: </a><font color="#B22222">     nonlinear solvers, timesteppers) are all organized similarly, so the</font>
<a name="line750">750: </a><font color="#B22222">     above description applies to these categories also.  </font>

<a name="line752">752: </a><font color="#B22222">    -------------------------------------------------------------------- */</font>
<a name="line753">753: </a><font color="#B22222">/*</font>
<a name="line754">754: </a><font color="#B22222">   SNESSolveVI_SS - Solves the complementarity problem with a semismooth Newton</font>
<a name="line755">755: </a><font color="#B22222">   method using a line search.</font>

<a name="line757">757: </a><font color="#B22222">   Input Parameters:</font>
<a name="line758">758: </a><font color="#B22222">.  snes - the <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> context</font>

<a name="line760">760: </a><font color="#B22222">   Output Parameter:</font>
<a name="line761">761: </a><font color="#B22222">.  outits - number of iterations until termination</font>

<a name="line763">763: </a><font color="#B22222">   Application Interface Routine: <A href="../../../../docs/manualpages/SNES/SNESSolve.html#SNESSolve">SNESSolve</A>()</font>

<a name="line765">765: </a><font color="#B22222">   Notes:</font>
<a name="line766">766: </a><font color="#B22222">   This implements essentially a semismooth Newton method with a</font>
<a name="line767">767: </a><font color="#B22222">   line search. The default line search does not do any line seach</font>
<a name="line768">768: </a><font color="#B22222">   but rather takes a full newton step.</font>
<a name="line769">769: </a><font color="#B22222">*/</font>
<a name="line772">772: </a><strong><font color="#4169E1"><a name="SNESSolveVI_SS"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESSolveVI_SS(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes)</font></strong>
<a name="line773">773: </a>{
<a name="line774">774: </a>  SNES_VI            *vi = (SNES_VI*)snes-&gt;data;
<a name="line775">775: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>     ierr;
<a name="line776">776: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>           maxits,i,lits;
<a name="line777">777: </a>  <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A>          lssucceed;
<a name="line778">778: </a>  <A href="../../../../docs/manualpages/Mat/MatStructure.html#MatStructure">MatStructure</A>       flg = DIFFERENT_NONZERO_PATTERN;
<a name="line779">779: </a>  <A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A>          gnorm,xnorm=0,ynorm;
<a name="line780">780: </a>  <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>                Y,X,F,G,W;
<a name="line781">781: </a>  <A href="../../../../docs/manualpages/KSP/KSPConvergedReason.html#KSPConvergedReason">KSPConvergedReason</A> kspreason;

<a name="line784">784: </a>  vi-&gt;computeuserfunction    = snes-&gt;ops-&gt;computefunction;
<a name="line785">785: </a>  snes-&gt;ops-&gt;computefunction = SNESVIComputeFunction;

<a name="line787">787: </a>  snes-&gt;numFailures            = 0;
<a name="line788">788: </a>  snes-&gt;numLinearSolveFailures = 0;
<a name="line789">789: </a>  snes-&gt;reason                 = SNES_CONVERGED_ITERATING;

<a name="line791">791: </a>  maxits        = snes-&gt;max_its;        <font color="#B22222">/* maximum number of iterations */</font>
<a name="line792">792: </a>  X                = snes-&gt;vec_sol;        <font color="#B22222">/* solution vector */</font>
<a name="line793">793: </a>  F                = snes-&gt;vec_func;        <font color="#B22222">/* residual vector */</font>
<a name="line794">794: </a>  Y                = snes-&gt;work[0];        <font color="#B22222">/* work vectors */</font>
<a name="line795">795: </a>  G                = snes-&gt;work[1];
<a name="line796">796: </a>  W                = snes-&gt;work[2];

<a name="line798">798: </a>  PetscObjectTakeAccess(snes);
<a name="line799">799: </a>  snes-&gt;iter = 0;
<a name="line800">800: </a>  snes-&gt;norm = 0.0;
<a name="line801">801: </a>  PetscObjectGrantAccess(snes);

<a name="line803">803: </a>  SNESVIProjectOntoBounds(snes,X);
<a name="line804">804: </a>  <A href="../../../../docs/manualpages/SNES/SNESComputeFunction.html#SNESComputeFunction">SNESComputeFunction</A>(snes,X,vi-&gt;phi);
<a name="line805">805: </a>  <font color="#4169E1">if</font> (snes-&gt;domainerror) {
<a name="line806">806: </a>    snes-&gt;reason = SNES_DIVERGED_FUNCTION_DOMAIN;
<a name="line807">807: </a>    snes-&gt;ops-&gt;computefunction = vi-&gt;computeuserfunction;
<a name="line808">808: </a>    <font color="#4169E1">return</font>(0);
<a name="line809">809: </a>  }
<a name="line810">810: </a>   <font color="#B22222">/* Compute Merit function */</font>
<a name="line811">811: </a>  SNESVIComputeMeritFunction(vi-&gt;phi,&amp;vi-&gt;merit,&amp;vi-&gt;phinorm);

<a name="line813">813: </a>  <A href="../../../../docs/manualpages/Vec/VecNormBegin.html#VecNormBegin">VecNormBegin</A>(X,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,&amp;xnorm);        <font color="#B22222">/* xnorm &lt;- ||x||  */</font>
<a name="line814">814: </a>  <A href="../../../../docs/manualpages/Vec/VecNormEnd.html#VecNormEnd">VecNormEnd</A>(X,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,&amp;xnorm);
<a name="line815">815: </a>  <font color="#4169E1">if</font> (PetscIsInfOrNanReal(vi-&gt;merit)) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_FP,<font color="#666666">"User provided compute function generated a Not-a-Number"</font>);

<a name="line817">817: </a>  PetscObjectTakeAccess(snes);
<a name="line818">818: </a>  snes-&gt;norm = vi-&gt;phinorm;
<a name="line819">819: </a>  PetscObjectGrantAccess(snes);
<a name="line820">820: </a>  SNESLogConvHistory(snes,vi-&gt;phinorm,0);
<a name="line821">821: </a>  <A href="../../../../docs/manualpages/SNES/SNESMonitor.html#SNESMonitor">SNESMonitor</A>(snes,0,vi-&gt;phinorm);

<a name="line823">823: </a>  <font color="#B22222">/* set parameter for default relative tolerance convergence test */</font>
<a name="line824">824: </a>  snes-&gt;ttol = vi-&gt;phinorm*snes-&gt;rtol;
<a name="line825">825: </a>  <font color="#B22222">/* test convergence */</font>
<a name="line826">826: </a>  (*snes-&gt;ops-&gt;converged)(snes,0,0.0,0.0,vi-&gt;phinorm,&amp;snes-&gt;reason,snes-&gt;cnvP);
<a name="line827">827: </a>  <font color="#4169E1">if</font> (snes-&gt;reason) {
<a name="line828">828: </a>    snes-&gt;ops-&gt;computefunction = vi-&gt;computeuserfunction;
<a name="line829">829: </a>    <font color="#4169E1">return</font>(0);
<a name="line830">830: </a>  }

<a name="line832">832: </a>  <font color="#4169E1">for</font> (i=0; i&lt;maxits; i++) {

<a name="line834">834: </a>    <font color="#B22222">/* Call general purpose update function */</font>
<a name="line835">835: </a>    <font color="#4169E1">if</font> (snes-&gt;ops-&gt;update) {
<a name="line836">836: </a>      (*snes-&gt;ops-&gt;update)(snes, snes-&gt;iter);
<a name="line837">837: </a>    }
<a name="line838">838: </a>
<a name="line839">839: </a>    <font color="#B22222">/* Solve J Y = Phi, where J is the semismooth jacobian */</font>
<a name="line840">840: </a>    <font color="#B22222">/* Get the nonlinear function jacobian */</font>
<a name="line841">841: </a>    <A href="../../../../docs/manualpages/SNES/SNESComputeJacobian.html#SNESComputeJacobian">SNESComputeJacobian</A>(snes,X,&amp;snes-&gt;jacobian,&amp;snes-&gt;jacobian_pre,&amp;flg);
<a name="line842">842: </a>    <font color="#B22222">/* Get the diagonal shift and row scaling vectors */</font>
<a name="line843">843: </a>    SNESVIComputeBsubdifferentialVectors(snes,X,F,snes-&gt;jacobian,vi-&gt;Da,vi-&gt;Db);
<a name="line844">844: </a>    <font color="#B22222">/* Compute the semismooth jacobian */</font>
<a name="line845">845: </a>    SNESVIComputeJacobian(snes-&gt;jacobian,snes-&gt;jacobian_pre,vi-&gt;Da,vi-&gt;Db);
<a name="line846">846: </a>    <font color="#B22222">/* Compute the merit function gradient */</font>
<a name="line847">847: </a>    SNESVIComputeMeritFunctionGradient(snes-&gt;jacobian,vi-&gt;phi,vi-&gt;dpsi);
<a name="line848">848: </a>    <A href="../../../../docs/manualpages/KSP/KSPSetOperators.html#KSPSetOperators">KSPSetOperators</A>(snes-&gt;ksp,snes-&gt;jacobian,snes-&gt;jacobian_pre,flg);
<a name="line849">849: </a>    SNES_KSPSolve(snes,snes-&gt;ksp,vi-&gt;phi,Y);
<a name="line850">850: </a>    <A href="../../../../docs/manualpages/KSP/KSPGetConvergedReason.html#KSPGetConvergedReason">KSPGetConvergedReason</A>(snes-&gt;ksp,&amp;kspreason);

<a name="line852">852: </a>    <font color="#4169E1">if</font> (kspreason &lt; 0) {
<a name="line853">853: </a>      <font color="#4169E1">if</font> (++snes-&gt;numLinearSolveFailures &gt;= snes-&gt;maxLinearSolveFailures) {
<a name="line854">854: </a>        PetscInfo2(snes,<font color="#666666">"iter=%D, number linear solve failures %D greater than current <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> allowed, stopping solve\n"</font>,snes-&gt;iter,snes-&gt;numLinearSolveFailures);
<a name="line855">855: </a>        snes-&gt;reason = SNES_DIVERGED_LINEAR_SOLVE;
<a name="line856">856: </a>        <font color="#4169E1">break</font>;
<a name="line857">857: </a>      }
<a name="line858">858: </a>    }
<a name="line859">859: </a>    <A href="../../../../docs/manualpages/KSP/KSPGetIterationNumber.html#KSPGetIterationNumber">KSPGetIterationNumber</A>(snes-&gt;ksp,&amp;lits);
<a name="line860">860: </a>    snes-&gt;linear_its += lits;
<a name="line861">861: </a>    PetscInfo2(snes,<font color="#666666">"iter=%D, linear solve iterations=%D\n"</font>,snes-&gt;iter,lits);
<a name="line862">862: </a>    <font color="#B22222">/*</font>
<a name="line863">863: </a><font color="#B22222">    if (vi-&gt;precheckstep) {</font>
<a name="line864">864: </a><font color="#B22222">      <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A> changed_y = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;</font>
<a name="line865">865: </a><font color="#B22222">      (*vi-&gt;precheckstep)(snes,X,Y,vi-&gt;precheck,&amp;changed_y);</font>
<a name="line866">866: </a><font color="#B22222">    }</font>

<a name="line868">868: </a><font color="#B22222">    if (PetscLogPrintInfo){</font>
<a name="line869">869: </a><font color="#B22222">      SNESVICheckResidual_Private(snes,snes-&gt;jacobian,F,Y,G,W);</font>
<a name="line870">870: </a><font color="#B22222">    }</font>
<a name="line871">871: </a><font color="#B22222">    */</font>
<a name="line872">872: </a>    <font color="#B22222">/* Compute a (scaled) negative update in the line search routine: </font>
<a name="line873">873: </a><font color="#B22222">         Y &lt;- X - lambda*Y </font>
<a name="line874">874: </a><font color="#B22222">       and evaluate G = function(Y) (depends on the line search). </font>
<a name="line875">875: </a><font color="#B22222">    */</font>
<a name="line876">876: </a>    <A href="../../../../docs/manualpages/Vec/VecCopy.html#VecCopy">VecCopy</A>(Y,snes-&gt;vec_sol_update);
<a name="line877">877: </a>    ynorm = 1; gnorm = vi-&gt;phinorm;
<a name="line878">878: </a>    (*vi-&gt;LineSearch)(snes,vi-&gt;lsP,X,vi-&gt;phi,G,Y,W,vi-&gt;phinorm,xnorm,&amp;ynorm,&amp;gnorm,&amp;lssucceed);
<a name="line879">879: </a>    PetscInfo4(snes,<font color="#666666">"fnorm=%18.16e, gnorm=%18.16e, ynorm=%18.16e, lssucceed=%d\n"</font>,vi-&gt;phinorm,gnorm,ynorm,(int)lssucceed);
<a name="line880">880: </a>    <font color="#4169E1">if</font> (snes-&gt;reason == <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_FUNCTION_COUNT.html#SNES_DIVERGED_FUNCTION_COUNT">SNES_DIVERGED_FUNCTION_COUNT</A>) <font color="#4169E1">break</font>;
<a name="line881">881: </a>    <font color="#4169E1">if</font> (snes-&gt;domainerror) {
<a name="line882">882: </a>      snes-&gt;reason = SNES_DIVERGED_FUNCTION_DOMAIN;
<a name="line883">883: </a>      snes-&gt;ops-&gt;computefunction = vi-&gt;computeuserfunction;
<a name="line884">884: </a>      <font color="#4169E1">return</font>(0);
<a name="line885">885: </a>    }
<a name="line886">886: </a>    <font color="#4169E1">if</font> (!lssucceed) {
<a name="line887">887: </a>      <font color="#4169E1">if</font> (++snes-&gt;numFailures &gt;= snes-&gt;maxFailures) {
<a name="line888">888: </a>        <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A> ismin;
<a name="line889">889: </a>        snes-&gt;reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_LINE_SEARCH.html#SNES_DIVERGED_LINE_SEARCH">SNES_DIVERGED_LINE_SEARCH</A>;
<a name="line890">890: </a>        SNESVICheckLocalMin_Private(snes,snes-&gt;jacobian,G,W,gnorm,&amp;ismin);
<a name="line891">891: </a>        <font color="#4169E1">if</font> (ismin) snes-&gt;reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_LOCAL_MIN.html#SNES_DIVERGED_LOCAL_MIN">SNES_DIVERGED_LOCAL_MIN</A>;
<a name="line892">892: </a>        <font color="#4169E1">break</font>;
<a name="line893">893: </a>      }
<a name="line894">894: </a>    }
<a name="line895">895: </a>    <font color="#B22222">/* Update function and solution vectors */</font>
<a name="line896">896: </a>    vi-&gt;phinorm = gnorm;
<a name="line897">897: </a>    vi-&gt;merit = 0.5*vi-&gt;phinorm*vi-&gt;phinorm;
<a name="line898">898: </a>    <A href="../../../../docs/manualpages/Vec/VecCopy.html#VecCopy">VecCopy</A>(G,vi-&gt;phi);
<a name="line899">899: </a>    <A href="../../../../docs/manualpages/Vec/VecCopy.html#VecCopy">VecCopy</A>(W,X);
<a name="line900">900: </a>    <font color="#B22222">/* Monitor convergence */</font>
<a name="line901">901: </a>    PetscObjectTakeAccess(snes);
<a name="line902">902: </a>    snes-&gt;iter = i+1;
<a name="line903">903: </a>    snes-&gt;norm = vi-&gt;phinorm;
<a name="line904">904: </a>    PetscObjectGrantAccess(snes);
<a name="line905">905: </a>    SNESLogConvHistory(snes,snes-&gt;norm,lits);
<a name="line906">906: </a>    <A href="../../../../docs/manualpages/SNES/SNESMonitor.html#SNESMonitor">SNESMonitor</A>(snes,snes-&gt;iter,snes-&gt;norm);
<a name="line907">907: </a>    <font color="#B22222">/* Test for convergence, xnorm = || X || */</font>
<a name="line908">908: </a>    <font color="#4169E1">if</font> (snes-&gt;ops-&gt;converged != <A href="../../../../docs/manualpages/SNES/SNESSkipConverged.html#SNESSkipConverged">SNESSkipConverged</A>) { <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(X,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,&amp;xnorm); }
<a name="line909">909: </a>    (*snes-&gt;ops-&gt;converged)(snes,snes-&gt;iter,xnorm,ynorm,vi-&gt;phinorm,&amp;snes-&gt;reason,snes-&gt;cnvP);
<a name="line910">910: </a>    <font color="#4169E1">if</font> (snes-&gt;reason) <font color="#4169E1">break</font>;
<a name="line911">911: </a>  }
<a name="line912">912: </a>  <font color="#4169E1">if</font> (i == maxits) {
<a name="line913">913: </a>    PetscInfo1(snes,<font color="#666666">"Maximum number of iterations has been reached: %D\n"</font>,maxits);
<a name="line914">914: </a>    <font color="#4169E1">if</font>(!snes-&gt;reason) snes-&gt;reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_MAX_IT.html#SNES_DIVERGED_MAX_IT">SNES_DIVERGED_MAX_IT</A>;
<a name="line915">915: </a>  }
<a name="line916">916: </a>  snes-&gt;ops-&gt;computefunction = vi-&gt;computeuserfunction;
<a name="line917">917: </a>  <font color="#4169E1">return</font>(0);
<a name="line918">918: </a>}

<a name="line922">922: </a><font color="#B22222">/*</font>
<a name="line923">923: </a><font color="#B22222">   SNESVIGetActiveSetIndices - Gets the global indices for the active set variables</font>

<a name="line925">925: </a><font color="#B22222">   Input parameter</font>
<a name="line926">926: </a><font color="#B22222">.  snes - the <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> context</font>
<a name="line927">927: </a><font color="#B22222">.  X    - the snes solution vector</font>
<a name="line928">928: </a><font color="#B22222">.  F    - the nonlinear function vector</font>

<a name="line930">930: </a><font color="#B22222">   Output parameter</font>
<a name="line931">931: </a><font color="#B22222">.  ISact - active set index set</font>
<a name="line932">932: </a><font color="#B22222"> */</font>
<a name="line933">933: </a><strong><font color="#4169E1"><a name="SNESVIGetActiveSetIS"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVIGetActiveSetIS(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> X,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> F,<A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>* ISact)</font></strong>
<a name="line934">934: </a>{
<a name="line935">935: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>   ierr;
<a name="line936">936: </a>  SNES_VI          *vi = (SNES_VI*)snes-&gt;data;
<a name="line937">937: </a>  <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>               Xl=vi-&gt;xl,Xu=vi-&gt;xu;
<a name="line938">938: </a>  const <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> *x,*f,*xl,*xu;
<a name="line939">939: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>          *idx_act,i,nlocal,nloc_isact=0,ilow,ihigh,i1=0;
<a name="line940">940: </a>
<a name="line942">942: </a>  <A href="../../../../docs/manualpages/Vec/VecGetLocalSize.html#VecGetLocalSize">VecGetLocalSize</A>(X,&amp;nlocal);
<a name="line943">943: </a>  <A href="../../../../docs/manualpages/Vec/VecGetOwnershipRange.html#VecGetOwnershipRange">VecGetOwnershipRange</A>(X,&amp;ilow,&amp;ihigh);
<a name="line944">944: </a>  VecGetArrayRead(X,&amp;x);
<a name="line945">945: </a>  VecGetArrayRead(Xl,&amp;xl);
<a name="line946">946: </a>  VecGetArrayRead(Xu,&amp;xu);
<a name="line947">947: </a>  VecGetArrayRead(F,&amp;f);
<a name="line948">948: </a>  <font color="#B22222">/* Compute active set size */</font>
<a name="line949">949: </a>  <font color="#4169E1">for</font> (i=0; i &lt; nlocal;i++) {
<a name="line950">950: </a>    <font color="#4169E1">if</font> (!vi-&gt;ignorefunctionsign) {
<a name="line951">951: </a>      <font color="#4169E1">if</font> (!((PetscRealPart(x[i]) &gt; PetscRealPart(xl[i]) + 1.e-8 || (PetscRealPart(f[i]) &lt; 0.0)) &amp;&amp; ((PetscRealPart(x[i]) &lt; PetscRealPart(xu[i]) - 1.e-8) || PetscRealPart(f[i]) &gt; 0.0))) nloc_isact++;
<a name="line952">952: </a>    } <font color="#4169E1">else</font> {
<a name="line953">953: </a>      <font color="#4169E1">if</font> (!(PetscRealPart(x[i]) &gt; PetscRealPart(xl[i]) + 1.e-8  &amp;&amp; PetscRealPart(x[i]) &lt; PetscRealPart(xu[i]) - 1.e-8)) nloc_isact++;
<a name="line954">954: </a>    }
<a name="line955">955: </a>  }

<a name="line957">957: </a>  <A href="../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>(nloc_isact*<font color="#4169E1">sizeof</font>(<A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>),&amp;idx_act);

<a name="line959">959: </a>  <font color="#B22222">/* Set active set indices */</font>
<a name="line960">960: </a>  <font color="#4169E1">for</font>(i=0; i &lt; nlocal; i++) {
<a name="line961">961: </a>    <font color="#4169E1">if</font> (!vi-&gt;ignorefunctionsign) {
<a name="line962">962: </a>      <font color="#4169E1">if</font> (!((PetscRealPart(x[i]) &gt; PetscRealPart(xl[i]) + 1.e-8 || (PetscRealPart(f[i]) &lt; 0.0)) &amp;&amp; ((PetscRealPart(x[i]) &lt; PetscRealPart(xu[i]) - 1.e-8) || PetscRealPart(f[i]) &gt; 0.0))) idx_act[i1++] = ilow+i;
<a name="line963">963: </a>    } <font color="#4169E1">else</font> {
<a name="line964">964: </a>      <font color="#4169E1">if</font> (!(PetscRealPart(x[i]) &gt; PetscRealPart(xl[i]) + 1.e-8  &amp;&amp; PetscRealPart(x[i]) &lt; PetscRealPart(xu[i]) - 1.e-8)) idx_act[i1++] = ilow+i;
<a name="line965">965: </a>    }
<a name="line966">966: </a>  }

<a name="line968">968: </a>   <font color="#B22222">/* Create active set <A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A> */</font>
<a name="line969">969: </a>  <A href="../../../../docs/manualpages/IS/ISCreateGeneral.html#ISCreateGeneral">ISCreateGeneral</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm,nloc_isact,idx_act,PETSC_OWN_POINTER,ISact);

<a name="line971">971: </a>  VecRestoreArrayRead(X,&amp;x);
<a name="line972">972: </a>  VecRestoreArrayRead(Xl,&amp;xl);
<a name="line973">973: </a>  VecRestoreArrayRead(Xu,&amp;xu);
<a name="line974">974: </a>  VecRestoreArrayRead(F,&amp;f);
<a name="line975">975: </a>  <font color="#4169E1">return</font>(0);
<a name="line976">976: </a>}

<a name="line980">980: </a><strong><font color="#4169E1"><a name="SNESVICreateIndexSets_RS"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVICreateIndexSets_RS(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> X,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> F,<A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>* ISact,<A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>* ISinact)</font></strong>
<a name="line981">981: </a>{
<a name="line982">982: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>     ierr;

<a name="line985">985: </a>  SNESVIGetActiveSetIS(snes,X,F,ISact);
<a name="line986">986: </a>  <A href="../../../../docs/manualpages/IS/ISComplement.html#ISComplement">ISComplement</A>(*ISact,X-&gt;map-&gt;rstart,X-&gt;map-&gt;rend,ISinact);
<a name="line987">987: </a>  <font color="#4169E1">return</font>(0);
<a name="line988">988: </a>}

<a name="line990">990: </a><font color="#B22222">/* Create active and inactive set vectors. The local size of this vector is set and petsc computes the global size */</font>
<a name="line993">993: </a><strong><font color="#4169E1"><a name="SNESVICreateSubVectors"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVICreateSubVectors(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A> n,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>* newv)</font></strong>
<a name="line994">994: </a>{
<a name="line996">996: </a>  <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>            v;

<a name="line999">999: </a>  <A href="../../../../docs/manualpages/Vec/VecCreate.html#VecCreate">VecCreate</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm,&amp;v);
<a name="line1000">1000: </a>  <A href="../../../../docs/manualpages/Vec/VecSetSizes.html#VecSetSizes">VecSetSizes</A>(v,n,<A href="../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</A>);
<a name="line1001">1001: </a>  <A href="../../../../docs/manualpages/Vec/VecSetFromOptions.html#VecSetFromOptions">VecSetFromOptions</A>(v);
<a name="line1002">1002: </a>  *newv = v;

<a name="line1004">1004: </a>  <font color="#4169E1">return</font>(0);
<a name="line1005">1005: </a>}

<a name="line1007">1007: </a><font color="#B22222">/* Resets the snes <A href="../../../../docs/manualpages/PC/PC.html#PC">PC</A> and <A href="../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</A> when the active set sizes change */</font>
<a name="line1010">1010: </a><strong><font color="#4169E1"><a name="SNESVIResetPCandKSP"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVIResetPCandKSP(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> Amat,<A href="../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> Pmat)</font></strong>
<a name="line1011">1011: </a>{
<a name="line1012">1012: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>         ierr;
<a name="line1013">1013: </a>  <A href="../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</A>                    snesksp;

<a name="line1016">1016: </a>  <A href="../../../../docs/manualpages/SNES/SNESGetKSP.html#SNESGetKSP">SNESGetKSP</A>(snes,&amp;snesksp);
<a name="line1017">1017: </a>  <A href="../../../../docs/manualpages/KSP/KSPReset.html#KSPReset">KSPReset</A>(snesksp);

<a name="line1019">1019: </a>  <font color="#B22222">/*</font>
<a name="line1020">1020: </a><font color="#B22222">  <A href="../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</A>                    kspnew;</font>
<a name="line1021">1021: </a><font color="#B22222">  <A href="../../../../docs/manualpages/PC/PC.html#PC">PC</A>                     pcnew;</font>
<a name="line1022">1022: </a><font color="#B22222">  const <A href="../../../../docs/manualpages/Mat/MatSolverPackage.html#MatSolverPackage">MatSolverPackage</A> stype;</font>


<a name="line1025">1025: </a><font color="#B22222">  <A href="../../../../docs/manualpages/KSP/KSPCreate.html#KSPCreate">KSPCreate</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm,&amp;kspnew);</font>
<a name="line1026">1026: </a><font color="#B22222">  kspnew-&gt;pc_side = snesksp-&gt;pc_side;</font>
<a name="line1027">1027: </a><font color="#B22222">  kspnew-&gt;rtol    = snesksp-&gt;rtol;</font>
<a name="line1028">1028: </a><font color="#B22222">  kspnew-&gt;abstol    = snesksp-&gt;abstol;</font>
<a name="line1029">1029: </a><font color="#B22222">  kspnew-&gt;max_it  = snesksp-&gt;max_it;</font>
<a name="line1030">1030: </a><font color="#B22222">  <A href="../../../../docs/manualpages/KSP/KSPSetType.html#KSPSetType">KSPSetType</A>(kspnew,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snesksp)-&gt;type_name);</font>
<a name="line1031">1031: </a><font color="#B22222">  <A href="../../../../docs/manualpages/KSP/KSPGetPC.html#KSPGetPC">KSPGetPC</A>(kspnew,&amp;pcnew);</font>
<a name="line1032">1032: </a><font color="#B22222">  <A href="../../../../docs/manualpages/PC/PCSetType.html#PCSetType">PCSetType</A>(kspnew-&gt;pc,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snesksp-&gt;pc)-&gt;type_name);</font>
<a name="line1033">1033: </a><font color="#B22222">  <A href="../../../../docs/manualpages/PC/PCSetOperators.html#PCSetOperators">PCSetOperators</A>(kspnew-&gt;pc,Amat,Pmat,DIFFERENT_NONZERO_PATTERN);</font>
<a name="line1034">1034: </a><font color="#B22222">  <A href="../../../../docs/manualpages/PC/PCFactorGetMatSolverPackage.html#PCFactorGetMatSolverPackage">PCFactorGetMatSolverPackage</A>(snesksp-&gt;pc,&amp;stype);</font>
<a name="line1035">1035: </a><font color="#B22222">  <A href="../../../../docs/manualpages/PC/PCFactorSetMatSolverPackage.html#PCFactorSetMatSolverPackage">PCFactorSetMatSolverPackage</A>(kspnew-&gt;pc,stype);</font>
<a name="line1036">1036: </a><font color="#B22222">  <A href="../../../../docs/manualpages/KSP/KSPDestroy.html#KSPDestroy">KSPDestroy</A>(&amp;snesksp);</font>
<a name="line1037">1037: </a><font color="#B22222">  snes-&gt;ksp = kspnew;</font>
<a name="line1038">1038: </a><font color="#B22222">  PetscLogObjectParent(snes,kspnew);</font>
<a name="line1039">1039: </a><font color="#B22222">   <A href="../../../../docs/manualpages/KSP/KSPSetFromOptions.html#KSPSetFromOptions">KSPSetFromOptions</A>(kspnew);*/</font>
<a name="line1040">1040: </a>  <font color="#4169E1">return</font>(0);
<a name="line1041">1041: </a>}


<a name="line1046">1046: </a><strong><font color="#4169E1"><a name="SNESVIComputeInactiveSetFnorm"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVIComputeInactiveSetFnorm(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> F,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> X,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> *fnorm)</font></strong>
<a name="line1047">1047: </a>{
<a name="line1048">1048: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>    ierr;
<a name="line1049">1049: </a>  SNES_VI           *vi = (SNES_VI*)snes-&gt;data;
<a name="line1050">1050: </a>  const <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> *x,*xl,*xu,*f;
<a name="line1051">1051: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>          i,n;
<a name="line1052">1052: </a>  <A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A>         rnorm;

<a name="line1055">1055: </a>  <A href="../../../../docs/manualpages/Vec/VecGetLocalSize.html#VecGetLocalSize">VecGetLocalSize</A>(X,&amp;n);
<a name="line1056">1056: </a>  VecGetArrayRead(vi-&gt;xl,&amp;xl);
<a name="line1057">1057: </a>  VecGetArrayRead(vi-&gt;xu,&amp;xu);
<a name="line1058">1058: </a>  VecGetArrayRead(X,&amp;x);
<a name="line1059">1059: </a>  VecGetArrayRead(F,&amp;f);
<a name="line1060">1060: </a>  rnorm = 0.0;
<a name="line1061">1061: </a>  <font color="#4169E1">if</font> (!vi-&gt;ignorefunctionsign) {
<a name="line1062">1062: </a>    <font color="#4169E1">for</font> (i=0; i&lt;n; i++) {
<a name="line1063">1063: </a>      <font color="#4169E1">if</font> (((PetscRealPart(x[i]) &gt; PetscRealPart(xl[i]) + 1.e-8 || (PetscRealPart(f[i]) &lt; 0.0)) &amp;&amp; ((PetscRealPart(x[i]) &lt; PetscRealPart(xu[i]) - 1.e-8) || PetscRealPart(f[i]) &gt; 0.0))) rnorm += PetscRealPart(PetscConj(f[i])*f[i]);
<a name="line1064">1064: </a>    }
<a name="line1065">1065: </a>  } <font color="#4169E1">else</font> {
<a name="line1066">1066: </a>    <font color="#4169E1">for</font> (i=0; i&lt;n; i++) {
<a name="line1067">1067: </a>      <font color="#4169E1">if</font> ((PetscRealPart(x[i]) &gt; PetscRealPart(xl[i]) + 1.e-8) &amp;&amp; (PetscRealPart(x[i]) &lt; PetscRealPart(xu[i]) - 1.e-8)) rnorm += PetscRealPart(PetscConj(f[i])*f[i]);
<a name="line1068">1068: </a>    }
<a name="line1069">1069: </a>  }
<a name="line1070">1070: </a>  VecRestoreArrayRead(F,&amp;f);
<a name="line1071">1071: </a>  VecRestoreArrayRead(vi-&gt;xl,&amp;xl);
<a name="line1072">1072: </a>  VecRestoreArrayRead(vi-&gt;xu,&amp;xu);
<a name="line1073">1073: </a>  VecRestoreArrayRead(X,&amp;x);
<a name="line1074">1074: </a>  <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Allreduce.html#MPI_Allreduce">MPI_Allreduce</A>(&amp;rnorm,fnorm,1,MPIU_REAL,MPIU_SUM,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm);
<a name="line1075">1075: </a>  *fnorm = sqrt(*fnorm);
<a name="line1076">1076: </a>  <font color="#4169E1">return</font>(0);
<a name="line1077">1077: </a>}

<a name="line1079">1079: </a><font color="#B22222">/* Variational Inequality solver using reduce space method. No semismooth algorithm is</font>
<a name="line1080">1080: </a><font color="#B22222">   implemented in this algorithm. It basically identifies the active constraints and does</font>
<a name="line1081">1081: </a><font color="#B22222">   a linear solve on the other variables (those not associated with the active constraints). */</font>
<a name="line1084">1084: </a><strong><font color="#4169E1"><a name="SNESSolveVI_RS"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESSolveVI_RS(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes)</font></strong>
<a name="line1085">1085: </a>{
<a name="line1086">1086: </a>  SNES_VI          *vi = (SNES_VI*)snes-&gt;data;
<a name="line1087">1087: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>    ierr;
<a name="line1088">1088: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>          maxits,i,lits;
<a name="line1089">1089: </a>  <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A>         lssucceed;
<a name="line1090">1090: </a>  <A href="../../../../docs/manualpages/Mat/MatStructure.html#MatStructure">MatStructure</A>      flg = DIFFERENT_NONZERO_PATTERN;
<a name="line1091">1091: </a>  <A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A>         fnorm,gnorm,xnorm=0,ynorm;
<a name="line1092">1092: </a>  <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>                Y,X,F,G,W;
<a name="line1093">1093: </a>  <A href="../../../../docs/manualpages/KSP/KSPConvergedReason.html#KSPConvergedReason">KSPConvergedReason</A> kspreason;

<a name="line1096">1096: </a>  snes-&gt;numFailures            = 0;
<a name="line1097">1097: </a>  snes-&gt;numLinearSolveFailures = 0;
<a name="line1098">1098: </a>  snes-&gt;reason                 = SNES_CONVERGED_ITERATING;

<a name="line1100">1100: </a>  maxits        = snes-&gt;max_its;        <font color="#B22222">/* maximum number of iterations */</font>
<a name="line1101">1101: </a>  X                = snes-&gt;vec_sol;        <font color="#B22222">/* solution vector */</font>
<a name="line1102">1102: </a>  F                = snes-&gt;vec_func;        <font color="#B22222">/* residual vector */</font>
<a name="line1103">1103: </a>  Y                = snes-&gt;work[0];        <font color="#B22222">/* work vectors */</font>
<a name="line1104">1104: </a>  G                = snes-&gt;work[1];
<a name="line1105">1105: </a>  W                = snes-&gt;work[2];

<a name="line1107">1107: </a>  PetscObjectTakeAccess(snes);
<a name="line1108">1108: </a>  snes-&gt;iter = 0;
<a name="line1109">1109: </a>  snes-&gt;norm = 0.0;
<a name="line1110">1110: </a>  PetscObjectGrantAccess(snes);

<a name="line1112">1112: </a>  SNESVIProjectOntoBounds(snes,X);
<a name="line1113">1113: </a>  <A href="../../../../docs/manualpages/SNES/SNESComputeFunction.html#SNESComputeFunction">SNESComputeFunction</A>(snes,X,F);
<a name="line1114">1114: </a>  <font color="#4169E1">if</font> (snes-&gt;domainerror) {
<a name="line1115">1115: </a>    snes-&gt;reason = SNES_DIVERGED_FUNCTION_DOMAIN;
<a name="line1116">1116: </a>    <font color="#4169E1">return</font>(0);
<a name="line1117">1117: </a>  }
<a name="line1118">1118: </a>  SNESVIComputeInactiveSetFnorm(snes,F,X,&amp;fnorm);
<a name="line1119">1119: </a>  <A href="../../../../docs/manualpages/Vec/VecNormBegin.html#VecNormBegin">VecNormBegin</A>(X,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,&amp;xnorm);        <font color="#B22222">/* xnorm &lt;- ||x||  */</font>
<a name="line1120">1120: </a>  <A href="../../../../docs/manualpages/Vec/VecNormEnd.html#VecNormEnd">VecNormEnd</A>(X,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,&amp;xnorm);
<a name="line1121">1121: </a>  <font color="#4169E1">if</font> (PetscIsInfOrNanReal(fnorm)) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_FP,<font color="#666666">"User provided compute function generated a Not-a-Number"</font>);

<a name="line1123">1123: </a>  PetscObjectTakeAccess(snes);
<a name="line1124">1124: </a>  snes-&gt;norm = fnorm;
<a name="line1125">1125: </a>  PetscObjectGrantAccess(snes);
<a name="line1126">1126: </a>  SNESLogConvHistory(snes,fnorm,0);
<a name="line1127">1127: </a>  <A href="../../../../docs/manualpages/SNES/SNESMonitor.html#SNESMonitor">SNESMonitor</A>(snes,0,fnorm);

<a name="line1129">1129: </a>  <font color="#B22222">/* set parameter for default relative tolerance convergence test */</font>
<a name="line1130">1130: </a>  snes-&gt;ttol = fnorm*snes-&gt;rtol;
<a name="line1131">1131: </a>  <font color="#B22222">/* test convergence */</font>
<a name="line1132">1132: </a>  (*snes-&gt;ops-&gt;converged)(snes,0,0.0,0.0,fnorm,&amp;snes-&gt;reason,snes-&gt;cnvP);
<a name="line1133">1133: </a>  <font color="#4169E1">if</font> (snes-&gt;reason) <font color="#4169E1">return</font>(0);


<a name="line1136">1136: </a>  <font color="#4169E1">for</font> (i=0; i&lt;maxits; i++) {

<a name="line1138">1138: </a>    <A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>         IS_act,IS_inact; <font color="#B22222">/* _act -&gt; active set _inact -&gt; inactive set */</font>
<a name="line1139">1139: </a>    <A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>         IS_redact; <font color="#B22222">/* redundant active set */</font>
<a name="line1140">1140: </a>    <A href="../../../../docs/manualpages/Vec/VecScatter.html#VecScatter">VecScatter</A> scat_act,scat_inact;
<a name="line1141">1141: </a>    <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>   nis_act,nis_inact;
<a name="line1142">1142: </a>    <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>        Y_act,Y_inact,F_inact;
<a name="line1143">1143: </a>    <A href="../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A>        jac_inact_inact,prejac_inact_inact;
<a name="line1144">1144: </a>    <A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>         keptrows;
<a name="line1145">1145: </a>    <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A>  isequal;

<a name="line1147">1147: </a>    <font color="#B22222">/* Call general purpose update function */</font>
<a name="line1148">1148: </a>    <font color="#4169E1">if</font> (snes-&gt;ops-&gt;update) {
<a name="line1149">1149: </a>      (*snes-&gt;ops-&gt;update)(snes, snes-&gt;iter);
<a name="line1150">1150: </a>    }
<a name="line1151">1151: </a>    <A href="../../../../docs/manualpages/SNES/SNESComputeJacobian.html#SNESComputeJacobian">SNESComputeJacobian</A>(snes,X,&amp;snes-&gt;jacobian,&amp;snes-&gt;jacobian_pre,&amp;flg);


<a name="line1154">1154: </a>        <font color="#B22222">/* Create active and inactive index sets */</font>
<a name="line1155">1155: </a>
<a name="line1156">1156: </a>    <font color="#B22222">/*original</font>
<a name="line1157">1157: </a><font color="#B22222">    SNESVICreateIndexSets_RS(snes,X,F,&amp;IS_act,&amp;IS_inact);</font>
<a name="line1158">1158: </a><font color="#B22222">     */</font>
<a name="line1159">1159: </a>    SNESVIGetActiveSetIS(snes,X,F,&amp;IS_act);
<a name="line1160">1160: </a>
<a name="line1161">1161: </a>    <font color="#4169E1">if</font> (vi-&gt;checkredundancy) {
<a name="line1162">1162: </a>      (*vi-&gt;checkredundancy)(snes,IS_act,&amp;IS_redact,vi-&gt;ctxP);
<a name="line1163">1163: </a>      <font color="#4169E1">if</font> (IS_redact){
<a name="line1164">1164: </a>        <A href="../../../../docs/manualpages/IS/ISSort.html#ISSort">ISSort</A>(IS_redact);
<a name="line1165">1165: </a>        <A href="../../../../docs/manualpages/IS/ISComplement.html#ISComplement">ISComplement</A>(IS_redact,X-&gt;map-&gt;rstart,X-&gt;map-&gt;rend,&amp;IS_inact);
<a name="line1166">1166: </a>        <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;IS_redact);
<a name="line1167">1167: </a>      }
<a name="line1168">1168: </a>      <font color="#4169E1">else</font> {
<a name="line1169">1169: </a>        <A href="../../../../docs/manualpages/IS/ISComplement.html#ISComplement">ISComplement</A>(IS_act,X-&gt;map-&gt;rstart,X-&gt;map-&gt;rend,&amp;IS_inact);
<a name="line1170">1170: </a>      }
<a name="line1171">1171: </a>    } <font color="#4169E1">else</font> {
<a name="line1172">1172: </a>      <A href="../../../../docs/manualpages/IS/ISComplement.html#ISComplement">ISComplement</A>(IS_act,X-&gt;map-&gt;rstart,X-&gt;map-&gt;rend,&amp;IS_inact);
<a name="line1173">1173: </a>    }
<a name="line1174">1174: </a>

<a name="line1176">1176: </a>    <font color="#B22222">/* Create inactive set submatrix */</font>
<a name="line1177">1177: </a>    <A href="../../../../docs/manualpages/Mat/MatGetSubMatrix.html#MatGetSubMatrix">MatGetSubMatrix</A>(snes-&gt;jacobian,IS_inact,IS_inact,MAT_INITIAL_MATRIX,&amp;jac_inact_inact);
<a name="line1178">1178: </a>
<a name="line1179">1179: </a>    <A href="../../../../docs/manualpages/Mat/MatFindNonzeroRows.html#MatFindNonzeroRows">MatFindNonzeroRows</A>(jac_inact_inact,&amp;keptrows);
<a name="line1180">1180: </a>    <font color="#4169E1">if</font> (0 &amp;&amp; keptrows) {
<a name="line1181">1181: </a>      <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       cnt,*nrows,k;
<a name="line1182">1182: </a>      const <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A> *krows,*inact;
<a name="line1183">1183: </a>      <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       rstart=jac_inact_inact-&gt;rmap-&gt;rstart;

<a name="line1185">1185: </a>      <A href="../../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</A>(&amp;jac_inact_inact);
<a name="line1186">1186: </a>      <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;IS_act);

<a name="line1188">1188: </a>      <A href="../../../../docs/manualpages/IS/ISGetLocalSize.html#ISGetLocalSize">ISGetLocalSize</A>(keptrows,&amp;cnt);
<a name="line1189">1189: </a>      <A href="../../../../docs/manualpages/IS/ISGetIndices.html#ISGetIndices">ISGetIndices</A>(keptrows,&amp;krows);
<a name="line1190">1190: </a>      <A href="../../../../docs/manualpages/IS/ISGetIndices.html#ISGetIndices">ISGetIndices</A>(IS_inact,&amp;inact);
<a name="line1191">1191: </a>      <A href="../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>(cnt*<font color="#4169E1">sizeof</font>(<A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>),&amp;nrows);
<a name="line1192">1192: </a>      <font color="#4169E1">for</font> (k=0; k&lt;cnt; k++) {
<a name="line1193">1193: </a>        nrows[k] = inact[krows[k]-rstart];
<a name="line1194">1194: </a>      }
<a name="line1195">1195: </a>      <A href="../../../../docs/manualpages/IS/ISRestoreIndices.html#ISRestoreIndices">ISRestoreIndices</A>(keptrows,&amp;krows);
<a name="line1196">1196: </a>      <A href="../../../../docs/manualpages/IS/ISRestoreIndices.html#ISRestoreIndices">ISRestoreIndices</A>(IS_inact,&amp;inact);
<a name="line1197">1197: </a>      <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;keptrows);
<a name="line1198">1198: </a>      <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;IS_inact);
<a name="line1199">1199: </a>
<a name="line1200">1200: </a>      <A href="../../../../docs/manualpages/IS/ISCreateGeneral.html#ISCreateGeneral">ISCreateGeneral</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</A>,cnt,nrows,PETSC_OWN_POINTER,&amp;IS_inact);
<a name="line1201">1201: </a>      <A href="../../../../docs/manualpages/IS/ISComplement.html#ISComplement">ISComplement</A>(IS_inact,F-&gt;map-&gt;rstart,F-&gt;map-&gt;rend,&amp;IS_act);
<a name="line1202">1202: </a>      <A href="../../../../docs/manualpages/Mat/MatGetSubMatrix.html#MatGetSubMatrix">MatGetSubMatrix</A>(snes-&gt;jacobian,IS_inact,IS_inact,MAT_INITIAL_MATRIX,&amp;jac_inact_inact);
<a name="line1203">1203: </a>    }
<a name="line1204">1204: </a>    DMSetVI(snes-&gt;dm,IS_inact);
<a name="line1205">1205: </a>    <font color="#B22222">/* remove later */</font>

<a name="line1207">1207: </a>    <font color="#B22222">/*</font>
<a name="line1208">1208: </a><font color="#B22222">  <A href="../../../../docs/manualpages/Vec/VecView.html#VecView">VecView</A>(vi-&gt;xu,<A href="../../../../docs/manualpages/Viewer/PETSC_VIEWER_BINARY_.html#PETSC_VIEWER_BINARY_">PETSC_VIEWER_BINARY_</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</A>));</font>
<a name="line1209">1209: </a><font color="#B22222">  <A href="../../../../docs/manualpages/Vec/VecView.html#VecView">VecView</A>(vi-&gt;xl,<A href="../../../../docs/manualpages/Viewer/PETSC_VIEWER_BINARY_.html#PETSC_VIEWER_BINARY_">PETSC_VIEWER_BINARY_</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</A>));</font>
<a name="line1210">1210: </a><font color="#B22222">  <A href="../../../../docs/manualpages/Vec/VecView.html#VecView">VecView</A>(X,<A href="../../../../docs/manualpages/Viewer/PETSC_VIEWER_BINARY_.html#PETSC_VIEWER_BINARY_">PETSC_VIEWER_BINARY_</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</A>));</font>
<a name="line1211">1211: </a><font color="#B22222">  <A href="../../../../docs/manualpages/Vec/VecView.html#VecView">VecView</A>(F,<A href="../../../../docs/manualpages/Viewer/PETSC_VIEWER_BINARY_.html#PETSC_VIEWER_BINARY_">PETSC_VIEWER_BINARY_</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</A>));</font>
<a name="line1212">1212: </a><font color="#B22222">  <A href="../../../../docs/manualpages/IS/ISView.html#ISView">ISView</A>(IS_inact,<A href="../../../../docs/manualpages/Viewer/PETSC_VIEWER_BINARY_.html#PETSC_VIEWER_BINARY_">PETSC_VIEWER_BINARY_</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</A>));</font>
<a name="line1213">1213: </a><font color="#B22222">     */</font>

<a name="line1215">1215: </a>    <font color="#B22222">/* Get sizes of active and inactive sets */</font>
<a name="line1216">1216: </a>    <A href="../../../../docs/manualpages/IS/ISGetLocalSize.html#ISGetLocalSize">ISGetLocalSize</A>(IS_act,&amp;nis_act);
<a name="line1217">1217: </a>    <A href="../../../../docs/manualpages/IS/ISGetLocalSize.html#ISGetLocalSize">ISGetLocalSize</A>(IS_inact,&amp;nis_inact);

<a name="line1219">1219: </a>    <font color="#B22222">/* Create active and inactive set vectors */</font>
<a name="line1220">1220: </a>    SNESVICreateSubVectors(snes,nis_inact,&amp;F_inact);
<a name="line1221">1221: </a>    SNESVICreateSubVectors(snes,nis_act,&amp;Y_act);
<a name="line1222">1222: </a>    SNESVICreateSubVectors(snes,nis_inact,&amp;Y_inact);

<a name="line1224">1224: </a>    <font color="#B22222">/* Create scatter contexts */</font>
<a name="line1225">1225: </a>    <A href="../../../../docs/manualpages/Vec/VecScatterCreate.html#VecScatterCreate">VecScatterCreate</A>(Y,IS_act,Y_act,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>,&amp;scat_act);
<a name="line1226">1226: </a>    <A href="../../../../docs/manualpages/Vec/VecScatterCreate.html#VecScatterCreate">VecScatterCreate</A>(Y,IS_inact,Y_inact,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>,&amp;scat_inact);

<a name="line1228">1228: </a>    <font color="#B22222">/* Do a vec scatter to active and inactive set vectors */</font>
<a name="line1229">1229: </a>    <A href="../../../../docs/manualpages/Vec/VecScatterBegin.html#VecScatterBegin">VecScatterBegin</A>(scat_inact,F,F_inact,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>,<A href="../../../../docs/manualpages/Vec/SCATTER_FORWARD.html#SCATTER_FORWARD">SCATTER_FORWARD</A>);
<a name="line1230">1230: </a>    <A href="../../../../docs/manualpages/Vec/VecScatterEnd.html#VecScatterEnd">VecScatterEnd</A>(scat_inact,F,F_inact,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>,<A href="../../../../docs/manualpages/Vec/SCATTER_FORWARD.html#SCATTER_FORWARD">SCATTER_FORWARD</A>);

<a name="line1232">1232: </a>    <A href="../../../../docs/manualpages/Vec/VecScatterBegin.html#VecScatterBegin">VecScatterBegin</A>(scat_act,Y,Y_act,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>,<A href="../../../../docs/manualpages/Vec/SCATTER_FORWARD.html#SCATTER_FORWARD">SCATTER_FORWARD</A>);
<a name="line1233">1233: </a>    <A href="../../../../docs/manualpages/Vec/VecScatterEnd.html#VecScatterEnd">VecScatterEnd</A>(scat_act,Y,Y_act,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>,<A href="../../../../docs/manualpages/Vec/SCATTER_FORWARD.html#SCATTER_FORWARD">SCATTER_FORWARD</A>);

<a name="line1235">1235: </a>    <A href="../../../../docs/manualpages/Vec/VecScatterBegin.html#VecScatterBegin">VecScatterBegin</A>(scat_inact,Y,Y_inact,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>,<A href="../../../../docs/manualpages/Vec/SCATTER_FORWARD.html#SCATTER_FORWARD">SCATTER_FORWARD</A>);
<a name="line1236">1236: </a>    <A href="../../../../docs/manualpages/Vec/VecScatterEnd.html#VecScatterEnd">VecScatterEnd</A>(scat_inact,Y,Y_inact,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>,<A href="../../../../docs/manualpages/Vec/SCATTER_FORWARD.html#SCATTER_FORWARD">SCATTER_FORWARD</A>);
<a name="line1237">1237: </a>
<a name="line1238">1238: </a>    <font color="#B22222">/* Active set direction = 0 */</font>
<a name="line1239">1239: </a>    <A href="../../../../docs/manualpages/Vec/VecSet.html#VecSet">VecSet</A>(Y_act,0);
<a name="line1240">1240: </a>    <font color="#4169E1">if</font> (snes-&gt;jacobian != snes-&gt;jacobian_pre) {
<a name="line1241">1241: </a>      <A href="../../../../docs/manualpages/Mat/MatGetSubMatrix.html#MatGetSubMatrix">MatGetSubMatrix</A>(snes-&gt;jacobian_pre,IS_inact,IS_inact,MAT_INITIAL_MATRIX,&amp;prejac_inact_inact);
<a name="line1242">1242: </a>    } <font color="#4169E1">else</font> prejac_inact_inact = jac_inact_inact;

<a name="line1244">1244: </a>    <A href="../../../../docs/manualpages/IS/ISEqual.html#ISEqual">ISEqual</A>(vi-&gt;IS_inact_prev,IS_inact,&amp;isequal);
<a name="line1245">1245: </a>    <font color="#4169E1">if</font> (!isequal) {
<a name="line1246">1246: </a>      SNESVIResetPCandKSP(snes,jac_inact_inact,prejac_inact_inact);
<a name="line1247">1247: </a>      flg  = DIFFERENT_NONZERO_PATTERN;
<a name="line1248">1248: </a>    }
<a name="line1249">1249: </a>
<a name="line1250">1250: </a>    <font color="#B22222">/*      <A href="../../../../docs/manualpages/IS/ISView.html#ISView">ISView</A>(IS_inact,0); */</font>
<a name="line1251">1251: </a>    <font color="#B22222">/*      <A href="../../../../docs/manualpages/IS/ISView.html#ISView">ISView</A>(IS_act,0);*/</font>
<a name="line1252">1252: </a>    <font color="#B22222">/*      <A href="../../../../docs/manualpages/Mat/MatView.html#MatView">MatView</A>(snes-&gt;jacobian_pre,0); */</font>

<a name="line1254">1254: </a>
<a name="line1255">1255: </a>
<a name="line1256">1256: </a>    <A href="../../../../docs/manualpages/KSP/KSPSetOperators.html#KSPSetOperators">KSPSetOperators</A>(snes-&gt;ksp,jac_inact_inact,prejac_inact_inact,flg);
<a name="line1257">1257: </a>    <A href="../../../../docs/manualpages/KSP/KSPSetUp.html#KSPSetUp">KSPSetUp</A>(snes-&gt;ksp);
<a name="line1258">1258: </a>    {
<a name="line1259">1259: </a>      <A href="../../../../docs/manualpages/PC/PC.html#PC">PC</A>        pc;
<a name="line1260">1260: </a>      <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A> flg;
<a name="line1261">1261: </a>      <A href="../../../../docs/manualpages/KSP/KSPGetPC.html#KSPGetPC">KSPGetPC</A>(snes-&gt;ksp,&amp;pc);
<a name="line1262">1262: </a>      <A href="../../../../docs/manualpages/Sys/PetscTypeCompare.html#PetscTypeCompare">PetscTypeCompare</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)pc,<A href="../../../../docs/manualpages/PC/PCFIELDSPLIT.html#PCFIELDSPLIT">PCFIELDSPLIT</A>,&amp;flg);
<a name="line1263">1263: </a>      <font color="#4169E1">if</font> (flg) {
<a name="line1264">1264: </a>        <A href="../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</A>      *subksps;
<a name="line1265">1265: </a>        <A href="../../../../docs/manualpages/PC/PCFieldSplitGetSubKSP.html#PCFieldSplitGetSubKSP">PCFieldSplitGetSubKSP</A>(pc,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>,&amp;subksps);
<a name="line1266">1266: </a>        <A href="../../../../docs/manualpages/KSP/KSPGetPC.html#KSPGetPC">KSPGetPC</A>(subksps[0],&amp;pc);
<a name="line1267">1267: </a>        <A href="../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(subksps);
<a name="line1268">1268: </a>        <A href="../../../../docs/manualpages/Sys/PetscTypeCompare.html#PetscTypeCompare">PetscTypeCompare</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)pc,<A href="../../../../docs/manualpages/PC/PCBJACOBI.html#PCBJACOBI">PCBJACOBI</A>,&amp;flg);
<a name="line1269">1269: </a>        <font color="#4169E1">if</font> (flg) {
<a name="line1270">1270: </a>          <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       n,N = 101*101,j,cnts[3] = {0,0,0};
<a name="line1271">1271: </a>          const <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A> *ii;

<a name="line1273">1273: </a>          <A href="../../../../docs/manualpages/IS/ISGetSize.html#ISGetSize">ISGetSize</A>(IS_inact,&amp;n);
<a name="line1274">1274: </a>          <A href="../../../../docs/manualpages/IS/ISGetIndices.html#ISGetIndices">ISGetIndices</A>(IS_inact,&amp;ii);
<a name="line1275">1275: </a>          <font color="#4169E1">for</font> (j=0; j&lt;n; j++) {
<a name="line1276">1276: </a>            <font color="#4169E1">if</font> (ii[j] &lt; N) cnts[0]++;
<a name="line1277">1277: </a>            <font color="#4169E1">else</font> <font color="#4169E1">if</font> (ii[j] &lt; 2*N) cnts[1]++;
<a name="line1278">1278: </a>            <font color="#4169E1">else</font> <font color="#4169E1">if</font> (ii[j] &lt; 3*N) cnts[2]++;
<a name="line1279">1279: </a>          }
<a name="line1280">1280: </a>          <A href="../../../../docs/manualpages/IS/ISRestoreIndices.html#ISRestoreIndices">ISRestoreIndices</A>(IS_inact,&amp;ii);

<a name="line1282">1282: </a>          <A href="../../../../docs/manualpages/PC/PCBJacobiSetTotalBlocks.html#PCBJacobiSetTotalBlocks">PCBJacobiSetTotalBlocks</A>(pc,3,cnts);
<a name="line1283">1283: </a>        }
<a name="line1284">1284: </a>      }
<a name="line1285">1285: </a>    }

<a name="line1287">1287: </a>    SNES_KSPSolve(snes,snes-&gt;ksp,F_inact,Y_inact);
<a name="line1288">1288: </a>    <A href="../../../../docs/manualpages/KSP/KSPGetConvergedReason.html#KSPGetConvergedReason">KSPGetConvergedReason</A>(snes-&gt;ksp,&amp;kspreason);
<a name="line1289">1289: </a>    <font color="#4169E1">if</font> (kspreason &lt; 0) {
<a name="line1290">1290: </a>      <font color="#4169E1">if</font> (++snes-&gt;numLinearSolveFailures &gt;= snes-&gt;maxLinearSolveFailures) {
<a name="line1291">1291: </a>        PetscInfo2(snes,<font color="#666666">"iter=%D, number linear solve failures %D greater than current <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> allowed, stopping solve\n"</font>,snes-&gt;iter,snes-&gt;numLinearSolveFailures);
<a name="line1292">1292: </a>        snes-&gt;reason = SNES_DIVERGED_LINEAR_SOLVE;
<a name="line1293">1293: </a>        <font color="#4169E1">break</font>;
<a name="line1294">1294: </a>      }
<a name="line1295">1295: </a>     }

<a name="line1297">1297: </a>    <A href="../../../../docs/manualpages/Vec/VecScatterBegin.html#VecScatterBegin">VecScatterBegin</A>(scat_act,Y_act,Y,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>,<A href="../../../../docs/manualpages/Vec/SCATTER_REVERSE.html#SCATTER_REVERSE">SCATTER_REVERSE</A>);
<a name="line1298">1298: </a>    <A href="../../../../docs/manualpages/Vec/VecScatterEnd.html#VecScatterEnd">VecScatterEnd</A>(scat_act,Y_act,Y,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>,<A href="../../../../docs/manualpages/Vec/SCATTER_REVERSE.html#SCATTER_REVERSE">SCATTER_REVERSE</A>);
<a name="line1299">1299: </a>    <A href="../../../../docs/manualpages/Vec/VecScatterBegin.html#VecScatterBegin">VecScatterBegin</A>(scat_inact,Y_inact,Y,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>,<A href="../../../../docs/manualpages/Vec/SCATTER_REVERSE.html#SCATTER_REVERSE">SCATTER_REVERSE</A>);
<a name="line1300">1300: </a>    <A href="../../../../docs/manualpages/Vec/VecScatterEnd.html#VecScatterEnd">VecScatterEnd</A>(scat_inact,Y_inact,Y,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>,<A href="../../../../docs/manualpages/Vec/SCATTER_REVERSE.html#SCATTER_REVERSE">SCATTER_REVERSE</A>);

<a name="line1302">1302: </a>    <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;F_inact);
<a name="line1303">1303: </a>    <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;Y_act);
<a name="line1304">1304: </a>    <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;Y_inact);
<a name="line1305">1305: </a>    <A href="../../../../docs/manualpages/Vec/VecScatterDestroy.html#VecScatterDestroy">VecScatterDestroy</A>(&amp;scat_act);
<a name="line1306">1306: </a>    <A href="../../../../docs/manualpages/Vec/VecScatterDestroy.html#VecScatterDestroy">VecScatterDestroy</A>(&amp;scat_inact);
<a name="line1307">1307: </a>    <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;IS_act);
<a name="line1308">1308: </a>    <font color="#4169E1">if</font> (!isequal) {
<a name="line1309">1309: </a>      <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;vi-&gt;IS_inact_prev);
<a name="line1310">1310: </a>      <A href="../../../../docs/manualpages/IS/ISDuplicate.html#ISDuplicate">ISDuplicate</A>(IS_inact,&amp;vi-&gt;IS_inact_prev);
<a name="line1311">1311: </a>    }
<a name="line1312">1312: </a>    <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;IS_inact);
<a name="line1313">1313: </a>    <A href="../../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</A>(&amp;jac_inact_inact);
<a name="line1314">1314: </a>    <font color="#4169E1">if</font> (snes-&gt;jacobian != snes-&gt;jacobian_pre) {
<a name="line1315">1315: </a>      <A href="../../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</A>(&amp;prejac_inact_inact);
<a name="line1316">1316: </a>    }
<a name="line1317">1317: </a>    <A href="../../../../docs/manualpages/KSP/KSPGetIterationNumber.html#KSPGetIterationNumber">KSPGetIterationNumber</A>(snes-&gt;ksp,&amp;lits);
<a name="line1318">1318: </a>    snes-&gt;linear_its += lits;
<a name="line1319">1319: </a>    PetscInfo2(snes,<font color="#666666">"iter=%D, linear solve iterations=%D\n"</font>,snes-&gt;iter,lits);
<a name="line1320">1320: </a>    <font color="#B22222">/*</font>
<a name="line1321">1321: </a><font color="#B22222">    if (vi-&gt;precheckstep) {</font>
<a name="line1322">1322: </a><font color="#B22222">      <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A> changed_y = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;</font>
<a name="line1323">1323: </a><font color="#B22222">      (*vi-&gt;precheckstep)(snes,X,Y,vi-&gt;precheck,&amp;changed_y);</font>
<a name="line1324">1324: </a><font color="#B22222">    }</font>

<a name="line1326">1326: </a><font color="#B22222">    if (PetscLogPrintInfo){</font>
<a name="line1327">1327: </a><font color="#B22222">      SNESVICheckResidual_Private(snes,snes-&gt;jacobian,F,Y,G,W);</font>
<a name="line1328">1328: </a><font color="#B22222">    }</font>
<a name="line1329">1329: </a><font color="#B22222">    */</font>
<a name="line1330">1330: </a>    <font color="#B22222">/* Compute a (scaled) negative update in the line search routine: </font>
<a name="line1331">1331: </a><font color="#B22222">         Y &lt;- X - lambda*Y </font>
<a name="line1332">1332: </a><font color="#B22222">       and evaluate G = function(Y) (depends on the line search). </font>
<a name="line1333">1333: </a><font color="#B22222">    */</font>
<a name="line1334">1334: </a>    <A href="../../../../docs/manualpages/Vec/VecCopy.html#VecCopy">VecCopy</A>(Y,snes-&gt;vec_sol_update);
<a name="line1335">1335: </a>    ynorm = 1; gnorm = fnorm;
<a name="line1336">1336: </a>    (*vi-&gt;LineSearch)(snes,vi-&gt;lsP,X,F,G,Y,W,fnorm,xnorm,&amp;ynorm,&amp;gnorm,&amp;lssucceed);
<a name="line1337">1337: </a>    PetscInfo4(snes,<font color="#666666">"fnorm=%18.16e, gnorm=%18.16e, ynorm=%18.16e, lssucceed=%d\n"</font>,fnorm,gnorm,ynorm,(int)lssucceed);
<a name="line1338">1338: </a>    <font color="#4169E1">if</font> (snes-&gt;reason == <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_FUNCTION_COUNT.html#SNES_DIVERGED_FUNCTION_COUNT">SNES_DIVERGED_FUNCTION_COUNT</A>) <font color="#4169E1">break</font>;
<a name="line1339">1339: </a>    <font color="#4169E1">if</font> (snes-&gt;domainerror) {
<a name="line1340">1340: </a>      snes-&gt;reason = SNES_DIVERGED_FUNCTION_DOMAIN;
<a name="line1341">1341: </a>      DMDestroyVI(snes-&gt;dm);
<a name="line1342">1342: </a>      <font color="#4169E1">return</font>(0);
<a name="line1343">1343: </a>    }
<a name="line1344">1344: </a>    <font color="#4169E1">if</font> (!lssucceed) {
<a name="line1345">1345: </a>      <font color="#4169E1">if</font> (++snes-&gt;numFailures &gt;= snes-&gt;maxFailures) {
<a name="line1346">1346: </a>        <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A> ismin;
<a name="line1347">1347: </a>        snes-&gt;reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_LINE_SEARCH.html#SNES_DIVERGED_LINE_SEARCH">SNES_DIVERGED_LINE_SEARCH</A>;
<a name="line1348">1348: </a>        SNESVICheckLocalMin_Private(snes,snes-&gt;jacobian,G,W,gnorm,&amp;ismin);
<a name="line1349">1349: </a>        <font color="#4169E1">if</font> (ismin) snes-&gt;reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_LOCAL_MIN.html#SNES_DIVERGED_LOCAL_MIN">SNES_DIVERGED_LOCAL_MIN</A>;
<a name="line1350">1350: </a>        <font color="#4169E1">break</font>;
<a name="line1351">1351: </a>      }
<a name="line1352">1352: </a>    }
<a name="line1353">1353: </a>    <font color="#B22222">/* Update function and solution vectors */</font>
<a name="line1354">1354: </a>    fnorm = gnorm;
<a name="line1355">1355: </a>    <A href="../../../../docs/manualpages/Vec/VecCopy.html#VecCopy">VecCopy</A>(G,F);
<a name="line1356">1356: </a>    <A href="../../../../docs/manualpages/Vec/VecCopy.html#VecCopy">VecCopy</A>(W,X);
<a name="line1357">1357: </a>    <font color="#B22222">/* Monitor convergence */</font>
<a name="line1358">1358: </a>    PetscObjectTakeAccess(snes);
<a name="line1359">1359: </a>    snes-&gt;iter = i+1;
<a name="line1360">1360: </a>    snes-&gt;norm = fnorm;
<a name="line1361">1361: </a>    PetscObjectGrantAccess(snes);
<a name="line1362">1362: </a>    SNESLogConvHistory(snes,snes-&gt;norm,lits);
<a name="line1363">1363: </a>    <A href="../../../../docs/manualpages/SNES/SNESMonitor.html#SNESMonitor">SNESMonitor</A>(snes,snes-&gt;iter,snes-&gt;norm);
<a name="line1364">1364: </a>    <font color="#B22222">/* Test for convergence, xnorm = || X || */</font>
<a name="line1365">1365: </a>    <font color="#4169E1">if</font> (snes-&gt;ops-&gt;converged != <A href="../../../../docs/manualpages/SNES/SNESSkipConverged.html#SNESSkipConverged">SNESSkipConverged</A>) { <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(X,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,&amp;xnorm); }
<a name="line1366">1366: </a>    (*snes-&gt;ops-&gt;converged)(snes,snes-&gt;iter,xnorm,ynorm,fnorm,&amp;snes-&gt;reason,snes-&gt;cnvP);
<a name="line1367">1367: </a>    <font color="#4169E1">if</font> (snes-&gt;reason) <font color="#4169E1">break</font>;
<a name="line1368">1368: </a>  }
<a name="line1369">1369: </a>  DMDestroyVI(snes-&gt;dm);
<a name="line1370">1370: </a>  <font color="#4169E1">if</font> (i == maxits) {
<a name="line1371">1371: </a>    PetscInfo1(snes,<font color="#666666">"Maximum number of iterations has been reached: %D\n"</font>,maxits);
<a name="line1372">1372: </a>    <font color="#4169E1">if</font>(!snes-&gt;reason) snes-&gt;reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_MAX_IT.html#SNES_DIVERGED_MAX_IT">SNES_DIVERGED_MAX_IT</A>;
<a name="line1373">1373: </a>  }
<a name="line1374">1374: </a>  <font color="#4169E1">return</font>(0);
<a name="line1375">1375: </a>}

<a name="line1379">1379: </a><strong><font color="#4169E1"><a name="SNESVISetRedundancyCheck"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVISetRedundancyCheck(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> (*func)(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A>,<A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>,<A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>*,void*),void *ctx)</font></strong>
<a name="line1380">1380: </a>{
<a name="line1381">1381: </a>  SNES_VI         *vi = (SNES_VI*)snes-&gt;data;

<a name="line1385">1385: </a>  vi-&gt;checkredundancy = func;
<a name="line1386">1386: </a>  vi-&gt;ctxP            = ctx;
<a name="line1387">1387: </a>  <font color="#4169E1">return</font>(0);
<a name="line1388">1388: </a>}

<a name="line1390">1390: </a><font color="#A020F0">#if defined(PETSC_HAVE_MATLAB_ENGINE)</font>
<a name="line1391">1391: </a><font color="#A020F0">#include &lt;engine.h&gt;</font>
<a name="line1392">1392: </a><font color="#A020F0">#include &lt;mex.h&gt;</font>
<a name="line1393">1393: </a><font color="#4169E1">typedef struct {char *funcname;</font> mxArray *ctx;} SNESMatlabContext;

<a name="line1397">1397: </a><strong><font color="#4169E1"><a name="SNESVIRedundancyCheck_Matlab"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVIRedundancyCheck_Matlab(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A> is_act,<A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>* is_redact,void* ctx)</font></strong>
<a name="line1398">1398: </a>{
<a name="line1399">1399: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>      ierr;
<a name="line1400">1400: </a>  SNESMatlabContext   *sctx = (SNESMatlabContext*)ctx;
<a name="line1401">1401: </a>  int                 nlhs = 1, nrhs = 5;
<a name="line1402">1402: </a>  mxArray             *plhs[1], *prhs[5];
<a name="line1403">1403: </a>  long long int       l1 = 0, l2 = 0, ls = 0;
<a name="line1404">1404: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>            *indices=<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>;


<a name="line1412">1412: </a>  <font color="#B22222">/* Create <A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A> for reduced active set of size 0, its size and indices will</font>
<a name="line1413">1413: </a><font color="#B22222">   bet set by the Matlab function */</font>
<a name="line1414">1414: </a>  <A href="../../../../docs/manualpages/IS/ISCreateGeneral.html#ISCreateGeneral">ISCreateGeneral</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm,0,indices,PETSC_OWN_POINTER,is_redact);
<a name="line1415">1415: </a>  <font color="#B22222">/* call Matlab function in ctx */</font>
<a name="line1416">1416: </a>  <A href="../../../../docs/manualpages/Sys/PetscMemcpy.html#PetscMemcpy">PetscMemcpy</A>(&amp;ls,&amp;snes,<font color="#4169E1">sizeof</font>(snes));
<a name="line1417">1417: </a>  <A href="../../../../docs/manualpages/Sys/PetscMemcpy.html#PetscMemcpy">PetscMemcpy</A>(&amp;l1,&amp;is_act,<font color="#4169E1">sizeof</font>(is_act));
<a name="line1418">1418: </a>  <A href="../../../../docs/manualpages/Sys/PetscMemcpy.html#PetscMemcpy">PetscMemcpy</A>(&amp;l2,is_redact,<font color="#4169E1">sizeof</font>(is_act));
<a name="line1419">1419: </a>  prhs[0] = mxCreateDoubleScalar((double)ls);
<a name="line1420">1420: </a>  prhs[1] = mxCreateDoubleScalar((double)l1);
<a name="line1421">1421: </a>  prhs[2] = mxCreateDoubleScalar((double)l2);
<a name="line1422">1422: </a>  prhs[3] = mxCreateString(sctx-&gt;funcname);
<a name="line1423">1423: </a>  prhs[4] = sctx-&gt;ctx;
<a name="line1424">1424: </a>  mexCallMATLAB(nlhs,plhs,nrhs,prhs,<font color="#666666">"PetscSNESVIRedundancyCheckInternal"</font>);
<a name="line1425">1425: </a>  mxGetScalar(plhs[0]);
<a name="line1426">1426: </a>  mxDestroyArray(prhs[0]);
<a name="line1427">1427: </a>  mxDestroyArray(prhs[1]);
<a name="line1428">1428: </a>  mxDestroyArray(prhs[2]);
<a name="line1429">1429: </a>  mxDestroyArray(prhs[3]);
<a name="line1430">1430: </a>  mxDestroyArray(plhs[0]);
<a name="line1431">1431: </a>  <font color="#4169E1">return</font>(0);
<a name="line1432">1432: </a>}

<a name="line1436">1436: </a><strong><font color="#4169E1"><a name="SNESVISetRedundancyCheckMatlab"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVISetRedundancyCheckMatlab(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,const char* func,mxArray* ctx)</font></strong>
<a name="line1437">1437: </a>{
<a name="line1438">1438: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>      ierr;
<a name="line1439">1439: </a>  SNESMatlabContext   *sctx;

<a name="line1442">1442: </a>  <font color="#B22222">/* currently sctx is memory bleed */</font>
<a name="line1443">1443: </a>  <A href="../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>(<font color="#4169E1">sizeof</font>(SNESMatlabContext),&amp;sctx);
<a name="line1444">1444: </a>  <A href="../../../../docs/manualpages/Sys/PetscStrallocpy.html#PetscStrallocpy">PetscStrallocpy</A>(func,&amp;sctx-&gt;funcname);
<a name="line1445">1445: </a>  sctx-&gt;ctx = mxDuplicateArray(ctx);
<a name="line1446">1446: </a>  SNESVISetRedundancyCheck(snes,SNESVIRedundancyCheck_Matlab,sctx);
<a name="line1447">1447: </a>  <font color="#4169E1">return</font>(0);
<a name="line1448">1448: </a>}
<a name="line1449">1449: </a>
<a name="line1450">1450: </a><font color="#A020F0">#endif</font>


<a name="line1453">1453: </a><font color="#B22222">/* Variational Inequality solver using augmented space method. It does the opposite of the</font>
<a name="line1454">1454: </a><font color="#B22222">   reduced space method i.e. it identifies the active set variables and instead of discarding</font>
<a name="line1455">1455: </a><font color="#B22222">   them it augments the original system by introducing additional equality </font>
<a name="line1456">1456: </a><font color="#B22222">   constraint equations for active set variables. The user can optionally provide an <A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A> for </font>
<a name="line1457">1457: </a><font color="#B22222">   a subset of 'redundant' active set variables which will treated as free variables.</font>
<a name="line1458">1458: </a><font color="#B22222">   Specific implementation for Allen-Cahn problem </font>
<a name="line1459">1459: </a><font color="#B22222">*/</font>
<a name="line1462">1462: </a><strong><font color="#4169E1"><a name="SNESSolveVI_RSAUG"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESSolveVI_RSAUG(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes)</font></strong>
<a name="line1463">1463: </a>{
<a name="line1464">1464: </a>  SNES_VI          *vi = (SNES_VI*)snes-&gt;data;
<a name="line1465">1465: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>    ierr;
<a name="line1466">1466: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>          maxits,i,lits;
<a name="line1467">1467: </a>  <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A>         lssucceed;
<a name="line1468">1468: </a>  <A href="../../../../docs/manualpages/Mat/MatStructure.html#MatStructure">MatStructure</A>      flg = DIFFERENT_NONZERO_PATTERN;
<a name="line1469">1469: </a>  <A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A>         fnorm,gnorm,xnorm=0,ynorm;
<a name="line1470">1470: </a>  <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>                Y,X,F,G,W;
<a name="line1471">1471: </a>  <A href="../../../../docs/manualpages/KSP/KSPConvergedReason.html#KSPConvergedReason">KSPConvergedReason</A> kspreason;

<a name="line1474">1474: </a>  snes-&gt;numFailures            = 0;
<a name="line1475">1475: </a>  snes-&gt;numLinearSolveFailures = 0;
<a name="line1476">1476: </a>  snes-&gt;reason                 = SNES_CONVERGED_ITERATING;

<a name="line1478">1478: </a>  maxits        = snes-&gt;max_its;        <font color="#B22222">/* maximum number of iterations */</font>
<a name="line1479">1479: </a>  X                = snes-&gt;vec_sol;        <font color="#B22222">/* solution vector */</font>
<a name="line1480">1480: </a>  F                = snes-&gt;vec_func;        <font color="#B22222">/* residual vector */</font>
<a name="line1481">1481: </a>  Y                = snes-&gt;work[0];        <font color="#B22222">/* work vectors */</font>
<a name="line1482">1482: </a>  G                = snes-&gt;work[1];
<a name="line1483">1483: </a>  W                = snes-&gt;work[2];

<a name="line1485">1485: </a>  PetscObjectTakeAccess(snes);
<a name="line1486">1486: </a>  snes-&gt;iter = 0;
<a name="line1487">1487: </a>  snes-&gt;norm = 0.0;
<a name="line1488">1488: </a>  PetscObjectGrantAccess(snes);

<a name="line1490">1490: </a>  SNESVIProjectOntoBounds(snes,X);
<a name="line1491">1491: </a>  <A href="../../../../docs/manualpages/SNES/SNESComputeFunction.html#SNESComputeFunction">SNESComputeFunction</A>(snes,X,F);
<a name="line1492">1492: </a>  <font color="#4169E1">if</font> (snes-&gt;domainerror) {
<a name="line1493">1493: </a>    snes-&gt;reason = SNES_DIVERGED_FUNCTION_DOMAIN;
<a name="line1494">1494: </a>    <font color="#4169E1">return</font>(0);
<a name="line1495">1495: </a>  }
<a name="line1496">1496: </a>  SNESVIComputeInactiveSetFnorm(snes,F,X,&amp;fnorm);
<a name="line1497">1497: </a>  <A href="../../../../docs/manualpages/Vec/VecNormBegin.html#VecNormBegin">VecNormBegin</A>(X,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,&amp;xnorm);        <font color="#B22222">/* xnorm &lt;- ||x||  */</font>
<a name="line1498">1498: </a>  <A href="../../../../docs/manualpages/Vec/VecNormEnd.html#VecNormEnd">VecNormEnd</A>(X,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,&amp;xnorm);
<a name="line1499">1499: </a>  <font color="#4169E1">if</font> (PetscIsInfOrNanReal(fnorm)) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_FP,<font color="#666666">"User provided compute function generated a Not-a-Number"</font>);

<a name="line1501">1501: </a>  PetscObjectTakeAccess(snes);
<a name="line1502">1502: </a>  snes-&gt;norm = fnorm;
<a name="line1503">1503: </a>  PetscObjectGrantAccess(snes);
<a name="line1504">1504: </a>  SNESLogConvHistory(snes,fnorm,0);
<a name="line1505">1505: </a>  <A href="../../../../docs/manualpages/SNES/SNESMonitor.html#SNESMonitor">SNESMonitor</A>(snes,0,fnorm);

<a name="line1507">1507: </a>  <font color="#B22222">/* set parameter for default relative tolerance convergence test */</font>
<a name="line1508">1508: </a>  snes-&gt;ttol = fnorm*snes-&gt;rtol;
<a name="line1509">1509: </a>  <font color="#B22222">/* test convergence */</font>
<a name="line1510">1510: </a>  (*snes-&gt;ops-&gt;converged)(snes,0,0.0,0.0,fnorm,&amp;snes-&gt;reason,snes-&gt;cnvP);
<a name="line1511">1511: </a>  <font color="#4169E1">if</font> (snes-&gt;reason) <font color="#4169E1">return</font>(0);

<a name="line1513">1513: </a>  <font color="#4169E1">for</font> (i=0; i&lt;maxits; i++) {
<a name="line1514">1514: </a>    <A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>             IS_act,IS_inact; <font color="#B22222">/* _act -&gt; active set _inact -&gt; inactive set */</font>
<a name="line1515">1515: </a>    <A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>             IS_redact; <font color="#B22222">/* redundant active set */</font>
<a name="line1516">1516: </a>    <A href="../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A>            J_aug,Jpre_aug;
<a name="line1517">1517: </a>    <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>            F_aug,Y_aug;
<a name="line1518">1518: </a>    <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       nis_redact,nis_act;
<a name="line1519">1519: </a>    const <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A> *idx_redact,*idx_act;
<a name="line1520">1520: </a>    <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       k;
<a name="line1521">1521: </a>    <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       *idx_actkept=<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>,nkept=0; <font color="#B22222">/* list of kept active set */</font>
<a name="line1522">1522: </a>    <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>    *f,*f2;
<a name="line1523">1523: </a>    <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A>      isequal;
<a name="line1524">1524: </a>    <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       i1=0,j1=0;

<a name="line1526">1526: </a>    <font color="#B22222">/* Call general purpose update function */</font>
<a name="line1527">1527: </a>    <font color="#4169E1">if</font> (snes-&gt;ops-&gt;update) {
<a name="line1528">1528: </a>      (*snes-&gt;ops-&gt;update)(snes, snes-&gt;iter);
<a name="line1529">1529: </a>    }
<a name="line1530">1530: </a>    <A href="../../../../docs/manualpages/SNES/SNESComputeJacobian.html#SNESComputeJacobian">SNESComputeJacobian</A>(snes,X,&amp;snes-&gt;jacobian,&amp;snes-&gt;jacobian_pre,&amp;flg);

<a name="line1532">1532: </a>    <font color="#B22222">/* Create active and inactive index sets */</font>
<a name="line1533">1533: </a>    SNESVICreateIndexSets_RS(snes,X,F,&amp;IS_act,&amp;IS_inact);

<a name="line1535">1535: </a>    <font color="#B22222">/* Get local active set size */</font>
<a name="line1536">1536: </a>    <A href="../../../../docs/manualpages/IS/ISGetLocalSize.html#ISGetLocalSize">ISGetLocalSize</A>(IS_act,&amp;nis_act);
<a name="line1537">1537: </a>    <font color="#4169E1">if</font> (nis_act) {
<a name="line1538">1538: </a>      <A href="../../../../docs/manualpages/IS/ISGetIndices.html#ISGetIndices">ISGetIndices</A>(IS_act,&amp;idx_act);
<a name="line1539">1539: </a>      IS_redact  = <A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>;
<a name="line1540">1540: </a>      <font color="#4169E1">if</font>(vi-&gt;checkredundancy) {
<a name="line1541">1541: </a>        (*vi-&gt;checkredundancy)(snes,IS_act,&amp;IS_redact,vi-&gt;ctxP);
<a name="line1542">1542: </a>      }

<a name="line1544">1544: </a>      <font color="#4169E1">if</font>(!IS_redact) {
<a name="line1545">1545: </a>        <font color="#B22222">/* User called checkredundancy function but didn't create IS_redact because</font>
<a name="line1546">1546: </a><font color="#B22222">           there were no redundant active set variables */</font>
<a name="line1547">1547: </a>        <font color="#B22222">/* Copy over all active set indices to the list */</font>
<a name="line1548">1548: </a>        <A href="../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>(nis_act*<font color="#4169E1">sizeof</font>(<A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>),&amp;idx_actkept);
<a name="line1549">1549: </a>        <font color="#4169E1">for</font>(k=0;k &lt; nis_act;k++) idx_actkept[k] = idx_act[k];
<a name="line1550">1550: </a>        nkept = nis_act;
<a name="line1551">1551: </a>      } <font color="#4169E1">else</font> {
<a name="line1552">1552: </a>        <A href="../../../../docs/manualpages/IS/ISGetLocalSize.html#ISGetLocalSize">ISGetLocalSize</A>(IS_redact,&amp;nis_redact);
<a name="line1553">1553: </a>        <A href="../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((nis_act-nis_redact)*<font color="#4169E1">sizeof</font>(<A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>),&amp;idx_actkept);

<a name="line1555">1555: </a>        <font color="#B22222">/* Create reduced active set list */</font>
<a name="line1556">1556: </a>        <A href="../../../../docs/manualpages/IS/ISGetIndices.html#ISGetIndices">ISGetIndices</A>(IS_act,&amp;idx_act);
<a name="line1557">1557: </a>        <A href="../../../../docs/manualpages/IS/ISGetIndices.html#ISGetIndices">ISGetIndices</A>(IS_redact,&amp;idx_redact);
<a name="line1558">1558: </a>        j1 = 0;nkept = 0;
<a name="line1559">1559: </a>        <font color="#4169E1">for</font>(k=0;k&lt;nis_act;k++) {
<a name="line1560">1560: </a>          <font color="#4169E1">if</font>(j1 &lt; nis_redact &amp;&amp; idx_act[k] == idx_redact[j1]) j1++;
<a name="line1561">1561: </a>          <font color="#4169E1">else</font> idx_actkept[nkept++] = idx_act[k];
<a name="line1562">1562: </a>        }
<a name="line1563">1563: </a>        <A href="../../../../docs/manualpages/IS/ISRestoreIndices.html#ISRestoreIndices">ISRestoreIndices</A>(IS_act,&amp;idx_act);
<a name="line1564">1564: </a>        <A href="../../../../docs/manualpages/IS/ISRestoreIndices.html#ISRestoreIndices">ISRestoreIndices</A>(IS_redact,&amp;idx_redact);

<a name="line1566">1566: </a>        <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;IS_redact);
<a name="line1567">1567: </a>      }

<a name="line1569">1569: </a>      <font color="#B22222">/* Create augmented F and Y */</font>
<a name="line1570">1570: </a>      <A href="../../../../docs/manualpages/Vec/VecCreate.html#VecCreate">VecCreate</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm,&amp;F_aug);
<a name="line1571">1571: </a>      <A href="../../../../docs/manualpages/Vec/VecSetSizes.html#VecSetSizes">VecSetSizes</A>(F_aug,F-&gt;map-&gt;n+nkept,<A href="../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</A>);
<a name="line1572">1572: </a>      <A href="../../../../docs/manualpages/Vec/VecSetFromOptions.html#VecSetFromOptions">VecSetFromOptions</A>(F_aug);
<a name="line1573">1573: </a>      <A href="../../../../docs/manualpages/Vec/VecDuplicate.html#VecDuplicate">VecDuplicate</A>(F_aug,&amp;Y_aug);
<a name="line1574">1574: </a>
<a name="line1575">1575: </a>      <font color="#B22222">/* Copy over F to F_aug in the first n locations */</font>
<a name="line1576">1576: </a>      <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(F,&amp;f);
<a name="line1577">1577: </a>      <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(F_aug,&amp;f2);
<a name="line1578">1578: </a>      <A href="../../../../docs/manualpages/Sys/PetscMemcpy.html#PetscMemcpy">PetscMemcpy</A>(f2,f,F-&gt;map-&gt;n*<font color="#4169E1">sizeof</font>(<A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>));
<a name="line1579">1579: </a>      <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(F,&amp;f);
<a name="line1580">1580: </a>      <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(F_aug,&amp;f2);
<a name="line1581">1581: </a>
<a name="line1582">1582: </a>      <font color="#B22222">/* Create the augmented jacobian matrix */</font>
<a name="line1583">1583: </a>      <A href="../../../../docs/manualpages/Mat/MatCreate.html#MatCreate">MatCreate</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm,&amp;J_aug);
<a name="line1584">1584: </a>      <A href="../../../../docs/manualpages/Mat/MatSetSizes.html#MatSetSizes">MatSetSizes</A>(J_aug,X-&gt;map-&gt;n+nkept,X-&gt;map-&gt;n+nkept,<A href="../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</A>,<A href="../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</A>);
<a name="line1585">1585: </a>      <A href="../../../../docs/manualpages/Mat/MatSetFromOptions.html#MatSetFromOptions">MatSetFromOptions</A>(J_aug);
<a name="line1586">1586: </a>

<a name="line1588">1588: </a>      { <font color="#B22222">/* local vars */</font>
<a name="line1589">1589: </a>      <font color="#B22222">/* Preallocate augmented matrix and set values in it...Doing only sequential case first*/</font>
<a name="line1590">1590: </a>      <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>          ncols;
<a name="line1591">1591: </a>      const <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>    *cols;
<a name="line1592">1592: </a>      const <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> *vals;
<a name="line1593">1593: </a>      <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>        value[2];
<a name="line1594">1594: </a>      <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>           row,col[2];
<a name="line1595">1595: </a>      <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>           *d_nnz;
<a name="line1596">1596: </a>      value[0] = 1.0; value[1] = 0.0;
<a name="line1597">1597: </a>      <A href="../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((X-&gt;map-&gt;n+nkept)*<font color="#4169E1">sizeof</font>(<A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>),&amp;d_nnz);
<a name="line1598">1598: </a>      <A href="../../../../docs/manualpages/Sys/PetscMemzero.html#PetscMemzero">PetscMemzero</A>(d_nnz,(X-&gt;map-&gt;n+nkept)*<font color="#4169E1">sizeof</font>(<A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>));
<a name="line1599">1599: </a>      <font color="#4169E1">for</font>(row=0;row&lt;snes-&gt;jacobian-&gt;rmap-&gt;n;row++) {
<a name="line1600">1600: </a>        <A href="../../../../docs/manualpages/Mat/MatGetRow.html#MatGetRow">MatGetRow</A>(snes-&gt;jacobian,row,&amp;ncols,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line1601">1601: </a>        d_nnz[row] += ncols;
<a name="line1602">1602: </a>        <A href="../../../../docs/manualpages/Mat/MatRestoreRow.html#MatRestoreRow">MatRestoreRow</A>(snes-&gt;jacobian,row,&amp;ncols,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line1603">1603: </a>      }

<a name="line1605">1605: </a>      <font color="#4169E1">for</font>(k=0;k&lt;nkept;k++) {
<a name="line1606">1606: </a>        d_nnz[idx_actkept[k]] += 1;
<a name="line1607">1607: </a>        d_nnz[snes-&gt;jacobian-&gt;rmap-&gt;n+k] += 2;
<a name="line1608">1608: </a>      }
<a name="line1609">1609: </a>      <A href="../../../../docs/manualpages/Mat/MatSeqAIJSetPreallocation.html#MatSeqAIJSetPreallocation">MatSeqAIJSetPreallocation</A>(J_aug,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>,d_nnz);
<a name="line1610">1610: </a>
<a name="line1611">1611: </a>      <A href="../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(d_nnz);

<a name="line1613">1613: </a>      <font color="#B22222">/* Set the original jacobian matrix in J_aug */</font>
<a name="line1614">1614: </a>      <font color="#4169E1">for</font>(row=0;row&lt;snes-&gt;jacobian-&gt;rmap-&gt;n;row++) {
<a name="line1615">1615: </a>        <A href="../../../../docs/manualpages/Mat/MatGetRow.html#MatGetRow">MatGetRow</A>(snes-&gt;jacobian,row,&amp;ncols,&amp;cols,&amp;vals);
<a name="line1616">1616: </a>        <A href="../../../../docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</A>(J_aug,1,&amp;row,ncols,cols,vals,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>);
<a name="line1617">1617: </a>        <A href="../../../../docs/manualpages/Mat/MatRestoreRow.html#MatRestoreRow">MatRestoreRow</A>(snes-&gt;jacobian,row,&amp;ncols,&amp;cols,&amp;vals);
<a name="line1618">1618: </a>      }
<a name="line1619">1619: </a>      <font color="#B22222">/* Add the augmented part */</font>
<a name="line1620">1620: </a>      <font color="#4169E1">for</font>(k=0;k&lt;nkept;k++) {
<a name="line1621">1621: </a>        row = snes-&gt;jacobian-&gt;rmap-&gt;n+k;
<a name="line1622">1622: </a>        col[0] = idx_actkept[k]; col[1] = snes-&gt;jacobian-&gt;rmap-&gt;n+k;
<a name="line1623">1623: </a>        <A href="../../../../docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</A>(J_aug,1,&amp;row,1,col,value,<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>);
<a name="line1624">1624: </a>        <A href="../../../../docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</A>(J_aug,1,&amp;col[0],1,&amp;row,&amp;value[0],<A href="../../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</A>);
<a name="line1625">1625: </a>      }
<a name="line1626">1626: </a>      <A href="../../../../docs/manualpages/Mat/MatAssemblyBegin.html#MatAssemblyBegin">MatAssemblyBegin</A>(J_aug,MAT_FINAL_ASSEMBLY);
<a name="line1627">1627: </a>      <A href="../../../../docs/manualpages/Mat/MatAssemblyEnd.html#MatAssemblyEnd">MatAssemblyEnd</A>(J_aug,MAT_FINAL_ASSEMBLY);
<a name="line1628">1628: </a>      <font color="#B22222">/* Only considering prejac = jac for now */</font>
<a name="line1629">1629: </a>      Jpre_aug = J_aug;
<a name="line1630">1630: </a>      } <font color="#B22222">/* local vars*/</font>
<a name="line1631">1631: </a>      <A href="../../../../docs/manualpages/IS/ISRestoreIndices.html#ISRestoreIndices">ISRestoreIndices</A>(IS_act,&amp;idx_act);
<a name="line1632">1632: </a>      <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;IS_act);
<a name="line1633">1633: </a>    } <font color="#4169E1">else</font> {
<a name="line1634">1634: </a>      F_aug = F; J_aug = snes-&gt;jacobian; Y_aug = Y; Jpre_aug = snes-&gt;jacobian_pre;
<a name="line1635">1635: </a>    }

<a name="line1637">1637: </a>    <A href="../../../../docs/manualpages/IS/ISEqual.html#ISEqual">ISEqual</A>(vi-&gt;IS_inact_prev,IS_inact,&amp;isequal);
<a name="line1638">1638: </a>    <font color="#4169E1">if</font> (!isequal) {
<a name="line1639">1639: </a>      SNESVIResetPCandKSP(snes,J_aug,Jpre_aug);
<a name="line1640">1640: </a>    }
<a name="line1641">1641: </a>    <A href="../../../../docs/manualpages/KSP/KSPSetOperators.html#KSPSetOperators">KSPSetOperators</A>(snes-&gt;ksp,J_aug,Jpre_aug,flg);
<a name="line1642">1642: </a>    <A href="../../../../docs/manualpages/KSP/KSPSetUp.html#KSPSetUp">KSPSetUp</A>(snes-&gt;ksp);
<a name="line1643">1643: </a>    <font color="#B22222">/*  {</font>
<a name="line1644">1644: </a><font color="#B22222">      <A href="../../../../docs/manualpages/PC/PC.html#PC">PC</A>        pc;</font>
<a name="line1645">1645: </a><font color="#B22222">      <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A> flg;</font>
<a name="line1646">1646: </a><font color="#B22222">      <A href="../../../../docs/manualpages/KSP/KSPGetPC.html#KSPGetPC">KSPGetPC</A>(snes-&gt;ksp,&amp;pc);</font>
<a name="line1647">1647: </a><font color="#B22222">      <A href="../../../../docs/manualpages/Sys/PetscTypeCompare.html#PetscTypeCompare">PetscTypeCompare</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)pc,<A href="../../../../docs/manualpages/PC/PCFIELDSPLIT.html#PCFIELDSPLIT">PCFIELDSPLIT</A>,&amp;flg);</font>
<a name="line1648">1648: </a><font color="#B22222">      if (flg) {</font>
<a name="line1649">1649: </a><font color="#B22222">        <A href="../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</A>      *subksps;</font>
<a name="line1650">1650: </a><font color="#B22222">        <A href="../../../../docs/manualpages/PC/PCFieldSplitGetSubKSP.html#PCFieldSplitGetSubKSP">PCFieldSplitGetSubKSP</A>(pc,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>,&amp;subksps);</font>
<a name="line1651">1651: </a><font color="#B22222">        <A href="../../../../docs/manualpages/KSP/KSPGetPC.html#KSPGetPC">KSPGetPC</A>(subksps[0],&amp;pc);</font>
<a name="line1652">1652: </a><font color="#B22222">        <A href="../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(subksps);</font>
<a name="line1653">1653: </a><font color="#B22222">        <A href="../../../../docs/manualpages/Sys/PetscTypeCompare.html#PetscTypeCompare">PetscTypeCompare</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)pc,<A href="../../../../docs/manualpages/PC/PCBJACOBI.html#PCBJACOBI">PCBJACOBI</A>,&amp;flg);</font>
<a name="line1654">1654: </a><font color="#B22222">        if (flg) {</font>
<a name="line1655">1655: </a><font color="#B22222">          <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       n,N = 101*101,j,cnts[3] = {0,0,0};</font>
<a name="line1656">1656: </a><font color="#B22222">          const <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A> *ii;</font>

<a name="line1658">1658: </a><font color="#B22222">          <A href="../../../../docs/manualpages/IS/ISGetSize.html#ISGetSize">ISGetSize</A>(IS_inact,&amp;n);</font>
<a name="line1659">1659: </a><font color="#B22222">          <A href="../../../../docs/manualpages/IS/ISGetIndices.html#ISGetIndices">ISGetIndices</A>(IS_inact,&amp;ii);</font>
<a name="line1660">1660: </a><font color="#B22222">          for (j=0; j&lt;n; j++) {</font>
<a name="line1661">1661: </a><font color="#B22222">            if (ii[j] &lt; N) cnts[0]++;</font>
<a name="line1662">1662: </a><font color="#B22222">            else if (ii[j] &lt; 2*N) cnts[1]++;</font>
<a name="line1663">1663: </a><font color="#B22222">            else if (ii[j] &lt; 3*N) cnts[2]++;</font>
<a name="line1664">1664: </a><font color="#B22222">          }</font>
<a name="line1665">1665: </a><font color="#B22222">          <A href="../../../../docs/manualpages/IS/ISRestoreIndices.html#ISRestoreIndices">ISRestoreIndices</A>(IS_inact,&amp;ii);</font>

<a name="line1667">1667: </a><font color="#B22222">          <A href="../../../../docs/manualpages/PC/PCBJacobiSetTotalBlocks.html#PCBJacobiSetTotalBlocks">PCBJacobiSetTotalBlocks</A>(pc,3,cnts);</font>
<a name="line1668">1668: </a><font color="#B22222">        }</font>
<a name="line1669">1669: </a><font color="#B22222">      }</font>
<a name="line1670">1670: </a><font color="#B22222">    }</font>
<a name="line1671">1671: </a><font color="#B22222">    */</font>
<a name="line1672">1672: </a>    SNES_KSPSolve(snes,snes-&gt;ksp,F_aug,Y_aug);
<a name="line1673">1673: </a>    <A href="../../../../docs/manualpages/KSP/KSPGetConvergedReason.html#KSPGetConvergedReason">KSPGetConvergedReason</A>(snes-&gt;ksp,&amp;kspreason);
<a name="line1674">1674: </a>    <font color="#4169E1">if</font> (kspreason &lt; 0) {
<a name="line1675">1675: </a>      <font color="#4169E1">if</font> (++snes-&gt;numLinearSolveFailures &gt;= snes-&gt;maxLinearSolveFailures) {
<a name="line1676">1676: </a>        PetscInfo2(snes,<font color="#666666">"iter=%D, number linear solve failures %D greater than current <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> allowed, stopping solve\n"</font>,snes-&gt;iter,snes-&gt;numLinearSolveFailures);
<a name="line1677">1677: </a>        snes-&gt;reason = SNES_DIVERGED_LINEAR_SOLVE;
<a name="line1678">1678: </a>        <font color="#4169E1">break</font>;
<a name="line1679">1679: </a>      }
<a name="line1680">1680: </a>    }

<a name="line1682">1682: </a>    <font color="#4169E1">if</font>(nis_act) {
<a name="line1683">1683: </a>      <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> *y1,*y2;
<a name="line1684">1684: </a>      <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(Y,&amp;y1);
<a name="line1685">1685: </a>      <A href="../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</A>(Y_aug,&amp;y2);
<a name="line1686">1686: </a>      <font color="#B22222">/* Copy over inactive Y_aug to Y */</font>
<a name="line1687">1687: </a>      j1 = 0;
<a name="line1688">1688: </a>      <font color="#4169E1">for</font>(i1=Y-&gt;map-&gt;rstart;i1 &lt; Y-&gt;map-&gt;rend;i1++) {
<a name="line1689">1689: </a>        <font color="#4169E1">if</font>(j1 &lt; nkept &amp;&amp; idx_actkept[j1] == i1) j1++;
<a name="line1690">1690: </a>        <font color="#4169E1">else</font> y1[i1-Y-&gt;map-&gt;rstart] = y2[i1-Y-&gt;map-&gt;rstart];
<a name="line1691">1691: </a>      }
<a name="line1692">1692: </a>      <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(Y,&amp;y1);
<a name="line1693">1693: </a>      <A href="../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</A>(Y_aug,&amp;y2);

<a name="line1695">1695: </a>      <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;F_aug);
<a name="line1696">1696: </a>      <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;Y_aug);
<a name="line1697">1697: </a>      <A href="../../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</A>(&amp;J_aug);
<a name="line1698">1698: </a>      <A href="../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(idx_actkept);
<a name="line1699">1699: </a>    }
<a name="line1700">1700: </a>
<a name="line1701">1701: </a>    <font color="#4169E1">if</font> (!isequal) {
<a name="line1702">1702: </a>      <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;vi-&gt;IS_inact_prev);
<a name="line1703">1703: </a>      <A href="../../../../docs/manualpages/IS/ISDuplicate.html#ISDuplicate">ISDuplicate</A>(IS_inact,&amp;vi-&gt;IS_inact_prev);
<a name="line1704">1704: </a>    }
<a name="line1705">1705: </a>    <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;IS_inact);

<a name="line1707">1707: </a>    <A href="../../../../docs/manualpages/KSP/KSPGetIterationNumber.html#KSPGetIterationNumber">KSPGetIterationNumber</A>(snes-&gt;ksp,&amp;lits);
<a name="line1708">1708: </a>    snes-&gt;linear_its += lits;
<a name="line1709">1709: </a>    PetscInfo2(snes,<font color="#666666">"iter=%D, linear solve iterations=%D\n"</font>,snes-&gt;iter,lits);
<a name="line1710">1710: </a>    <font color="#B22222">/*</font>
<a name="line1711">1711: </a><font color="#B22222">    if (vi-&gt;precheckstep) {</font>
<a name="line1712">1712: </a><font color="#B22222">      <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A> changed_y = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;</font>
<a name="line1713">1713: </a><font color="#B22222">      (*vi-&gt;precheckstep)(snes,X,Y,vi-&gt;precheck,&amp;changed_y);</font>
<a name="line1714">1714: </a><font color="#B22222">    }</font>

<a name="line1716">1716: </a><font color="#B22222">    if (PetscLogPrintInfo){</font>
<a name="line1717">1717: </a><font color="#B22222">      SNESVICheckResidual_Private(snes,snes-&gt;jacobian,F,Y,G,W);</font>
<a name="line1718">1718: </a><font color="#B22222">    }</font>
<a name="line1719">1719: </a><font color="#B22222">    */</font>
<a name="line1720">1720: </a>    <font color="#B22222">/* Compute a (scaled) negative update in the line search routine: </font>
<a name="line1721">1721: </a><font color="#B22222">         Y &lt;- X - lambda*Y </font>
<a name="line1722">1722: </a><font color="#B22222">       and evaluate G = function(Y) (depends on the line search). </font>
<a name="line1723">1723: </a><font color="#B22222">    */</font>
<a name="line1724">1724: </a>    <A href="../../../../docs/manualpages/Vec/VecCopy.html#VecCopy">VecCopy</A>(Y,snes-&gt;vec_sol_update);
<a name="line1725">1725: </a>    ynorm = 1; gnorm = fnorm;
<a name="line1726">1726: </a>    (*vi-&gt;LineSearch)(snes,vi-&gt;lsP,X,F,G,Y,W,fnorm,xnorm,&amp;ynorm,&amp;gnorm,&amp;lssucceed);
<a name="line1727">1727: </a>    PetscInfo4(snes,<font color="#666666">"fnorm=%18.16e, gnorm=%18.16e, ynorm=%18.16e, lssucceed=%d\n"</font>,fnorm,gnorm,ynorm,(int)lssucceed);
<a name="line1728">1728: </a>    <font color="#4169E1">if</font> (snes-&gt;reason == <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_FUNCTION_COUNT.html#SNES_DIVERGED_FUNCTION_COUNT">SNES_DIVERGED_FUNCTION_COUNT</A>) <font color="#4169E1">break</font>;
<a name="line1729">1729: </a>    <font color="#4169E1">if</font> (snes-&gt;domainerror) {
<a name="line1730">1730: </a>      snes-&gt;reason = SNES_DIVERGED_FUNCTION_DOMAIN;
<a name="line1731">1731: </a>      <font color="#4169E1">return</font>(0);
<a name="line1732">1732: </a>    }
<a name="line1733">1733: </a>    <font color="#4169E1">if</font> (!lssucceed) {
<a name="line1734">1734: </a>      <font color="#4169E1">if</font> (++snes-&gt;numFailures &gt;= snes-&gt;maxFailures) {
<a name="line1735">1735: </a>        <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A> ismin;
<a name="line1736">1736: </a>        snes-&gt;reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_LINE_SEARCH.html#SNES_DIVERGED_LINE_SEARCH">SNES_DIVERGED_LINE_SEARCH</A>;
<a name="line1737">1737: </a>        SNESVICheckLocalMin_Private(snes,snes-&gt;jacobian,G,W,gnorm,&amp;ismin);
<a name="line1738">1738: </a>        <font color="#4169E1">if</font> (ismin) snes-&gt;reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_LOCAL_MIN.html#SNES_DIVERGED_LOCAL_MIN">SNES_DIVERGED_LOCAL_MIN</A>;
<a name="line1739">1739: </a>        <font color="#4169E1">break</font>;
<a name="line1740">1740: </a>      }
<a name="line1741">1741: </a>    }
<a name="line1742">1742: </a>    <font color="#B22222">/* Update function and solution vectors */</font>
<a name="line1743">1743: </a>    fnorm = gnorm;
<a name="line1744">1744: </a>    <A href="../../../../docs/manualpages/Vec/VecCopy.html#VecCopy">VecCopy</A>(G,F);
<a name="line1745">1745: </a>    <A href="../../../../docs/manualpages/Vec/VecCopy.html#VecCopy">VecCopy</A>(W,X);
<a name="line1746">1746: </a>    <font color="#B22222">/* Monitor convergence */</font>
<a name="line1747">1747: </a>    PetscObjectTakeAccess(snes);
<a name="line1748">1748: </a>    snes-&gt;iter = i+1;
<a name="line1749">1749: </a>    snes-&gt;norm = fnorm;
<a name="line1750">1750: </a>    PetscObjectGrantAccess(snes);
<a name="line1751">1751: </a>    SNESLogConvHistory(snes,snes-&gt;norm,lits);
<a name="line1752">1752: </a>    <A href="../../../../docs/manualpages/SNES/SNESMonitor.html#SNESMonitor">SNESMonitor</A>(snes,snes-&gt;iter,snes-&gt;norm);
<a name="line1753">1753: </a>    <font color="#B22222">/* Test for convergence, xnorm = || X || */</font>
<a name="line1754">1754: </a>    <font color="#4169E1">if</font> (snes-&gt;ops-&gt;converged != <A href="../../../../docs/manualpages/SNES/SNESSkipConverged.html#SNESSkipConverged">SNESSkipConverged</A>) { <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(X,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,&amp;xnorm); }
<a name="line1755">1755: </a>    (*snes-&gt;ops-&gt;converged)(snes,snes-&gt;iter,xnorm,ynorm,fnorm,&amp;snes-&gt;reason,snes-&gt;cnvP);
<a name="line1756">1756: </a>    <font color="#4169E1">if</font> (snes-&gt;reason) <font color="#4169E1">break</font>;
<a name="line1757">1757: </a>  }
<a name="line1758">1758: </a>  <font color="#4169E1">if</font> (i == maxits) {
<a name="line1759">1759: </a>    PetscInfo1(snes,<font color="#666666">"Maximum number of iterations has been reached: %D\n"</font>,maxits);
<a name="line1760">1760: </a>    <font color="#4169E1">if</font>(!snes-&gt;reason) snes-&gt;reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_MAX_IT.html#SNES_DIVERGED_MAX_IT">SNES_DIVERGED_MAX_IT</A>;
<a name="line1761">1761: </a>  }
<a name="line1762">1762: </a>  <font color="#4169E1">return</font>(0);
<a name="line1763">1763: </a>}

<a name="line1765">1765: </a><font color="#B22222">/* -------------------------------------------------------------------------- */</font>
<a name="line1766">1766: </a><font color="#B22222">/*</font>
<a name="line1767">1767: </a><font color="#B22222">   SNESSetUp_VI - Sets up the internal data structures for the later use</font>
<a name="line1768">1768: </a><font color="#B22222">   of the <A href="../../../../docs/manualpages/SNES/SNESVI.html#SNESVI">SNESVI</A> nonlinear solver.</font>

<a name="line1770">1770: </a><font color="#B22222">   Input Parameter:</font>
<a name="line1771">1771: </a><font color="#B22222">.  snes - the <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> context</font>
<a name="line1772">1772: </a><font color="#B22222">.  x - the solution vector</font>

<a name="line1774">1774: </a><font color="#B22222">   Application Interface Routine: <A href="../../../../docs/manualpages/SNES/SNESSetUp.html#SNESSetUp">SNESSetUp</A>()</font>

<a name="line1776">1776: </a><font color="#B22222">   Notes:</font>
<a name="line1777">1777: </a><font color="#B22222">   For basic use of the <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> solvers, the user need not explicitly call</font>
<a name="line1778">1778: </a><font color="#B22222">   <A href="../../../../docs/manualpages/SNES/SNESSetUp.html#SNESSetUp">SNESSetUp</A>(), since these actions will automatically occur during</font>
<a name="line1779">1779: </a><font color="#B22222">   the call to <A href="../../../../docs/manualpages/SNES/SNESSolve.html#SNESSolve">SNESSolve</A>().</font>
<a name="line1780">1780: </a><font color="#B22222"> */</font>
<a name="line1783">1783: </a><strong><font color="#4169E1"><a name="SNESSetUp_VI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESSetUp_VI(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes)</font></strong>
<a name="line1784">1784: </a>{
<a name="line1786">1786: </a>  SNES_VI        *vi = (SNES_VI*) snes-&gt;data;
<a name="line1787">1787: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       i_start[3],i_end[3];


<a name="line1791">1791: </a>  <A href="../../../../docs/manualpages/SNES/SNESDefaultGetWork.html#SNESDefaultGetWork">SNESDefaultGetWork</A>(snes,3);

<a name="line1793">1793: </a>  <font color="#4169E1">if</font> (vi-&gt;computevariablebounds) {
<a name="line1794">1794: </a>    <font color="#4169E1">if</font> (!vi-&gt;xl) {<A href="../../../../docs/manualpages/Vec/VecDuplicate.html#VecDuplicate">VecDuplicate</A>(snes-&gt;vec_sol,&amp;vi-&gt;xl);}
<a name="line1795">1795: </a>    <font color="#4169E1">if</font> (!vi-&gt;xu) {<A href="../../../../docs/manualpages/Vec/VecDuplicate.html#VecDuplicate">VecDuplicate</A>(snes-&gt;vec_sol,&amp;vi-&gt;xu);}
<a name="line1796">1796: </a>    (*vi-&gt;computevariablebounds)(snes,vi-&gt;xl,vi-&gt;xu);
<a name="line1797">1797: </a>  } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (!vi-&gt;xl &amp;&amp; !vi-&gt;xu) {
<a name="line1798">1798: </a>    <font color="#B22222">/* If the lower and upper bound on variables are not set, set it to -Inf and Inf */</font>
<a name="line1799">1799: </a>    <A href="../../../../docs/manualpages/Vec/VecDuplicate.html#VecDuplicate">VecDuplicate</A>(snes-&gt;vec_sol, &amp;vi-&gt;xl);
<a name="line1800">1800: </a>    <A href="../../../../docs/manualpages/Vec/VecSet.html#VecSet">VecSet</A>(vi-&gt;xl,SNES_VI_NINF);
<a name="line1801">1801: </a>    <A href="../../../../docs/manualpages/Vec/VecDuplicate.html#VecDuplicate">VecDuplicate</A>(snes-&gt;vec_sol, &amp;vi-&gt;xu);
<a name="line1802">1802: </a>    <A href="../../../../docs/manualpages/Vec/VecSet.html#VecSet">VecSet</A>(vi-&gt;xu,SNES_VI_INF);
<a name="line1803">1803: </a>  } <font color="#4169E1">else</font> {
<a name="line1804">1804: </a>    <font color="#B22222">/* Check if lower bound, upper bound and solution vector distribution across the processors is identical */</font>
<a name="line1805">1805: </a>    <A href="../../../../docs/manualpages/Vec/VecGetOwnershipRange.html#VecGetOwnershipRange">VecGetOwnershipRange</A>(snes-&gt;vec_sol,i_start,i_end);
<a name="line1806">1806: </a>    <A href="../../../../docs/manualpages/Vec/VecGetOwnershipRange.html#VecGetOwnershipRange">VecGetOwnershipRange</A>(vi-&gt;xl,i_start+1,i_end+1);
<a name="line1807">1807: </a>    <A href="../../../../docs/manualpages/Vec/VecGetOwnershipRange.html#VecGetOwnershipRange">VecGetOwnershipRange</A>(vi-&gt;xu,i_start+2,i_end+2);
<a name="line1808">1808: </a>    <font color="#4169E1">if</font> ((i_start[0] != i_start[1]) || (i_start[0] != i_start[2]) || (i_end[0] != i_end[1]) || (i_end[0] != i_end[2]))
<a name="line1809">1809: </a>      <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_ARG_SIZ,<font color="#666666">"Distribution of lower bound, upper bound and the solution vector should be identical across all the processors."</font>);
<a name="line1810">1810: </a>  }
<a name="line1811">1811: </a>  <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve != SNESSolveVI_SS) {
<a name="line1812">1812: </a>    <font color="#B22222">/* Set up previous active index set for the first snes solve </font>
<a name="line1813">1813: </a><font color="#B22222">       vi-&gt;IS_inact_prev = 0,1,2,....N */</font>
<a name="line1814">1814: </a>    <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A> *indices;
<a name="line1815">1815: </a>    <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>  i,n,rstart,rend;

<a name="line1817">1817: </a>    <A href="../../../../docs/manualpages/Vec/VecGetOwnershipRange.html#VecGetOwnershipRange">VecGetOwnershipRange</A>(snes-&gt;vec_sol,&amp;rstart,&amp;rend);
<a name="line1818">1818: </a>    <A href="../../../../docs/manualpages/Vec/VecGetLocalSize.html#VecGetLocalSize">VecGetLocalSize</A>(snes-&gt;vec_sol,&amp;n);
<a name="line1819">1819: </a>    <A href="../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>(n*<font color="#4169E1">sizeof</font>(<A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>),&amp;indices);
<a name="line1820">1820: </a>    <font color="#4169E1">for</font>(i=0;i &lt; n; i++) indices[i] = rstart + i;
<a name="line1821">1821: </a>    <A href="../../../../docs/manualpages/IS/ISCreateGeneral.html#ISCreateGeneral">ISCreateGeneral</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm,n,indices,PETSC_OWN_POINTER,&amp;vi-&gt;IS_inact_prev);
<a name="line1822">1822: </a>  }

<a name="line1824">1824: </a>  <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve == SNESSolveVI_SS) {
<a name="line1825">1825: </a>    <A href="../../../../docs/manualpages/Vec/VecDuplicate.html#VecDuplicate">VecDuplicate</A>(snes-&gt;vec_sol, &amp;vi-&gt;dpsi);
<a name="line1826">1826: </a>    <A href="../../../../docs/manualpages/Vec/VecDuplicate.html#VecDuplicate">VecDuplicate</A>(snes-&gt;vec_sol, &amp;vi-&gt;phi);
<a name="line1827">1827: </a>    <A href="../../../../docs/manualpages/Vec/VecDuplicate.html#VecDuplicate">VecDuplicate</A>(snes-&gt;vec_sol, &amp;vi-&gt;Da);
<a name="line1828">1828: </a>    <A href="../../../../docs/manualpages/Vec/VecDuplicate.html#VecDuplicate">VecDuplicate</A>(snes-&gt;vec_sol, &amp;vi-&gt;Db);
<a name="line1829">1829: </a>    <A href="../../../../docs/manualpages/Vec/VecDuplicate.html#VecDuplicate">VecDuplicate</A>(snes-&gt;vec_sol, &amp;vi-&gt;z);
<a name="line1830">1830: </a>    <A href="../../../../docs/manualpages/Vec/VecDuplicate.html#VecDuplicate">VecDuplicate</A>(snes-&gt;vec_sol, &amp;vi-&gt;t);
<a name="line1831">1831: </a>  }
<a name="line1832">1832: </a>  <font color="#4169E1">return</font>(0);
<a name="line1833">1833: </a>}
<a name="line1834">1834: </a><font color="#B22222">/* -------------------------------------------------------------------------- */</font>
<a name="line1837">1837: </a><strong><font color="#4169E1"><a name="SNESReset_VI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESReset_VI(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes)</font></strong>
<a name="line1838">1838: </a>{
<a name="line1839">1839: </a>  SNES_VI        *vi = (SNES_VI*) snes-&gt;data;

<a name="line1843">1843: </a>  <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;vi-&gt;xl);
<a name="line1844">1844: </a>  <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;vi-&gt;xu);
<a name="line1845">1845: </a>  <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve != SNESSolveVI_SS) {
<a name="line1846">1846: </a>    <A href="../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(&amp;vi-&gt;IS_inact_prev);
<a name="line1847">1847: </a>  }
<a name="line1848">1848: </a>  <font color="#4169E1">return</font>(0);
<a name="line1849">1849: </a>}

<a name="line1851">1851: </a><font color="#B22222">/*</font>
<a name="line1852">1852: </a><font color="#B22222">   SNESDestroy_VI - Destroys the private SNES_VI context that was created</font>
<a name="line1853">1853: </a><font color="#B22222">   with SNESCreate_VI().</font>

<a name="line1855">1855: </a><font color="#B22222">   Input Parameter:</font>
<a name="line1856">1856: </a><font color="#B22222">.  snes - the <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> context</font>

<a name="line1858">1858: </a><font color="#B22222">   Application Interface Routine: <A href="../../../../docs/manualpages/SNES/SNESDestroy.html#SNESDestroy">SNESDestroy</A>()</font>
<a name="line1859">1859: </a><font color="#B22222"> */</font>
<a name="line1862">1862: </a><strong><font color="#4169E1"><a name="SNESDestroy_VI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESDestroy_VI(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes)</font></strong>
<a name="line1863">1863: </a>{
<a name="line1864">1864: </a>  SNES_VI        *vi = (SNES_VI*) snes-&gt;data;


<a name="line1869">1869: </a>  <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve == SNESSolveVI_SS) {
<a name="line1870">1870: </a>    <font color="#B22222">/* clear vectors */</font>
<a name="line1871">1871: </a>    <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;vi-&gt;dpsi);
<a name="line1872">1872: </a>    <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;vi-&gt;phi);
<a name="line1873">1873: </a>    <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;vi-&gt;Da);
<a name="line1874">1874: </a>    <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;vi-&gt;Db);
<a name="line1875">1875: </a>    <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;vi-&gt;z);
<a name="line1876">1876: </a>    <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;vi-&gt;t);
<a name="line1877">1877: </a>  }
<a name="line1878">1878: </a>
<a name="line1879">1879: </a>  <A href="../../../../docs/manualpages/Viewer/PetscViewerDestroy.html#PetscViewerDestroy">PetscViewerDestroy</A>(&amp;vi-&gt;lsmonitor);
<a name="line1880">1880: </a>  <A href="../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(snes-&gt;data);

<a name="line1882">1882: </a>  <font color="#B22222">/* clear composed functions */</font>
<a name="line1883">1883: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectComposeFunctionDynamic.html#PetscObjectComposeFunctionDynamic">PetscObjectComposeFunctionDynamic</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes,<font color="#666666">"SNESLineSearchSet_C"</font>,<font color="#666666">""</font>,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line1884">1884: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectComposeFunctionDynamic.html#PetscObjectComposeFunctionDynamic">PetscObjectComposeFunctionDynamic</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes,<font color="#666666">"SNESLineSearchSetMonitor_C"</font>,<font color="#666666">""</font>,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line1885">1885: </a>  <font color="#4169E1">return</font>(0);
<a name="line1886">1886: </a>}

<a name="line1888">1888: </a><font color="#B22222">/* -------------------------------------------------------------------------- */</font>

<a name="line1892">1892: </a><font color="#B22222">/*</font>
<a name="line1893">1893: </a><font color="#B22222">  This routine does not actually do a line search but it takes a full newton</font>
<a name="line1894">1894: </a><font color="#B22222">  step while ensuring that the new iterates remain within the constraints.</font>
<a name="line1895">1895: </a><font color="#B22222">  </font>
<a name="line1896">1896: </a><font color="#B22222">*/</font>
<a name="line1897">1897: </a><strong><font color="#4169E1"><a name="SNESLineSearchNo_VI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESLineSearchNo_VI(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,void *lsctx,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> x,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> f,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> g,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> y,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> w,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> fnorm,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> xnorm,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> *ynorm,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> *gnorm,<A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A> *flag)</font></strong>
<a name="line1898">1898: </a>{
<a name="line1900">1900: </a>  SNES_VI        *vi = (SNES_VI*)snes-&gt;data;
<a name="line1901">1901: </a>  <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A>      changed_w = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>,changed_y = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;

<a name="line1904">1904: </a>  *flag = <A href="../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</A>;
<a name="line1905">1905: </a>  <A href="../../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</A>(SNES_LineSearch,snes,x,f,g);
<a name="line1906">1906: </a>  <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(y,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,ynorm);         <font color="#B22222">/* ynorm = || y || */</font>
<a name="line1907">1907: </a>  <A href="../../../../docs/manualpages/Vec/VecWAXPY.html#VecWAXPY">VecWAXPY</A>(w,-1.0,y,x);            <font color="#B22222">/* w &lt;- x - y   */</font>
<a name="line1908">1908: </a>  SNESVIProjectOntoBounds(snes,w);
<a name="line1909">1909: </a>  <font color="#4169E1">if</font> (vi-&gt;postcheckstep) {
<a name="line1910">1910: </a>   (*vi-&gt;postcheckstep)(snes,x,y,w,vi-&gt;postcheck,&amp;changed_y,&amp;changed_w);
<a name="line1911">1911: </a>  }
<a name="line1912">1912: </a>  <font color="#4169E1">if</font> (changed_y) {
<a name="line1913">1913: </a>    <A href="../../../../docs/manualpages/Vec/VecWAXPY.html#VecWAXPY">VecWAXPY</A>(w,-1.0,y,x);            <font color="#B22222">/* w &lt;- x - y   */</font>
<a name="line1914">1914: </a>    SNESVIProjectOntoBounds(snes,w);
<a name="line1915">1915: </a>  }
<a name="line1916">1916: </a>  SNESVIProjectOntoBounds(snes,w);
<a name="line1917">1917: </a>  <A href="../../../../docs/manualpages/SNES/SNESComputeFunction.html#SNESComputeFunction">SNESComputeFunction</A>(snes,w,g);
<a name="line1918">1918: </a>  <font color="#4169E1">if</font> (!snes-&gt;domainerror) {
<a name="line1919">1919: </a>    <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve != SNESSolveVI_SS) {
<a name="line1920">1920: </a>       SNESVIComputeInactiveSetFnorm(snes,g,w,gnorm);
<a name="line1921">1921: </a>    } <font color="#4169E1">else</font> {
<a name="line1922">1922: </a>      <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(g,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,gnorm);  <font color="#B22222">/* gnorm = || g || */</font>
<a name="line1923">1923: </a>    }
<a name="line1924">1924: </a>    <font color="#4169E1">if</font> (PetscIsInfOrNanReal(*gnorm)) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_FP,<font color="#666666">"User provided compute function generated a Not-a-Number"</font>);
<a name="line1925">1925: </a>  }
<a name="line1926">1926: </a>  <font color="#4169E1">if</font> (vi-&gt;lsmonitor) {
<a name="line1927">1927: </a>    <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIAddTab.html#PetscViewerASCIIAddTab">PetscViewerASCIIAddTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line1928">1928: </a>    <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(vi-&gt;lsmonitor,<font color="#666666">"    Line search: Using full step: fnorm %g gnorm %g\n"</font>,(double)fnorm,(double)*gnorm);
<a name="line1929">1929: </a>    <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIISubtractTab.html#PetscViewerASCIISubtractTab">PetscViewerASCIISubtractTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line1930">1930: </a>  }
<a name="line1931">1931: </a>  <A href="../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</A>(SNES_LineSearch,snes,x,f,g);
<a name="line1932">1932: </a>  <font color="#4169E1">return</font>(0);
<a name="line1933">1933: </a>}

<a name="line1935">1935: </a><font color="#B22222">/* -------------------------------------------------------------------------- */</font>

<a name="line1939">1939: </a><font color="#B22222">/*</font>
<a name="line1940">1940: </a><font color="#B22222">  This routine is a copy of <A href="../../../../docs/manualpages/SNES/SNESLineSearchNoNorms.html#SNESLineSearchNoNorms">SNESLineSearchNoNorms</A> in snes/impls/ls/ls.c</font>
<a name="line1941">1941: </a><font color="#B22222">*/</font>
<a name="line1942">1942: </a><strong><font color="#4169E1"><a name="SNESLineSearchNoNorms_VI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESLineSearchNoNorms_VI(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,void *lsctx,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> x,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> f,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> g,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> y,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> w,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> fnorm,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> xnorm,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> *ynorm,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> *gnorm,<A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A> *flag)</font></strong>
<a name="line1943">1943: </a>{
<a name="line1945">1945: </a>  SNES_VI        *vi = (SNES_VI*)snes-&gt;data;
<a name="line1946">1946: </a>  <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A>     changed_w = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>,changed_y = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;

<a name="line1949">1949: </a>  *flag = <A href="../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</A>;
<a name="line1950">1950: </a>  <A href="../../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</A>(SNES_LineSearch,snes,x,f,g);
<a name="line1951">1951: </a>  <A href="../../../../docs/manualpages/Vec/VecWAXPY.html#VecWAXPY">VecWAXPY</A>(w,-1.0,y,x);            <font color="#B22222">/* w &lt;- x - y      */</font>
<a name="line1952">1952: </a>  SNESVIProjectOntoBounds(snes,w);
<a name="line1953">1953: </a>  <font color="#4169E1">if</font> (vi-&gt;postcheckstep) {
<a name="line1954">1954: </a>   (*vi-&gt;postcheckstep)(snes,x,y,w,vi-&gt;postcheck,&amp;changed_y,&amp;changed_w);
<a name="line1955">1955: </a>  }
<a name="line1956">1956: </a>  <font color="#4169E1">if</font> (changed_y) {
<a name="line1957">1957: </a>    <A href="../../../../docs/manualpages/Vec/VecWAXPY.html#VecWAXPY">VecWAXPY</A>(w,-1.0,y,x);            <font color="#B22222">/* w &lt;- x - y   */</font>
<a name="line1958">1958: </a>    SNESVIProjectOntoBounds(snes,w);
<a name="line1959">1959: </a>  }
<a name="line1960">1960: </a>
<a name="line1961">1961: </a>  <font color="#B22222">/* don't evaluate function the last time through */</font>
<a name="line1962">1962: </a>  <font color="#4169E1">if</font> (snes-&gt;iter &lt; snes-&gt;max_its-1) {
<a name="line1963">1963: </a>    <A href="../../../../docs/manualpages/SNES/SNESComputeFunction.html#SNESComputeFunction">SNESComputeFunction</A>(snes,w,g);
<a name="line1964">1964: </a>  }
<a name="line1965">1965: </a>  <A href="../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</A>(SNES_LineSearch,snes,x,f,g);
<a name="line1966">1966: </a>  <font color="#4169E1">return</font>(0);
<a name="line1967">1967: </a>}

<a name="line1969">1969: </a><font color="#B22222">/* -------------------------------------------------------------------------- */</font>
<a name="line1972">1972: </a><font color="#B22222">/*</font>
<a name="line1973">1973: </a><font color="#B22222">  This routine implements a cubic line search while doing a projection on the variable bounds</font>
<a name="line1974">1974: </a><font color="#B22222">*/</font>
<a name="line1975">1975: </a><strong><font color="#4169E1"><a name="SNESLineSearchCubic_VI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESLineSearchCubic_VI(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,void *lsctx,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> x,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> f,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> g,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> y,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> w,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> fnorm,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> xnorm,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> *ynorm,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> *gnorm,<A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A> *flag)</font></strong>
<a name="line1976">1976: </a>{
<a name="line1977">1977: </a>  <A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A>      initslope,lambdaprev,gnormprev,a,b,d,t1,t2,rellength;
<a name="line1978">1978: </a>  <A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A>      minlambda,lambda,lambdatemp;
<a name="line1979">1979: </a><font color="#A020F0">#if defined(PETSC_USE_COMPLEX)</font>
<a name="line1980">1980: </a>  <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>    cinitslope;
<a name="line1981">1981: </a><font color="#A020F0">#endif</font>
<a name="line1983">1983: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       count;
<a name="line1984">1984: </a>  SNES_VI        *vi = (SNES_VI*)snes-&gt;data;
<a name="line1985">1985: </a>  <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A>      changed_w = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>,changed_y = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;
<a name="line1986">1986: </a>  <A href="../../../../docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</A>       comm;

<a name="line1989">1989: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectGetComm.html#PetscObjectGetComm">PetscObjectGetComm</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes,&amp;comm);
<a name="line1990">1990: </a>  <A href="../../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</A>(SNES_LineSearch,snes,x,f,g);
<a name="line1991">1991: </a>  *flag   = <A href="../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</A>;

<a name="line1993">1993: </a>  <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(y,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,ynorm);
<a name="line1994">1994: </a>  <font color="#4169E1">if</font> (*ynorm == 0.0) {
<a name="line1995">1995: </a>    <font color="#4169E1">if</font> (vi-&gt;lsmonitor) {
<a name="line1996">1996: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIAddTab.html#PetscViewerASCIIAddTab">PetscViewerASCIIAddTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line1997">1997: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(vi-&gt;lsmonitor,<font color="#666666">"    Line search: Initial direction and size is 0\n"</font>);
<a name="line1998">1998: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIISubtractTab.html#PetscViewerASCIISubtractTab">PetscViewerASCIISubtractTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line1999">1999: </a>    }
<a name="line2000">2000: </a>    *gnorm = fnorm;
<a name="line2001">2001: </a>    <A href="../../../../docs/manualpages/Vec/VecCopy.html#VecCopy">VecCopy</A>(x,w);
<a name="line2002">2002: </a>    <A href="../../../../docs/manualpages/Vec/VecCopy.html#VecCopy">VecCopy</A>(f,g);
<a name="line2003">2003: </a>    *flag  = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;
<a name="line2004">2004: </a>    <font color="#4169E1">goto</font> theend1;
<a name="line2005">2005: </a>  }
<a name="line2006">2006: </a>  <font color="#4169E1">if</font> (*ynorm &gt; vi-&gt;maxstep) {        <font color="#B22222">/* Step too big, so scale back */</font>
<a name="line2007">2007: </a>    <font color="#4169E1">if</font> (vi-&gt;lsmonitor) {
<a name="line2008">2008: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIAddTab.html#PetscViewerASCIIAddTab">PetscViewerASCIIAddTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2009">2009: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(vi-&gt;lsmonitor,<font color="#666666">"    Line search: Scaling step by %g old ynorm %g\n"</font>,(double)vi-&gt;maxstep/(*ynorm),(double)*ynorm);
<a name="line2010">2010: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIISubtractTab.html#PetscViewerASCIISubtractTab">PetscViewerASCIISubtractTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2011">2011: </a>    }
<a name="line2012">2012: </a>    <A href="../../../../docs/manualpages/Vec/VecScale.html#VecScale">VecScale</A>(y,vi-&gt;maxstep/(*ynorm));
<a name="line2013">2013: </a>    *ynorm = vi-&gt;maxstep;
<a name="line2014">2014: </a>  }
<a name="line2015">2015: </a>  <A href="../../../../docs/manualpages/Vec/VecMaxPointwiseDivide.html#VecMaxPointwiseDivide">VecMaxPointwiseDivide</A>(y,x,&amp;rellength);
<a name="line2016">2016: </a>  minlambda = vi-&gt;minlambda/rellength;
<a name="line2017">2017: </a>  <A href="../../../../docs/manualpages/Mat/MatMult.html#MatMult">MatMult</A>(snes-&gt;jacobian,y,w);
<a name="line2018">2018: </a><font color="#A020F0">#if defined(PETSC_USE_COMPLEX)</font>
<a name="line2019">2019: </a>  <A href="../../../../docs/manualpages/Vec/VecDot.html#VecDot">VecDot</A>(f,w,&amp;cinitslope);
<a name="line2020">2020: </a>  initslope = PetscRealPart(cinitslope);
<a name="line2021">2021: </a><font color="#A020F0">#else</font>
<a name="line2022">2022: </a>  <A href="../../../../docs/manualpages/Vec/VecDot.html#VecDot">VecDot</A>(f,w,&amp;initslope);
<a name="line2023">2023: </a><font color="#A020F0">#endif</font>
<a name="line2024">2024: </a>  <font color="#4169E1">if</font> (initslope &gt; 0.0)  initslope = -initslope;
<a name="line2025">2025: </a>  <font color="#4169E1">if</font> (initslope == 0.0) initslope = -1.0;

<a name="line2027">2027: </a>  <A href="../../../../docs/manualpages/Vec/VecWAXPY.html#VecWAXPY">VecWAXPY</A>(w,-1.0,y,x);
<a name="line2028">2028: </a>  SNESVIProjectOntoBounds(snes,w);
<a name="line2029">2029: </a>  <font color="#4169E1">if</font> (snes-&gt;nfuncs &gt;= snes-&gt;max_funcs) {
<a name="line2030">2030: </a>    <A href="../../../../docs/manualpages/Profiling/PetscInfo.html#PetscInfo">PetscInfo</A>(snes,<font color="#666666">"Exceeded maximum function evaluations, while checking full step length!\n"</font>);
<a name="line2031">2031: </a>    *flag = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;
<a name="line2032">2032: </a>    snes-&gt;reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_FUNCTION_COUNT.html#SNES_DIVERGED_FUNCTION_COUNT">SNES_DIVERGED_FUNCTION_COUNT</A>;
<a name="line2033">2033: </a>    <font color="#4169E1">goto</font> theend1;
<a name="line2034">2034: </a>  }
<a name="line2035">2035: </a>  <A href="../../../../docs/manualpages/SNES/SNESComputeFunction.html#SNESComputeFunction">SNESComputeFunction</A>(snes,w,g);
<a name="line2036">2036: </a>  <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve != SNESSolveVI_SS) {
<a name="line2037">2037: </a>    SNESVIComputeInactiveSetFnorm(snes,g,w,gnorm);
<a name="line2038">2038: </a>  } <font color="#4169E1">else</font> {
<a name="line2039">2039: </a>    <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(g,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,gnorm);
<a name="line2040">2040: </a>  }
<a name="line2041">2041: </a>  <font color="#4169E1">if</font> (snes-&gt;domainerror) {
<a name="line2042">2042: </a>    <A href="../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</A>(SNES_LineSearch,snes,x,f,g);
<a name="line2043">2043: </a>    <font color="#4169E1">return</font>(0);
<a name="line2044">2044: </a>  }
<a name="line2045">2045: </a>  <font color="#4169E1">if</font> (PetscIsInfOrNanReal(*gnorm)) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_FP,<font color="#666666">"User provided compute function generated a Not-a-Number"</font>);
<a name="line2046">2046: </a>  PetscInfo4(snes,<font color="#666666">"Initial fnorm %g gnorm %g alpha %g initslope %g\n"</font>,(double)fnorm,(double)*gnorm,(double)vi-&gt;alpha,(double)initslope);
<a name="line2047">2047: </a>  <font color="#4169E1">if</font> ((*gnorm)*(*gnorm) &lt;= (1.0 - vi-&gt;alpha)*fnorm*fnorm ) { <font color="#B22222">/* Sufficient reduction */</font>
<a name="line2048">2048: </a>    <font color="#4169E1">if</font> (vi-&gt;lsmonitor) {
<a name="line2049">2049: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIAddTab.html#PetscViewerASCIIAddTab">PetscViewerASCIIAddTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2050">2050: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(vi-&gt;lsmonitor,<font color="#666666">"    Line search: Using full step: fnorm %g gnorm %g\n"</font>,(double)fnorm,(double)*gnorm);
<a name="line2051">2051: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIISubtractTab.html#PetscViewerASCIISubtractTab">PetscViewerASCIISubtractTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2052">2052: </a>    }
<a name="line2053">2053: </a>    <font color="#4169E1">goto</font> theend1;
<a name="line2054">2054: </a>  }

<a name="line2056">2056: </a>  <font color="#B22222">/* Fit points with quadratic */</font>
<a name="line2057">2057: </a>  lambda     = 1.0;
<a name="line2058">2058: </a>  lambdatemp = -initslope/((*gnorm)*(*gnorm) - fnorm*fnorm - 2.0*initslope);
<a name="line2059">2059: </a>  lambdaprev = lambda;
<a name="line2060">2060: </a>  gnormprev  = *gnorm;
<a name="line2061">2061: </a>  <font color="#4169E1">if</font> (lambdatemp &gt; .5*lambda)  lambdatemp = .5*lambda;
<a name="line2062">2062: </a>  <font color="#4169E1">if</font> (lambdatemp &lt;= .1*lambda) lambda = .1*lambda;
<a name="line2063">2063: </a>  <font color="#4169E1">else</font>                         lambda = lambdatemp;

<a name="line2065">2065: </a>  <A href="../../../../docs/manualpages/Vec/VecWAXPY.html#VecWAXPY">VecWAXPY</A>(w,-lambda,y,x);
<a name="line2066">2066: </a>  SNESVIProjectOntoBounds(snes,w);
<a name="line2067">2067: </a>  <font color="#4169E1">if</font> (snes-&gt;nfuncs &gt;= snes-&gt;max_funcs) {
<a name="line2068">2068: </a>    PetscInfo1(snes,<font color="#666666">"Exceeded maximum function evaluations, while attempting quadratic backtracking! %D \n"</font>,snes-&gt;nfuncs);
<a name="line2069">2069: </a>    *flag = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;
<a name="line2070">2070: </a>    snes-&gt;reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_FUNCTION_COUNT.html#SNES_DIVERGED_FUNCTION_COUNT">SNES_DIVERGED_FUNCTION_COUNT</A>;
<a name="line2071">2071: </a>    <font color="#4169E1">goto</font> theend1;
<a name="line2072">2072: </a>  }
<a name="line2073">2073: </a>  <A href="../../../../docs/manualpages/SNES/SNESComputeFunction.html#SNESComputeFunction">SNESComputeFunction</A>(snes,w,g);
<a name="line2074">2074: </a>  <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve != SNESSolveVI_SS) {
<a name="line2075">2075: </a>    SNESVIComputeInactiveSetFnorm(snes,g,w,gnorm);
<a name="line2076">2076: </a>  } <font color="#4169E1">else</font> {
<a name="line2077">2077: </a>    <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(g,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,gnorm);
<a name="line2078">2078: </a>  }
<a name="line2079">2079: </a>  <font color="#4169E1">if</font> (snes-&gt;domainerror) {
<a name="line2080">2080: </a>    <A href="../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</A>(SNES_LineSearch,snes,x,f,g);
<a name="line2081">2081: </a>    <font color="#4169E1">return</font>(0);
<a name="line2082">2082: </a>  }
<a name="line2083">2083: </a>  <font color="#4169E1">if</font> (PetscIsInfOrNanReal(*gnorm)) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_FP,<font color="#666666">"User provided compute function generated a Not-a-Number"</font>);
<a name="line2084">2084: </a>  <font color="#4169E1">if</font> (vi-&gt;lsmonitor) {
<a name="line2085">2085: </a>    <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIAddTab.html#PetscViewerASCIIAddTab">PetscViewerASCIIAddTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2086">2086: </a>    <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(vi-&gt;lsmonitor,<font color="#666666">"    Line search: gnorm after quadratic fit %g\n"</font>,(double)*gnorm);
<a name="line2087">2087: </a>    <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIISubtractTab.html#PetscViewerASCIISubtractTab">PetscViewerASCIISubtractTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2088">2088: </a>  }
<a name="line2089">2089: </a>  <font color="#4169E1">if</font> ((*gnorm)*(*gnorm) &lt; (1.0 - vi-&gt;alpha)*fnorm*fnorm ) { <font color="#B22222">/* sufficient reduction */</font>
<a name="line2090">2090: </a>    <font color="#4169E1">if</font> (vi-&gt;lsmonitor) {
<a name="line2091">2091: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIAddTab.html#PetscViewerASCIIAddTab">PetscViewerASCIIAddTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2092">2092: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(vi-&gt;lsmonitor,<font color="#666666">"    Line search: Quadratically determined step, lambda=%18.16e\n"</font>,lambda);
<a name="line2093">2093: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIISubtractTab.html#PetscViewerASCIISubtractTab">PetscViewerASCIISubtractTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2094">2094: </a>    }
<a name="line2095">2095: </a>    <font color="#4169E1">goto</font> theend1;
<a name="line2096">2096: </a>  }

<a name="line2098">2098: </a>  <font color="#B22222">/* Fit points with cubic */</font>
<a name="line2099">2099: </a>  count = 1;
<a name="line2100">2100: </a>  <font color="#4169E1">while</font> (<A href="../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</A>) {
<a name="line2101">2101: </a>    <font color="#4169E1">if</font> (lambda &lt;= minlambda) {
<a name="line2102">2102: </a>      <font color="#4169E1">if</font> (vi-&gt;lsmonitor) {
<a name="line2103">2103: </a>        <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIAddTab.html#PetscViewerASCIIAddTab">PetscViewerASCIIAddTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2104">2104: </a>         <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(vi-&gt;lsmonitor,<font color="#666666">"    Line search: unable to find good step length! After %D tries \n"</font>,count);
<a name="line2105">2105: </a>        <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(vi-&gt;lsmonitor,<font color="#666666">"    Line search: fnorm=%18.16e, gnorm=%18.16e, ynorm=%18.16e, minlambda=%18.16e, lambda=%18.16e, initial slope=%18.16e\n"</font>,fnorm,*gnorm,*ynorm,minlambda,lambda,initslope);
<a name="line2106">2106: </a>        <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIISubtractTab.html#PetscViewerASCIISubtractTab">PetscViewerASCIISubtractTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2107">2107: </a>      }
<a name="line2108">2108: </a>      *flag = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;
<a name="line2109">2109: </a>      <font color="#4169E1">break</font>;
<a name="line2110">2110: </a>    }
<a name="line2111">2111: </a>    t1 = .5*((*gnorm)*(*gnorm) - fnorm*fnorm) - lambda*initslope;
<a name="line2112">2112: </a>    t2 = .5*(gnormprev*gnormprev  - fnorm*fnorm) - lambdaprev*initslope;
<a name="line2113">2113: </a>    a  = (t1/(lambda*lambda) - t2/(lambdaprev*lambdaprev))/(lambda-lambdaprev);
<a name="line2114">2114: </a>    b  = (-lambdaprev*t1/(lambda*lambda) + lambda*t2/(lambdaprev*lambdaprev))/(lambda-lambdaprev);
<a name="line2115">2115: </a>    d  = b*b - 3*a*initslope;
<a name="line2116">2116: </a>    <font color="#4169E1">if</font> (d &lt; 0.0) d = 0.0;
<a name="line2117">2117: </a>    <font color="#4169E1">if</font> (a == 0.0) {
<a name="line2118">2118: </a>      lambdatemp = -initslope/(2.0*b);
<a name="line2119">2119: </a>    } <font color="#4169E1">else</font> {
<a name="line2120">2120: </a>      lambdatemp = (-b + sqrt(d))/(3.0*a);
<a name="line2121">2121: </a>    }
<a name="line2122">2122: </a>    lambdaprev = lambda;
<a name="line2123">2123: </a>    gnormprev  = *gnorm;
<a name="line2124">2124: </a>    <font color="#4169E1">if</font> (lambdatemp &gt; .5*lambda)  lambdatemp = .5*lambda;
<a name="line2125">2125: </a>    <font color="#4169E1">if</font> (lambdatemp &lt;= .1*lambda) lambda     = .1*lambda;
<a name="line2126">2126: </a>    <font color="#4169E1">else</font>                         lambda     = lambdatemp;
<a name="line2127">2127: </a>    <A href="../../../../docs/manualpages/Vec/VecWAXPY.html#VecWAXPY">VecWAXPY</A>(w,-lambda,y,x);
<a name="line2128">2128: </a>    SNESVIProjectOntoBounds(snes,w);
<a name="line2129">2129: </a>    <font color="#4169E1">if</font> (snes-&gt;nfuncs &gt;= snes-&gt;max_funcs) {
<a name="line2130">2130: </a>      PetscInfo1(snes,<font color="#666666">"Exceeded maximum function evaluations, while looking for good step length! %D \n"</font>,count);
<a name="line2131">2131: </a>      PetscInfo5(snes,<font color="#666666">"fnorm=%18.16e, gnorm=%18.16e, ynorm=%18.16e, lambda=%18.16e, initial slope=%18.16e\n"</font>,fnorm,*gnorm,*ynorm,lambda,initslope);
<a name="line2132">2132: </a>      *flag = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;
<a name="line2133">2133: </a>      snes-&gt;reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_FUNCTION_COUNT.html#SNES_DIVERGED_FUNCTION_COUNT">SNES_DIVERGED_FUNCTION_COUNT</A>;
<a name="line2134">2134: </a>      <font color="#4169E1">break</font>;
<a name="line2135">2135: </a>    }
<a name="line2136">2136: </a>    <A href="../../../../docs/manualpages/SNES/SNESComputeFunction.html#SNESComputeFunction">SNESComputeFunction</A>(snes,w,g);
<a name="line2137">2137: </a>    <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve != SNESSolveVI_SS) {
<a name="line2138">2138: </a>      SNESVIComputeInactiveSetFnorm(snes,g,w,gnorm);
<a name="line2139">2139: </a>    } <font color="#4169E1">else</font> {
<a name="line2140">2140: </a>      <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(g,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,gnorm);
<a name="line2141">2141: </a>    }
<a name="line2142">2142: </a>    <font color="#4169E1">if</font> (snes-&gt;domainerror) {
<a name="line2143">2143: </a>      <A href="../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</A>(SNES_LineSearch,snes,x,f,g);
<a name="line2144">2144: </a>      <font color="#4169E1">return</font>(0);
<a name="line2145">2145: </a>    }
<a name="line2146">2146: </a>    <font color="#4169E1">if</font> (PetscIsInfOrNanReal(*gnorm)) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_FP,<font color="#666666">"User provided compute function generated a Not-a-Number"</font>);
<a name="line2147">2147: </a>    <font color="#4169E1">if</font> ((*gnorm)*(*gnorm) &lt; (1.0 - vi-&gt;alpha)*fnorm*fnorm) { <font color="#B22222">/* is reduction enough? */</font>
<a name="line2148">2148: </a>      <font color="#4169E1">if</font> (vi-&gt;lsmonitor) {
<a name="line2149">2149: </a>        <A href="../../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</A>(comm,<font color="#666666">"    Line search: Cubically determined step, current gnorm %g lambda=%18.16e\n"</font>,(double)*gnorm,(double)lambda);
<a name="line2150">2150: </a>      }
<a name="line2151">2151: </a>      <font color="#4169E1">break</font>;
<a name="line2152">2152: </a>    } <font color="#4169E1">else</font> {
<a name="line2153">2153: </a>      <font color="#4169E1">if</font> (vi-&gt;lsmonitor) {
<a name="line2154">2154: </a>        <A href="../../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</A>(comm,<font color="#666666">"    Line search: Cubic step no good, shrinking lambda, current gnorm %g lambda=%18.16e\n"</font>,(double)*gnorm,(double)lambda);
<a name="line2155">2155: </a>      }
<a name="line2156">2156: </a>    }
<a name="line2157">2157: </a>    count++;
<a name="line2158">2158: </a>  }
<a name="line2159">2159: </a><strong><font color="#FF0000">  theend1:</font></strong>
<a name="line2160">2160: </a>  <font color="#B22222">/* Optional user-defined check for line search step validity */</font>
<a name="line2161">2161: </a>  <font color="#4169E1">if</font> (vi-&gt;postcheckstep &amp;&amp; *flag) {
<a name="line2162">2162: </a>    (*vi-&gt;postcheckstep)(snes,x,y,w,vi-&gt;postcheck,&amp;changed_y,&amp;changed_w);
<a name="line2163">2163: </a>    <font color="#4169E1">if</font> (changed_y) {
<a name="line2164">2164: </a>      <A href="../../../../docs/manualpages/Vec/VecWAXPY.html#VecWAXPY">VecWAXPY</A>(w,-1.0,y,x);
<a name="line2165">2165: </a>      SNESVIProjectOntoBounds(snes,w);
<a name="line2166">2166: </a>    }
<a name="line2167">2167: </a>    <font color="#4169E1">if</font> (changed_y || changed_w) { <font color="#B22222">/* recompute the function if the step has changed */</font>
<a name="line2168">2168: </a>      <A href="../../../../docs/manualpages/SNES/SNESComputeFunction.html#SNESComputeFunction">SNESComputeFunction</A>(snes,w,g);
<a name="line2169">2169: </a>      <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve != SNESSolveVI_SS) {
<a name="line2170">2170: </a>        SNESVIComputeInactiveSetFnorm(snes,g,w,gnorm);
<a name="line2171">2171: </a>      } <font color="#4169E1">else</font> {
<a name="line2172">2172: </a>        <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(g,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,gnorm);
<a name="line2173">2173: </a>      }
<a name="line2174">2174: </a>      <font color="#4169E1">if</font> (snes-&gt;domainerror) {
<a name="line2175">2175: </a>        <A href="../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</A>(SNES_LineSearch,snes,x,f,g);
<a name="line2176">2176: </a>        <font color="#4169E1">return</font>(0);
<a name="line2177">2177: </a>      }
<a name="line2178">2178: </a>      <font color="#4169E1">if</font> (PetscIsInfOrNanReal(*gnorm)) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_FP,<font color="#666666">"User provided compute function generated a Not-a-Number"</font>);
<a name="line2179">2179: </a>      <A href="../../../../docs/manualpages/Vec/VecNormBegin.html#VecNormBegin">VecNormBegin</A>(y,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,ynorm);
<a name="line2180">2180: </a>      <A href="../../../../docs/manualpages/Vec/VecNormEnd.html#VecNormEnd">VecNormEnd</A>(y,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,ynorm);
<a name="line2181">2181: </a>    }
<a name="line2182">2182: </a>  }
<a name="line2183">2183: </a>  <A href="../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</A>(SNES_LineSearch,snes,x,f,g);
<a name="line2184">2184: </a>  <font color="#4169E1">return</font>(0);
<a name="line2185">2185: </a>}

<a name="line2189">2189: </a><font color="#B22222">/*</font>
<a name="line2190">2190: </a><font color="#B22222">  This routine does a quadratic line search while keeping the iterates within the variable bounds</font>
<a name="line2191">2191: </a><font color="#B22222">*/</font>
<a name="line2192">2192: </a><strong><font color="#4169E1"><a name="SNESLineSearchQuadratic_VI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESLineSearchQuadratic_VI(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,void *lsctx,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> x,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> f,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> g,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> y,<A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> w,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> fnorm,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> xnorm,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> *ynorm,<A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A> *gnorm,<A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A> *flag)</font></strong>
<a name="line2193">2193: </a>{
<a name="line2194">2194: </a>  <font color="#B22222">/* </font>
<a name="line2195">2195: </a><font color="#B22222">     Note that for line search purposes we work with with the related</font>
<a name="line2196">2196: </a><font color="#B22222">     minimization problem:</font>
<a name="line2197">2197: </a><font color="#B22222">        min  z(x):  R^n -&gt; R,</font>
<a name="line2198">2198: </a><font color="#B22222">     where z(x) = .5 * fnorm*fnorm,and fnorm = || f ||_2.</font>
<a name="line2199">2199: </a><font color="#B22222">   */</font>
<a name="line2200">2200: </a>  <A href="../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</A>      initslope,minlambda,lambda,lambdatemp,rellength;
<a name="line2201">2201: </a><font color="#A020F0">#if defined(PETSC_USE_COMPLEX)</font>
<a name="line2202">2202: </a>  <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>    cinitslope;
<a name="line2203">2203: </a><font color="#A020F0">#endif</font>
<a name="line2205">2205: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       count;
<a name="line2206">2206: </a>  SNES_VI        *vi = (SNES_VI*)snes-&gt;data;
<a name="line2207">2207: </a>  <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A>     changed_w = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>,changed_y = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;

<a name="line2210">2210: </a>  <A href="../../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</A>(SNES_LineSearch,snes,x,f,g);
<a name="line2211">2211: </a>  *flag   = <A href="../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</A>;

<a name="line2213">2213: </a>  <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(y,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,ynorm);
<a name="line2214">2214: </a>  <font color="#4169E1">if</font> (*ynorm == 0.0) {
<a name="line2215">2215: </a>    <font color="#4169E1">if</font> (vi-&gt;lsmonitor) {
<a name="line2216">2216: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIAddTab.html#PetscViewerASCIIAddTab">PetscViewerASCIIAddTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2217">2217: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(vi-&gt;lsmonitor,<font color="#666666">"Line search: Direction and size is 0\n"</font>);
<a name="line2218">2218: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIISubtractTab.html#PetscViewerASCIISubtractTab">PetscViewerASCIISubtractTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2219">2219: </a>    }
<a name="line2220">2220: </a>    *gnorm = fnorm;
<a name="line2221">2221: </a>    <A href="../../../../docs/manualpages/Vec/VecCopy.html#VecCopy">VecCopy</A>(x,w);
<a name="line2222">2222: </a>    <A href="../../../../docs/manualpages/Vec/VecCopy.html#VecCopy">VecCopy</A>(f,g);
<a name="line2223">2223: </a>    *flag  = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;
<a name="line2224">2224: </a>    <font color="#4169E1">goto</font> theend2;
<a name="line2225">2225: </a>  }
<a name="line2226">2226: </a>  <font color="#4169E1">if</font> (*ynorm &gt; vi-&gt;maxstep) {        <font color="#B22222">/* Step too big, so scale back */</font>
<a name="line2227">2227: </a>    <A href="../../../../docs/manualpages/Vec/VecScale.html#VecScale">VecScale</A>(y,vi-&gt;maxstep/(*ynorm));
<a name="line2228">2228: </a>    *ynorm = vi-&gt;maxstep;
<a name="line2229">2229: </a>  }
<a name="line2230">2230: </a>  <A href="../../../../docs/manualpages/Vec/VecMaxPointwiseDivide.html#VecMaxPointwiseDivide">VecMaxPointwiseDivide</A>(y,x,&amp;rellength);
<a name="line2231">2231: </a>  minlambda = vi-&gt;minlambda/rellength;
<a name="line2232">2232: </a>  <A href="../../../../docs/manualpages/Mat/MatMult.html#MatMult">MatMult</A>(snes-&gt;jacobian,y,w);
<a name="line2233">2233: </a><font color="#A020F0">#if defined(PETSC_USE_COMPLEX)</font>
<a name="line2234">2234: </a>  <A href="../../../../docs/manualpages/Vec/VecDot.html#VecDot">VecDot</A>(f,w,&amp;cinitslope);
<a name="line2235">2235: </a>  initslope = PetscRealPart(cinitslope);
<a name="line2236">2236: </a><font color="#A020F0">#else</font>
<a name="line2237">2237: </a>  <A href="../../../../docs/manualpages/Vec/VecDot.html#VecDot">VecDot</A>(f,w,&amp;initslope);
<a name="line2238">2238: </a><font color="#A020F0">#endif</font>
<a name="line2239">2239: </a>  <font color="#4169E1">if</font> (initslope &gt; 0.0)  initslope = -initslope;
<a name="line2240">2240: </a>  <font color="#4169E1">if</font> (initslope == 0.0) initslope = -1.0;
<a name="line2241">2241: </a>  PetscInfo1(snes,<font color="#666666">"Initslope %G \n"</font>,initslope);

<a name="line2243">2243: </a>  <A href="../../../../docs/manualpages/Vec/VecWAXPY.html#VecWAXPY">VecWAXPY</A>(w,-1.0,y,x);
<a name="line2244">2244: </a>  SNESVIProjectOntoBounds(snes,w);
<a name="line2245">2245: </a>  <font color="#4169E1">if</font> (snes-&gt;nfuncs &gt;= snes-&gt;max_funcs) {
<a name="line2246">2246: </a>    <A href="../../../../docs/manualpages/Profiling/PetscInfo.html#PetscInfo">PetscInfo</A>(snes,<font color="#666666">"Exceeded maximum function evaluations, while checking full step length!\n"</font>);
<a name="line2247">2247: </a>    *flag = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;
<a name="line2248">2248: </a>    snes-&gt;reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_FUNCTION_COUNT.html#SNES_DIVERGED_FUNCTION_COUNT">SNES_DIVERGED_FUNCTION_COUNT</A>;
<a name="line2249">2249: </a>    <font color="#4169E1">goto</font> theend2;
<a name="line2250">2250: </a>  }
<a name="line2251">2251: </a>  <A href="../../../../docs/manualpages/SNES/SNESComputeFunction.html#SNESComputeFunction">SNESComputeFunction</A>(snes,w,g);
<a name="line2252">2252: </a>  <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve != SNESSolveVI_SS) {
<a name="line2253">2253: </a>    SNESVIComputeInactiveSetFnorm(snes,g,w,gnorm);
<a name="line2254">2254: </a>  } <font color="#4169E1">else</font> {
<a name="line2255">2255: </a>    <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(g,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,gnorm);
<a name="line2256">2256: </a>  }
<a name="line2257">2257: </a>  <font color="#4169E1">if</font> (snes-&gt;domainerror) {
<a name="line2258">2258: </a>    <A href="../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</A>(SNES_LineSearch,snes,x,f,g);
<a name="line2259">2259: </a>    <font color="#4169E1">return</font>(0);
<a name="line2260">2260: </a>  }
<a name="line2261">2261: </a>  <font color="#4169E1">if</font> (PetscIsInfOrNanReal(*gnorm)) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_FP,<font color="#666666">"User provided compute function generated a Not-a-Number"</font>);
<a name="line2262">2262: </a>  <font color="#4169E1">if</font> ((*gnorm)*(*gnorm) &lt;= (1.0 - vi-&gt;alpha)*fnorm*fnorm) { <font color="#B22222">/* Sufficient reduction */</font>
<a name="line2263">2263: </a>    <font color="#4169E1">if</font> (vi-&gt;lsmonitor) {
<a name="line2264">2264: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIAddTab.html#PetscViewerASCIIAddTab">PetscViewerASCIIAddTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2265">2265: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(vi-&gt;lsmonitor,<font color="#666666">"    Line search: Using full step: fnorm %G gnorm %G\n"</font>,fnorm,*gnorm);
<a name="line2266">2266: </a>      <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIISubtractTab.html#PetscViewerASCIISubtractTab">PetscViewerASCIISubtractTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2267">2267: </a>    }
<a name="line2268">2268: </a>    <font color="#4169E1">goto</font> theend2;
<a name="line2269">2269: </a>  }

<a name="line2271">2271: </a>  <font color="#B22222">/* Fit points with quadratic */</font>
<a name="line2272">2272: </a>  lambda = 1.0;
<a name="line2273">2273: </a>  count = 1;
<a name="line2274">2274: </a>  <font color="#4169E1">while</font> (<A href="../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</A>) {
<a name="line2275">2275: </a>    <font color="#4169E1">if</font> (lambda &lt;= minlambda) { <font color="#B22222">/* bad luck; use full step */</font>
<a name="line2276">2276: </a>      <font color="#4169E1">if</font> (vi-&gt;lsmonitor) {
<a name="line2277">2277: </a>        <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIAddTab.html#PetscViewerASCIIAddTab">PetscViewerASCIIAddTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2278">2278: </a>        <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(vi-&gt;lsmonitor,<font color="#666666">"Line search: Unable to find good step length! %D \n"</font>,count);
<a name="line2279">2279: </a>        <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(vi-&gt;lsmonitor,<font color="#666666">"Line search: fnorm=%G, gnorm=%G, ynorm=%G, lambda=%G, initial slope=%G\n"</font>,fnorm,*gnorm,*ynorm,lambda,initslope);
<a name="line2280">2280: </a>        <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIISubtractTab.html#PetscViewerASCIISubtractTab">PetscViewerASCIISubtractTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2281">2281: </a>      }
<a name="line2282">2282: </a>      <A href="../../../../docs/manualpages/Vec/VecCopy.html#VecCopy">VecCopy</A>(x,w);
<a name="line2283">2283: </a>      *flag = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;
<a name="line2284">2284: </a>      <font color="#4169E1">break</font>;
<a name="line2285">2285: </a>    }
<a name="line2286">2286: </a>    lambdatemp = -initslope/((*gnorm)*(*gnorm) - fnorm*fnorm - 2.0*initslope);
<a name="line2287">2287: </a>    <font color="#4169E1">if</font> (lambdatemp &gt; .5*lambda)  lambdatemp = .5*lambda;
<a name="line2288">2288: </a>    <font color="#4169E1">if</font> (lambdatemp &lt;= .1*lambda) lambda     = .1*lambda;
<a name="line2289">2289: </a>    <font color="#4169E1">else</font>                         lambda     = lambdatemp;
<a name="line2290">2290: </a>
<a name="line2291">2291: </a>    <A href="../../../../docs/manualpages/Vec/VecWAXPY.html#VecWAXPY">VecWAXPY</A>(w,-lambda,y,x);
<a name="line2292">2292: </a>    SNESVIProjectOntoBounds(snes,w);
<a name="line2293">2293: </a>    <font color="#4169E1">if</font> (snes-&gt;nfuncs &gt;= snes-&gt;max_funcs) {
<a name="line2294">2294: </a>      PetscInfo1(snes,<font color="#666666">"Exceeded maximum function evaluations, while looking for good step length! %D \n"</font>,count);
<a name="line2295">2295: </a>      PetscInfo5(snes,<font color="#666666">"fnorm=%18.16e, gnorm=%18.16e, ynorm=%18.16e, lambda=%18.16e, initial slope=%18.16e\n"</font>,fnorm,*gnorm,*ynorm,lambda,initslope);
<a name="line2296">2296: </a>      *flag = <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>;
<a name="line2297">2297: </a>      snes-&gt;reason = <A href="../../../../docs/manualpages/SNES/SNES_DIVERGED_FUNCTION_COUNT.html#SNES_DIVERGED_FUNCTION_COUNT">SNES_DIVERGED_FUNCTION_COUNT</A>;
<a name="line2298">2298: </a>      <font color="#4169E1">break</font>;
<a name="line2299">2299: </a>    }
<a name="line2300">2300: </a>    <A href="../../../../docs/manualpages/SNES/SNESComputeFunction.html#SNESComputeFunction">SNESComputeFunction</A>(snes,w,g);
<a name="line2301">2301: </a>    <font color="#4169E1">if</font> (snes-&gt;domainerror) {
<a name="line2302">2302: </a>      <A href="../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</A>(SNES_LineSearch,snes,x,f,g);
<a name="line2303">2303: </a>      <font color="#4169E1">return</font>(0);
<a name="line2304">2304: </a>    }
<a name="line2305">2305: </a>    <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve != SNESSolveVI_SS) {
<a name="line2306">2306: </a>      SNESVIComputeInactiveSetFnorm(snes,g,w,gnorm);
<a name="line2307">2307: </a>    } <font color="#4169E1">else</font> {
<a name="line2308">2308: </a>      <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(g,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,gnorm);
<a name="line2309">2309: </a>    }
<a name="line2310">2310: </a>    <font color="#4169E1">if</font> (PetscIsInfOrNanReal(*gnorm)) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_FP,<font color="#666666">"User provided compute function generated a Not-a-Number"</font>);
<a name="line2311">2311: </a>    <font color="#4169E1">if</font> ((*gnorm)*(*gnorm) &lt; (1.0 - vi-&gt;alpha)*fnorm*fnorm) { <font color="#B22222">/* sufficient reduction */</font>
<a name="line2312">2312: </a>      <font color="#4169E1">if</font> (vi-&gt;lsmonitor) {
<a name="line2313">2313: </a>        <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIAddTab.html#PetscViewerASCIIAddTab">PetscViewerASCIIAddTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2314">2314: </a>        <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(vi-&gt;lsmonitor,<font color="#666666">"    Line Search: Quadratically determined step, lambda=%G\n"</font>,lambda);
<a name="line2315">2315: </a>        <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIISubtractTab.html#PetscViewerASCIISubtractTab">PetscViewerASCIISubtractTab</A>(vi-&gt;lsmonitor,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;tablevel);
<a name="line2316">2316: </a>      }
<a name="line2317">2317: </a>      <font color="#4169E1">break</font>;
<a name="line2318">2318: </a>    }
<a name="line2319">2319: </a>    count++;
<a name="line2320">2320: </a>  }
<a name="line2321">2321: </a><strong><font color="#FF0000">  theend2:</font></strong>
<a name="line2322">2322: </a>  <font color="#B22222">/* Optional user-defined check for line search step validity */</font>
<a name="line2323">2323: </a>  <font color="#4169E1">if</font> (vi-&gt;postcheckstep) {
<a name="line2324">2324: </a>    (*vi-&gt;postcheckstep)(snes,x,y,w,vi-&gt;postcheck,&amp;changed_y,&amp;changed_w);
<a name="line2325">2325: </a>    <font color="#4169E1">if</font> (changed_y) {
<a name="line2326">2326: </a>      <A href="../../../../docs/manualpages/Vec/VecWAXPY.html#VecWAXPY">VecWAXPY</A>(w,-1.0,y,x);
<a name="line2327">2327: </a>      SNESVIProjectOntoBounds(snes,w);
<a name="line2328">2328: </a>    }
<a name="line2329">2329: </a>    <font color="#4169E1">if</font> (changed_y || changed_w) { <font color="#B22222">/* recompute the function if the step has changed */</font>
<a name="line2330">2330: </a>      <A href="../../../../docs/manualpages/SNES/SNESComputeFunction.html#SNESComputeFunction">SNESComputeFunction</A>(snes,w,g);
<a name="line2331">2331: </a>      <font color="#4169E1">if</font> (snes-&gt;domainerror) {
<a name="line2332">2332: </a>        <A href="../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</A>(SNES_LineSearch,snes,x,f,g);
<a name="line2333">2333: </a>        <font color="#4169E1">return</font>(0);
<a name="line2334">2334: </a>      }
<a name="line2335">2335: </a>      <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve != SNESSolveVI_SS) {
<a name="line2336">2336: </a>        SNESVIComputeInactiveSetFnorm(snes,g,w,gnorm);
<a name="line2337">2337: </a>      } <font color="#4169E1">else</font> {
<a name="line2338">2338: </a>        <A href="../../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</A>(g,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,gnorm);
<a name="line2339">2339: </a>      }

<a name="line2341">2341: </a>      <A href="../../../../docs/manualpages/Vec/VecNormBegin.html#VecNormBegin">VecNormBegin</A>(y,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,ynorm);
<a name="line2342">2342: </a>      <A href="../../../../docs/manualpages/Vec/VecNormEnd.html#VecNormEnd">VecNormEnd</A>(y,<A href="../../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</A>,ynorm);
<a name="line2343">2343: </a>      <font color="#4169E1">if</font> (PetscIsInfOrNanReal(*gnorm)) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_FP,<font color="#666666">"User provided compute function generated a Not-a-Number"</font>);
<a name="line2344">2344: </a>    }
<a name="line2345">2345: </a>  }
<a name="line2346">2346: </a>  <A href="../../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</A>(SNES_LineSearch,snes,x,f,g);
<a name="line2347">2347: </a>  <font color="#4169E1">return</font>(0);
<a name="line2348">2348: </a>}

<a name="line2351">2351: </a><font color="#B22222">/* -------------------------------------------------------------------------- */</font>
<a name="line2355">2355: </a><strong><font color="#4169E1"><a name="SNESLineSearchSet_VI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>  SNESLineSearchSet_VI(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,FCN2 func,void *lsctx)</font></strong>
<a name="line2356">2356: </a>{
<a name="line2358">2358: </a>  ((SNES_VI *)(snes-&gt;data))-&gt;LineSearch = func;
<a name="line2359">2359: </a>  ((SNES_VI *)(snes-&gt;data))-&gt;lsP        = lsctx;
<a name="line2360">2360: </a>  <font color="#4169E1">return</font>(0);
<a name="line2361">2361: </a>}

<a name="line2364">2364: </a><font color="#B22222">/* -------------------------------------------------------------------------- */</font>
<a name="line2368">2368: </a><strong><font color="#4169E1"><a name="SNESLineSearchSetMonitor_VI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>  SNESLineSearchSetMonitor_VI(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A> flg)</font></strong>
<a name="line2369">2369: </a>{
<a name="line2370">2370: </a>  SNES_VI        *vi = (SNES_VI*)snes-&gt;data;

<a name="line2374">2374: </a>  <font color="#4169E1">if</font> (flg &amp;&amp; !vi-&gt;lsmonitor) {
<a name="line2375">2375: </a>    <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIOpen.html#PetscViewerASCIIOpen">PetscViewerASCIIOpen</A>(((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm,<font color="#666666">"stdout"</font>,&amp;vi-&gt;lsmonitor);
<a name="line2376">2376: </a>  } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (!flg &amp;&amp; vi-&gt;lsmonitor) {
<a name="line2377">2377: </a>    <A href="../../../../docs/manualpages/Viewer/PetscViewerDestroy.html#PetscViewerDestroy">PetscViewerDestroy</A>(&amp;vi-&gt;lsmonitor);
<a name="line2378">2378: </a>  }
<a name="line2379">2379: </a>  <font color="#4169E1">return</font>(0);
<a name="line2380">2380: </a>}

<a name="line2383">2383: </a><font color="#B22222">/*</font>
<a name="line2384">2384: </a><font color="#B22222">   SNESView_VI - Prints info from the <A href="../../../../docs/manualpages/SNES/SNESVI.html#SNESVI">SNESVI</A> data structure.</font>

<a name="line2386">2386: </a><font color="#B22222">   Input Parameters:</font>
<a name="line2387">2387: </a><font color="#B22222">.  <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> - the <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> context</font>
<a name="line2388">2388: </a><font color="#B22222">.  viewer - visualization context</font>

<a name="line2390">2390: </a><font color="#B22222">   Application Interface Routine: <A href="../../../../docs/manualpages/SNES/SNESView.html#SNESView">SNESView</A>()</font>
<a name="line2391">2391: </a><font color="#B22222">*/</font>
<a name="line2394">2394: </a><strong><font color="#4169E1"><a name="SNESView_VI"></a>static <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESView_VI(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/Viewer/PetscViewer.html#PetscViewer">PetscViewer</A> viewer)</font></strong>
<a name="line2395">2395: </a>{
<a name="line2396">2396: </a>  SNES_VI        *vi = (SNES_VI *)snes-&gt;data;
<a name="line2397">2397: </a>  const char     *cstr,*tstr;
<a name="line2399">2399: </a>  <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A>     iascii;

<a name="line2402">2402: </a>  <A href="../../../../docs/manualpages/Sys/PetscTypeCompare.html#PetscTypeCompare">PetscTypeCompare</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)viewer,PETSCVIEWERASCII,&amp;iascii);
<a name="line2403">2403: </a>  <font color="#4169E1">if</font> (iascii) {
<a name="line2404">2404: </a>    <font color="#4169E1">if</font> (vi-&gt;LineSearch == SNESLineSearchNo_VI)             cstr = <font color="#666666">"<A href="../../../../docs/manualpages/SNES/SNESLineSearchNo.html#SNESLineSearchNo">SNESLineSearchNo</A>"</font>;
<a name="line2405">2405: </a>    <font color="#4169E1">else</font> <font color="#4169E1">if</font> (vi-&gt;LineSearch == SNESLineSearchQuadratic_VI) cstr = <font color="#666666">"<A href="../../../../docs/manualpages/SNES/SNESLineSearchQuadratic.html#SNESLineSearchQuadratic">SNESLineSearchQuadratic</A>"</font>;
<a name="line2406">2406: </a>    <font color="#4169E1">else</font> <font color="#4169E1">if</font> (vi-&gt;LineSearch == SNESLineSearchCubic_VI)     cstr = <font color="#666666">"<A href="../../../../docs/manualpages/SNES/SNESLineSearchCubic.html#SNESLineSearchCubic">SNESLineSearchCubic</A>"</font>;
<a name="line2407">2407: </a>    <font color="#4169E1">else</font>                                                   cstr = <font color="#666666">"unknown"</font>;
<a name="line2408">2408: </a>    <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve == SNESSolveVI_SS)         tstr = <font color="#666666">"Semismooth"</font>;
<a name="line2409">2409: </a>    <font color="#4169E1">else</font> <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve == SNESSolveVI_RS)    tstr = <font color="#666666">"Reduced Space"</font>;
<a name="line2410">2410: </a>    <font color="#4169E1">else</font> <font color="#4169E1">if</font> (snes-&gt;ops-&gt;solve == SNESSolveVI_RSAUG) tstr = <font color="#666666">"Reduced space with augmented variables"</font>;
<a name="line2411">2411: </a>    <font color="#4169E1">else</font>                                         tstr = <font color="#666666">"unknown"</font>;
<a name="line2412">2412: </a>    <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(viewer,<font color="#666666">"  VI algorithm: %s\n"</font>,tstr);
<a name="line2413">2413: </a>    <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(viewer,<font color="#666666">"  line search variant: %s\n"</font>,cstr);
<a name="line2414">2414: </a>    <A href="../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</A>(viewer,<font color="#666666">"  alpha=%G, maxstep=%G, minlambda=%G\n"</font>,vi-&gt;alpha,vi-&gt;maxstep,vi-&gt;minlambda);
<a name="line2415">2415: </a>  }
<a name="line2416">2416: </a>  <font color="#4169E1">return</font>(0);
<a name="line2417">2417: </a>}

<a name="line2421">2421: </a><font color="#B22222">/*@</font>
<a name="line2422">2422: </a><font color="#B22222">   <A href="../../../../docs/manualpages/SNES/SNESVISetVariableBounds.html#SNESVISetVariableBounds">SNESVISetVariableBounds</A> - Sets the lower and upper bounds for the solution vector. xl &lt;= x &lt;= xu.</font>

<a name="line2424">2424: </a><font color="#B22222">   Input Parameters:</font>
<a name="line2425">2425: </a><font color="#B22222">.  snes - the <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> context.</font>
<a name="line2426">2426: </a><font color="#B22222">.  xl   - lower bound.</font>
<a name="line2427">2427: </a><font color="#B22222">.  xu   - upper bound.</font>

<a name="line2429">2429: </a><font color="#B22222">   Notes:</font>
<a name="line2430">2430: </a><font color="#B22222">   If this routine is not called then the lower and upper bounds are set to </font>
<a name="line2431">2431: </a><font color="#B22222">   SNES_VI_INF and SNES_VI_NINF respectively during <A href="../../../../docs/manualpages/SNES/SNESSetUp.html#SNESSetUp">SNESSetUp</A>().</font>

<a name="line2433">2433: </a><font color="#B22222">   Level: advanced</font>

<a name="line2435">2435: </a><font color="#B22222">@*/</font>
<a name="line2436">2436: </a><strong><font color="#4169E1"><a name="SNESVISetVariableBounds"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> <A href="../../../../docs/manualpages/SNES/SNESVISetVariableBounds.html#SNESVISetVariableBounds">SNESVISetVariableBounds</A>(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes, <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> xl, <A href="../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A> xu)</font></strong>
<a name="line2437">2437: </a>{
<a name="line2438">2438: </a>  SNES_VI           *vi;
<a name="line2439">2439: </a>  <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>    ierr;
<a name="line2440">2440: </a>  const <A href="../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> *xxl,*xxu;
<a name="line2441">2441: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>          i,n, cnt = 0;

<a name="line2447">2447: </a>  <font color="#4169E1">if</font> (!snes-&gt;vec_func) <A href="../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_ARG_WRONGSTATE,<font color="#666666">"Must call <A href="../../../../docs/manualpages/SNES/SNESSetFunction.html#SNESSetFunction">SNESSetFunction</A>() first"</font>);
<a name="line2448">2448: </a>  <font color="#4169E1">if</font> (xl-&gt;map-&gt;N != snes-&gt;vec_func-&gt;map-&gt;N) <A href="../../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_ARG_INCOMP,<font color="#666666">"Incompatible vector lengths lower bound = %D solution vector = %D"</font>,xl-&gt;map-&gt;N,snes-&gt;vec_func-&gt;map-&gt;N);
<a name="line2449">2449: </a>  <font color="#4169E1">if</font> (xu-&gt;map-&gt;N != snes-&gt;vec_func-&gt;map-&gt;N) <A href="../../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</A>(<A href="../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,PETSC_ERR_ARG_INCOMP,<font color="#666666">"Incompatible vector lengths: upper bound = %D solution vector = %D"</font>,xu-&gt;map-&gt;N,snes-&gt;vec_func-&gt;map-&gt;N);
<a name="line2450">2450: </a>  <A href="../../../../docs/manualpages/SNES/SNESSetType.html#SNESSetType">SNESSetType</A>(snes,<A href="../../../../docs/manualpages/SNES/SNESVI.html#SNESVI">SNESVI</A>);
<a name="line2451">2451: </a>  vi = (SNES_VI*)snes-&gt;data;
<a name="line2452">2452: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectReference.html#PetscObjectReference">PetscObjectReference</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)xl);
<a name="line2453">2453: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectReference.html#PetscObjectReference">PetscObjectReference</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)xu);
<a name="line2454">2454: </a>  <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;vi-&gt;xl);
<a name="line2455">2455: </a>  <A href="../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(&amp;vi-&gt;xu);
<a name="line2456">2456: </a>  vi-&gt;xl = xl;
<a name="line2457">2457: </a>  vi-&gt;xu = xu;
<a name="line2458">2458: </a>  <A href="../../../../docs/manualpages/Vec/VecGetLocalSize.html#VecGetLocalSize">VecGetLocalSize</A>(xl,&amp;n);
<a name="line2459">2459: </a>  VecGetArrayRead(xl,&amp;xxl);
<a name="line2460">2460: </a>  VecGetArrayRead(xu,&amp;xxu);
<a name="line2461">2461: </a>  <font color="#4169E1">for</font> (i=0; i&lt;n; i++) {
<a name="line2462">2462: </a>    cnt += ((xxl[i] != SNES_VI_NINF) || (xxu[i] != SNES_VI_INF));
<a name="line2463">2463: </a>  }
<a name="line2464">2464: </a>  <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Allreduce.html#MPI_Allreduce">MPI_Allreduce</A>(&amp;cnt,&amp;vi-&gt;ntruebounds,1,MPIU_INT,MPI_SUM,((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes)-&gt;comm);
<a name="line2465">2465: </a>  VecRestoreArrayRead(xl,&amp;xxl);
<a name="line2466">2466: </a>  VecRestoreArrayRead(xu,&amp;xxu);
<a name="line2467">2467: </a>  <font color="#4169E1">return</font>(0);
<a name="line2468">2468: </a>}

<a name="line2470">2470: </a><font color="#B22222">/* -------------------------------------------------------------------------- */</font>
<a name="line2471">2471: </a><font color="#B22222">/*</font>
<a name="line2472">2472: </a><font color="#B22222">   SNESSetFromOptions_VI - Sets various parameters for the <A href="../../../../docs/manualpages/SNES/SNESVI.html#SNESVI">SNESVI</A> method.</font>

<a name="line2474">2474: </a><font color="#B22222">   Input Parameter:</font>
<a name="line2475">2475: </a><font color="#B22222">.  snes - the <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> context</font>

<a name="line2477">2477: </a><font color="#B22222">   Application Interface Routine: <A href="../../../../docs/manualpages/SNES/SNESSetFromOptions.html#SNESSetFromOptions">SNESSetFromOptions</A>()</font>
<a name="line2478">2478: </a><font color="#B22222">*/</font>
<a name="line2481">2481: </a><strong><font color="#4169E1"><a name="SNESSetFromOptions_VI"></a>static <A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESSetFromOptions_VI(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes)</font></strong>
<a name="line2482">2482: </a>{
<a name="line2483">2483: </a>  SNES_VI        *vi = (SNES_VI *)snes-&gt;data;
<a name="line2484">2484: </a>  const char     *lses[] = {<font color="#666666">"basic"</font>,<font color="#666666">"basicnonorms"</font>,<font color="#666666">"quadratic"</font>,<font color="#666666">"cubic"</font>};
<a name="line2485">2485: </a>  const char     *vies[] = {<font color="#666666">"ss"</font>,<font color="#666666">"rs"</font>,<font color="#666666">"rsaug"</font>};
<a name="line2487">2487: </a>  <A href="../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       indx;
<a name="line2488">2488: </a>  <A href="../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</A>      flg,set,flg2;

<a name="line2491">2491: </a>  <A href="../../../../docs/manualpages/Sys/PetscOptionsHead.html#PetscOptionsHead">PetscOptionsHead</A>(<font color="#666666">"<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> semismooth method options"</font>);
<a name="line2492">2492: </a>  <A href="../../../../docs/manualpages/Sys/PetscOptionsBool.html#PetscOptionsBool">PetscOptionsBool</A>(<font color="#666666">"-snes_vi_monitor"</font>,<font color="#666666">"Monitor all non-active variables"</font>,<font color="#666666">"None"</font>,<A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>,&amp;flg,0);
<a name="line2493">2493: </a>  <font color="#4169E1">if</font> (flg) {
<a name="line2494">2494: </a>    <A href="../../../../docs/manualpages/SNES/SNESMonitorSet.html#SNESMonitorSet">SNESMonitorSet</A>(snes,SNESMonitorVI,0,0);
<a name="line2495">2495: </a>  }
<a name="line2496">2496: </a>  <A href="../../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</A>(<font color="#666666">"-snes_ls_alpha"</font>,<font color="#666666">"Function norm must decrease by"</font>,<font color="#666666">"None"</font>,vi-&gt;alpha,&amp;vi-&gt;alpha,0);
<a name="line2497">2497: </a>  <A href="../../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</A>(<font color="#666666">"-snes_ls_maxstep"</font>,<font color="#666666">"Step must be less than"</font>,<font color="#666666">"None"</font>,vi-&gt;maxstep,&amp;vi-&gt;maxstep,0);
<a name="line2498">2498: </a>  <A href="../../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</A>(<font color="#666666">"-snes_ls_minlambda"</font>,<font color="#666666">"Minimum lambda allowed"</font>,<font color="#666666">"None"</font>,vi-&gt;minlambda,&amp;vi-&gt;minlambda,0);
<a name="line2499">2499: </a>  <A href="../../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</A>(<font color="#666666">"-snes_vi_const_tol"</font>,<font color="#666666">"constraint tolerance"</font>,<font color="#666666">"None"</font>,vi-&gt;const_tol,&amp;vi-&gt;const_tol,0);
<a name="line2500">2500: </a>  <A href="../../../../docs/manualpages/Sys/PetscOptionsBool.html#PetscOptionsBool">PetscOptionsBool</A>(<font color="#666666">"-snes_ls_monitor"</font>,<font color="#666666">"Print progress of line searches"</font>,<font color="#666666">"<A href="../../../../docs/manualpages/SNES/SNESLineSearchSetMonitor.html#SNESLineSearchSetMonitor">SNESLineSearchSetMonitor</A>"</font>,vi-&gt;lsmonitor ? <A href="../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</A> : <A href="../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</A>,&amp;flg,&amp;set);
<a name="line2501">2501: </a>  <font color="#4169E1">if</font> (set) {<A href="../../../../docs/manualpages/SNES/SNESLineSearchSetMonitor.html#SNESLineSearchSetMonitor">SNESLineSearchSetMonitor</A>(snes,flg);}
<a name="line2502">2502: </a>  <A href="../../../../docs/manualpages/Sys/PetscOptionsEList.html#PetscOptionsEList">PetscOptionsEList</A>(<font color="#666666">"-snes_vi_type"</font>,<font color="#666666">"Semismooth algorithm used"</font>,<font color="#666666">""</font>,vies,3,<font color="#666666">"rs"</font>,&amp;indx,&amp;flg2);
<a name="line2503">2503: </a>  <font color="#4169E1">if</font> (flg2) {
<a name="line2504">2504: </a>    <font color="#4169E1">switch</font> (indx) {
<a name="line2505">2505: </a>    <font color="#4169E1">case</font> 0:
<a name="line2506">2506: </a>      snes-&gt;ops-&gt;solve = SNESSolveVI_SS;
<a name="line2507">2507: </a>      <font color="#4169E1">break</font>;
<a name="line2508">2508: </a>    <font color="#4169E1">case</font> 1:
<a name="line2509">2509: </a>      snes-&gt;ops-&gt;solve = SNESSolveVI_RS;
<a name="line2510">2510: </a>      <font color="#4169E1">break</font>;
<a name="line2511">2511: </a>    <font color="#4169E1">case</font> 2:
<a name="line2512">2512: </a>      snes-&gt;ops-&gt;solve = SNESSolveVI_RSAUG;
<a name="line2513">2513: </a>    }
<a name="line2514">2514: </a>  }
<a name="line2515">2515: </a>  <A href="../../../../docs/manualpages/Sys/PetscOptionsEList.html#PetscOptionsEList">PetscOptionsEList</A>(<font color="#666666">"-snes_ls"</font>,<font color="#666666">"Line search used"</font>,<font color="#666666">"<A href="../../../../docs/manualpages/SNES/SNESLineSearchSet.html#SNESLineSearchSet">SNESLineSearchSet</A>"</font>,lses,4,<font color="#666666">"cubic"</font>,&amp;indx,&amp;flg);
<a name="line2516">2516: </a>  <font color="#4169E1">if</font> (flg) {
<a name="line2517">2517: </a>    <font color="#4169E1">switch</font> (indx) {
<a name="line2518">2518: </a>    <font color="#4169E1">case</font> 0:
<a name="line2519">2519: </a>      <A href="../../../../docs/manualpages/SNES/SNESLineSearchSet.html#SNESLineSearchSet">SNESLineSearchSet</A>(snes,SNESLineSearchNo_VI,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line2520">2520: </a>      <font color="#4169E1">break</font>;
<a name="line2521">2521: </a>    <font color="#4169E1">case</font> 1:
<a name="line2522">2522: </a>      <A href="../../../../docs/manualpages/SNES/SNESLineSearchSet.html#SNESLineSearchSet">SNESLineSearchSet</A>(snes,SNESLineSearchNoNorms_VI,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line2523">2523: </a>      <font color="#4169E1">break</font>;
<a name="line2524">2524: </a>    <font color="#4169E1">case</font> 2:
<a name="line2525">2525: </a>      <A href="../../../../docs/manualpages/SNES/SNESLineSearchSet.html#SNESLineSearchSet">SNESLineSearchSet</A>(snes,SNESLineSearchQuadratic_VI,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line2526">2526: </a>      <font color="#4169E1">break</font>;
<a name="line2527">2527: </a>    <font color="#4169E1">case</font> 3:
<a name="line2528">2528: </a>      <A href="../../../../docs/manualpages/SNES/SNESLineSearchSet.html#SNESLineSearchSet">SNESLineSearchSet</A>(snes,SNESLineSearchCubic_VI,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line2529">2529: </a>      <font color="#4169E1">break</font>;
<a name="line2530">2530: </a>    }
<a name="line2531">2531: </a>  }
<a name="line2532">2532: </a>  <A href="../../../../docs/manualpages/Sys/PetscOptionsBool.html#PetscOptionsBool">PetscOptionsBool</A>(<font color="#666666">"-snes_vi_ignore_function_sign"</font>,<font color="#666666">"Ignore the sign of function for active constraints"</font>,<font color="#666666">"None"</font>,vi-&gt;ignorefunctionsign,&amp;vi-&gt;ignorefunctionsign,<A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line2533">2533: </a>  <A href="../../../../docs/manualpages/Sys/PetscOptionsTail.html#PetscOptionsTail">PetscOptionsTail</A>();
<a name="line2534">2534: </a>  <font color="#4169E1">return</font>(0);
<a name="line2535">2535: </a>}
<a name="line2536">2536: </a><font color="#B22222">/* -------------------------------------------------------------------------- */</font>
<a name="line2537">2537: </a><font color="#B22222">/*MC</font>
<a name="line2538">2538: </a><font color="#B22222">      <A href="../../../../docs/manualpages/SNES/SNESVI.html#SNESVI">SNESVI</A> - Various solvers for variational inequalities based on Newton's method</font>

<a name="line2540">2540: </a><font color="#B22222">   Options Database:</font>
<a name="line2541">2541: </a><font color="#B22222">+   -snes_vi_type &lt;ss,rs,rsaug&gt; a semi-smooth solver, a reduced space active set method and a reduced space active set method that does not eliminate the active constraints from the Jacobian instead augments the Jacobian with </font>
<a name="line2542">2542: </a><font color="#B22222">                                additional variables that enforce the constraints</font>
<a name="line2543">2543: </a><font color="#B22222">-   -snes_vi_monitor - prints the number of active constraints at each iteration.</font>


<a name="line2546">2546: </a><font color="#B22222">   Level: beginner</font>

<a name="line2548">2548: </a><font color="#B22222">.seealso:  <A href="../../../../docs/manualpages/SNES/SNESCreate.html#SNESCreate">SNESCreate</A>(), <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A>, <A href="../../../../docs/manualpages/SNES/SNESSetType.html#SNESSetType">SNESSetType</A>(), <A href="../../../../docs/manualpages/SNES/SNESTR.html#SNESTR">SNESTR</A>, <A href="../../../../docs/manualpages/SNES/SNESLineSearchSet.html#SNESLineSearchSet">SNESLineSearchSet</A>(), </font>
<a name="line2549">2549: </a><font color="#B22222">           <A href="../../../../docs/manualpages/SNES/SNESLineSearchSetPostCheck.html#SNESLineSearchSetPostCheck">SNESLineSearchSetPostCheck</A>(), <A href="../../../../docs/manualpages/SNES/SNESLineSearchNo.html#SNESLineSearchNo">SNESLineSearchNo</A>(), <A href="../../../../docs/manualpages/SNES/SNESLineSearchCubic.html#SNESLineSearchCubic">SNESLineSearchCubic</A>(), <A href="../../../../docs/manualpages/SNES/SNESLineSearchQuadratic.html#SNESLineSearchQuadratic">SNESLineSearchQuadratic</A>(), </font>
<a name="line2550">2550: </a><font color="#B22222">           <A href="../../../../docs/manualpages/SNES/SNESLineSearchSet.html#SNESLineSearchSet">SNESLineSearchSet</A>(), <A href="../../../../docs/manualpages/SNES/SNESLineSearchNoNorms.html#SNESLineSearchNoNorms">SNESLineSearchNoNorms</A>(), <A href="../../../../docs/manualpages/SNES/SNESLineSearchSetPreCheck.html#SNESLineSearchSetPreCheck">SNESLineSearchSetPreCheck</A>(), <A href="../../../../docs/manualpages/SNES/SNESLineSearchSetParams.html#SNESLineSearchSetParams">SNESLineSearchSetParams</A>(), <A href="../../../../docs/manualpages/SNES/SNESLineSearchGetParams.html#SNESLineSearchGetParams">SNESLineSearchGetParams</A>()</font>

<a name="line2552">2552: </a><font color="#B22222">M*/</font>
<a name="line2556">2556: </a><strong><font color="#4169E1"><a name="SNESCreate_VI"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A>  SNESCreate_VI(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes)</font></strong>
<a name="line2557">2557: </a>{
<a name="line2559">2559: </a>  SNES_VI        *vi;

<a name="line2562">2562: </a>  snes-&gt;ops-&gt;reset           = SNESReset_VI;
<a name="line2563">2563: </a>  snes-&gt;ops-&gt;setup           = SNESSetUp_VI;
<a name="line2564">2564: </a>  snes-&gt;ops-&gt;solve           = SNESSolveVI_RS;
<a name="line2565">2565: </a>  snes-&gt;ops-&gt;destroy         = SNESDestroy_VI;
<a name="line2566">2566: </a>  snes-&gt;ops-&gt;setfromoptions  = SNESSetFromOptions_VI;
<a name="line2567">2567: </a>  snes-&gt;ops-&gt;view            = SNESView_VI;
<a name="line2568">2568: </a>  snes-&gt;ops-&gt;converged       = SNESDefaultConverged_VI;

<a name="line2570">2570: </a>  <A href="../../../../docs/manualpages/Sys/PetscNewLog.html#PetscNewLog">PetscNewLog</A>(snes,SNES_VI,&amp;vi);
<a name="line2571">2571: </a>  snes-&gt;data            = (void*)vi;
<a name="line2572">2572: </a>  vi-&gt;alpha             = 1.e-4;
<a name="line2573">2573: </a>  vi-&gt;maxstep           = 1.e8;
<a name="line2574">2574: </a>  vi-&gt;minlambda         = 1.e-12;
<a name="line2575">2575: </a>  vi-&gt;LineSearch        = SNESLineSearchCubic_VI;
<a name="line2576">2576: </a>  vi-&gt;lsP               = <A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>;
<a name="line2577">2577: </a>  vi-&gt;postcheckstep     = <A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>;
<a name="line2578">2578: </a>  vi-&gt;postcheck         = <A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>;
<a name="line2579">2579: </a>  vi-&gt;precheckstep      = <A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>;
<a name="line2580">2580: </a>  vi-&gt;precheck          = <A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>;
<a name="line2581">2581: </a>  vi-&gt;const_tol         =  2.2204460492503131e-16;
<a name="line2582">2582: </a>  vi-&gt;checkredundancy   = <A href="../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>;

<a name="line2584">2584: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectComposeFunctionDynamic.html#PetscObjectComposeFunctionDynamic">PetscObjectComposeFunctionDynamic</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes,<font color="#666666">"SNESLineSearchSetMonitor_C"</font>,<font color="#666666">"SNESLineSearchSetMonitor_VI"</font>,SNESLineSearchSetMonitor_VI);
<a name="line2585">2585: </a>  <A href="../../../../docs/manualpages/Sys/PetscObjectComposeFunctionDynamic.html#PetscObjectComposeFunctionDynamic">PetscObjectComposeFunctionDynamic</A>((<A href="../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)snes,<font color="#666666">"SNESLineSearchSet_C"</font>,<font color="#666666">"SNESLineSearchSet_VI"</font>,SNESLineSearchSet_VI);

<a name="line2587">2587: </a>  <font color="#4169E1">return</font>(0);
<a name="line2588">2588: </a>}

<a name="line2593">2593: </a><font color="#B22222">/*</font>
<a name="line2594">2594: </a><font color="#B22222">   SNESVIGetInactiveSet - Gets the global indices for the inactive set variables (these correspond to the degrees of freedom the linear</font>
<a name="line2595">2595: </a><font color="#B22222">     system is solved on)</font>

<a name="line2597">2597: </a><font color="#B22222">   Input parameter</font>
<a name="line2598">2598: </a><font color="#B22222">.  snes - the <A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> context</font>

<a name="line2600">2600: </a><font color="#B22222">   Output parameter</font>
<a name="line2601">2601: </a><font color="#B22222">.  ISact - active set index set</font>

<a name="line2603">2603: </a><font color="#B22222"> */</font>
<a name="line2604">2604: </a><strong><font color="#4169E1"><a name="SNESVIGetInactiveSet"></a><A href="../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> SNESVIGetInactiveSet(<A href="../../../../docs/manualpages/SNES/SNES.html#SNES">SNES</A> snes,<A href="../../../../docs/manualpages/IS/IS.html#IS">IS</A>* inact)</font></strong>
<a name="line2605">2605: </a>{
<a name="line2606">2606: </a>  SNES_VI          *vi = (SNES_VI*)snes-&gt;data;
<a name="line2608">2608: </a>  *inact = vi-&gt;IS_inact_prev;
<a name="line2609">2609: </a>  <font color="#4169E1">return</font>(0);
<a name="line2610">2610: </a>}
</pre>
</body>

</html>
